external function string 255 UpdateOfficialSerNrSerie(Integer,Integer,Integer,string,boolean);
external function integer CheckAddressForLocalisation(string,string,string,string,string,string,string,string,string,string,string,var string);
external function Boolean StockRecordForLocationAllowed(string,string,string,date,integer,var Integer,var string);
external function Boolean IsPostcodeFormatCorrect(string);
external function Boolean HasModNL();
external function Boolean GetCustAndBal(var record CUVc,var val,var val,Integer,Integer,Integer,Integer,Integer,Integer,var Boolean);
external function Integer CheckSerialatPositionInItemHist(string,string,string,string,val);
external procedure VerifyRowObjects(String,String,String,String,var Integer,var String,var Boolean,Array string,Array string,var Integer);
external function val DivRateToBase1(string,val,val,val,val,val,val,roundmode);
external procedure GetBaseCurncy(Integer,var string);
external updating procedure FindAcptRulesAndCreateAcceptanceAlert2(Integer,Integer,string,string,string,val,val,string,string,string,string);
external function Boolean AcceptanceActivityExists(Integer,string,string,string);
external updating procedure CancelApprovalRequestActivities(Integer,string,string,string);
external function Integer VerifyTaxTemplateCode(string,var string);
external function Boolean TestNextOfficialSerialNr_ORVc(row LegalInvNrBlock,string,record ORVc,Boolean);
external function Boolean ValidateOfficialSerialNrChronology(string,string,LongInt,Date,var Date);
external procedure GetLegalInvNrRow(string,var row LegalInvNrBlock);
external function Integer IsUnOKAllowed_ORVc(record ORVc);
external function Integer GetVATLaw();
external updating procedure DeleteOffSerNr(LongInt,string);
external updating procedure UpdateOffSerNr(LongInt,string,Integer,string,Boolean);
external procedure FindNextORVcOfficialSerialNr(var record ORVc);
external function Integer VerifySalesmen(string,var string);
external function Boolean AcceptanceRulesExists(Integer,string);
external function Boolean UseTaxTemplatesforTaxCalc();
external function string 255 FillupTaxMatrix(Integer,string,string,string,string,string,var record TaxMatrixVc);
external function Integer SetAcceptanceStatus(Integer,string,val);
external updating function Boolean BA_ORMinMarkupWarning(record ORVc,var Integer);
external function Boolean ReadFirstItemInclClosed(string,var record INVc,Boolean,Boolean);
external function Boolean ValidEInvoiceData_OR(record ORVc,record CUVc,var Integer,var string);
external procedure CalcPrice(val,val,val,var val,Integer);
external function Boolean AllowedToTakeFromThisLoc(record LocationVc);
external function Boolean IsVATCodeDefined(string);
external function Boolean VATAccIsClosed(string,var string,Integer);
external updating procedure SMSWhenOR(record ORVc,Integer);
external function val GetORRowReserv(LongInt,string,string,var val,var string,var string,Boolean);
external updating procedure UpdateStockResFromOR(record ORVc);
external function string 255 FindINObjects(string,string);
external procedure ORDchsum(var record ORVc,Integer);
external function Integer CheckRates(string,val,val,val,val,val,var string);
external updating procedure UpdateVARItemsOR(record ORVc);
external function Boolean CheckPDExists(string);
external function Boolean IsRecipeClosed(string);
external procedure FindStockValue(string,string,var record ItemStatusVc);
external procedure RecalculateWeightORVc(var record ORVc,Boolean);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function Boolean ReadFirstItem(string,var record INVc,Boolean,Boolean);
external procedure FindSalesExVat(record TaxMatrixVc,string,val,Integer,Integer,var val);
external procedure CalcSum(val,val,val,val,var val,Integer);
external function Boolean GetItemPriceDiscount3(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string);
external function Boolean GetFirstItem(var string,var record INVc);
external updating procedure CreateActFromOR(record ORVc);
external procedure ORSumup(var record ORVc);
external updating procedure MakeActFromSubSys_ORVc(var record ORVc,Boolean,Boolean);
external function Boolean IsSerialNrCorrect(string);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure GetCurUser(var record UserVc);
external procedure ExtractObj(string,var Integer,var string);
external procedure SetORFlags(record ORVc);
external updating procedure UpdateORPlanned(record ORVc,string,Boolean);
external updating procedure UpdateInstock(string,string,string,string,date,val,val,val,val,val,val,val,val,val);
external function Boolean ExpandStructItem(string,string,val,var record SHVc);
external function Boolean CorrectM4ValProc(val);
external function Boolean AllowThisItem(string,string,string,Integer);
external function Integer CheckSerialStatus(string,string,var string);
external function Boolean CheckAllowedSize(record INVc,val,val,val);
external procedure ConvertSalesAcc(var string,Integer);
external function Integer CheckVATNrMask(string,string,Integer,var string);
external function Boolean GetPD(var record PDVc);
external function Integer CheckObjs(string,string,var string);
external function Boolean Date2Test(string,Date,string,Integer);
external function Boolean SerNrTestORVc(LongInt,Date,var Boolean);
external function LongInt GetCurUserLastNr(string);
external function Boolean GetCustAndBal(var record CUVc,var val,var val,Integer,Integer,Integer,Integer,Integer,Integer,var Boolean);
external function Boolean ORCheckForSalesmanPrice(record ORVc,Integer,string,string,var string);
external function Boolean INVc_AllowSales(record INVc,var LongInt);
external function string 30 GetCustomOfficialSerNr(); //Edit***************************Sasha2,11:42 08.01.2015
external function Boolean GetForeignCurncyRate(string,var val,var val,var val,Date,var Date);//Edit---------------------Dima 29.01.2015
//external updating function boolean NPCreateCounterparty(record NPCounterpartyVc);	//Edit----------------------Dima  15.04.2015
//external updating procedure GetRecipientContactPerson(string ,string );
external function Boolean IsLetter(string);
external procedure TableSortOR2(var record ORVc);//Edit----------------------Dima  07.07.2015
external updating function boolean NPDeleteCounterparty(record NPCounterpartyVc);
remote updating function boolean CheckCounterparty(var record ORVc);
external function LongInt DateDiff(Date,Date); //Edit***************************Sasha2,11:26 18.08.2015
external updating function longint AddSMStoStack(string, string, string,string,string,longint,string,date,time);//Edit----------------------Dima  28.08.2015
external function string 255 ParseSMStext(string, record ORVc);
external updating function string 255  CheckAndSendSMS(longint);
external procedure GetAvailableItems(var record ORVc);
external updating procedure AddPaymentToIPFromSH(record SHVc);
external updating function Integer RecordAction_raPasteOrdInInv(var record IVVc,LongInt,Boolean,var Integer);	//Edit----------------------Dima  14.12.2015
external updating function Integer RecordAction_raPasteOrdInShip(var record SHVc,LongInt,var string);					//Edit----------------------Dima  14.12.2015
external function LongInt HoursDiffWithoutRestDays(Date,Time,Date,Time);
external procedure IVVc_PasteInvDate(var record IVVc,record LocalMachineBlock,var Integer,var Integer);//Edit----------------------Dima  06.01.2016
external procedure CalcCustBalrem(var record ORVc);
external procedure SOAPUpdateStatus(string,string);// Edit ************************** Friday, 18 November 2016 09:42:09
external function string 255 LookUpPromotionCode(date,string); //Edit***************************Sasha2,15:31 24.01.2017
external procedure NoDupObjs(string,var string); //Edit***************************Sasha2,16:04 24.01.2017

global
updating procedure CreateORHistoryVcFromORVc(record ORVc ORr, record ORVc OR2r, boolean UpdateFlag)
begin
  record ORHistoryVc ORHr;
  
  if (UpdateFlag) then begin
    if((OR2r.CustomStatusFlag!=ORr.CustomStatusFlag) or (OR2r.SalesMan!=ORr.SalesMan) or 
    (OR2r.Sum4!=ORr.Sum4) or (OR2r.FeedBackStatus!=ORr.FeedBackStatus) or
    (OR2r.PrepaymentReceived!=ORr.PrepaymentReceived) or (OR2r.Reserved!=ORr.Reserved) or
    (OR2r.OKFlag!=ORr.OKFlag)) then begin
      RecordNew(ORHr);
      ORHr.ORNr = ORr.SerNr;
      ORHr.Date = CurrentDate;
      ORHr.Time = CurrentTime;
      ORHr.CustomStatusFlag = ORr.CustomStatusFlag;
      ORHr.SalesMan = ORr.SalesMan;
      ORHr.Sum4 = ORr.Sum4;
      ORHr.rwcnt = MatRowCnt(ORr);
      ORHr.FeedBackStatus = ORr.FeedBackStatus;
      ORHr.PrepaymentReceived = ORr.PrepaymentReceived;
      ORHr.Reserved = ORr.Reserved;
      ORHr.OKFlag = ORr.OKFlag;
      ORHr.SerNr = NextSerNr("ORHistoryVc",ORHr.Date,-1,false,"");
      RecordStore(ORHr,true);
    end;
  end else begin
    RecordNew(ORHr);
    ORHr.ORNr = ORr.SerNr;
    ORHr.Date = CurrentDate;
    ORHr.Time = CurrentTime;
    ORHr.CustomStatusFlag = ORr.CustomStatusFlag;
    ORHr.SalesMan = ORr.SalesMan;
    ORHr.Sum4 = ORr.Sum4;
    ORHr.rwcnt = MatRowCnt(ORr);
    ORHr.FeedBackStatus = ORr.FeedBackStatus;
    ORHr.PrepaymentReceived = ORr.PrepaymentReceived;
    ORHr.Reserved = ORr.Reserved;
    ORHr.OKFlag = ORr.OKFlag;
    ORHr.SerNr = NextSerNr("ORHistoryVc",ORHr.Date,-1,false,"");
    RecordStore(ORHr,true);
  end;
end;


global //Edit***************************Sasha2,9:51 25.01.2017 {
procedure HandlePromotionObjectsIV(var record ORVc ORr,record ORVc OR2r,LongInt mode)
begin
  record PromotionVc Promotionr;
  string 255 tstr,objStr;
  integer pos;
    
    if (mode==Rs_insert) then begin
      if (NonBlank(ORr.PromotionCode)) then begin
        Promotionr.Code = ORr.PromotionCode;
        if (ReadFirstMain(Promotionr,1,true) and NonBlank(Promotionr.Objects)) then begin
          if (Blank(ORr.Objects)) then begin
            ORr.Objects = Promotionr.Objects;
          end else begin
            ORr.Objects = ORr.Objects & "," & Promotionr.Objects;
          end;
        end;
      end;
    end;
    if (mode==Rs_update) then begin
      if (ORr.PromotionCode!=OR2r.PromotionCode) then begin
        if (NonBlank(OR2r.PromotionCode)) then begin
          Promotionr.Code = OR2r.PromotionCode;
          if (ReadFirstMain(Promotionr,1,true) and NonBlank(Promotionr.Objects)) then begin
            NoDupObjs(OR2r.Objects & "," & ORr.Objects,tstr);
            OR2r.Objects = tstr;
            pos = 0;
            objStr = "";
            ExtractObj(OR2r.Objects,pos,tstr);
            while (nonblank(tstr)) begin
              if (SetInSet(tstr,Promotionr.Objects)==false) then begin
                objStr = objStr & tstr & ",";
              end;
              ExtractObj(OR2r.Objects,pos,tstr);
            end;
            if (NonBlank(objStr)) then begin
              objStr = Left(objStr,len(objStr)-1);
              ORr.Objects = objStr;
            end;
          end;
        end;
        if (NonBlank(ORr.PromotionCode)) then begin
          Promotionr.Code = ORr.PromotionCode;
          if (ReadFirstMain(Promotionr,1,true) and NonBlank(Promotionr.Objects)) then begin
            if (Blank(ORr.Objects)) then begin
              ORr.Objects = Promotionr.Objects;
            end else begin
              ORr.Objects = ORr.Objects & "," & Promotionr.Objects;
            end;
          end;
        end;
      end;
    end;
    
  return;
end; //Edit***************************Sasha2,9:51 25.01.2017 }

global procedure SetNewORCustomStatusFlagOnWeb(record ORVc ORr)
begin
	string 50 newstatus;
	
	switch(ORr.CustomStatusFlag)begin
		case 0:newstatus = "pending";//Новый
		case 1:newstatus = "processing";//Открыт
		case 2:newstatus = "approved";//Подтвержден
		case 3:newstatus = "nocall";//Не дозвонились
		case 4:newstatus = "changed";//Заказ изменен
		case 5:newstatus = "vsborke";//В сборке
		case 6:newstatus = "sobran";//Собран
		case 7:newstatus = "otpravlen";//Отправлен
		case 8:newstatus = "dostavlen";//Доставлен
		case 9:newstatus = "complete";//Завершен
		case 10:newstatus = "canceled";//Отменен
		case 11:newstatus = "pending_payment";//В ожидании опл.
		case 12:newstatus = "pending_stock";//В ожидании товаров
		case 13:newstatus = "no_stock";//Не достаточно тов-в
	end;
	if(nonblank(newstatus))then begin
		if(ORr.OrderClass=="WEB" and nonblank(ORr.CustOrdNr))then begin
			SOAPUpdateStatus(ORr.CustOrdNr,newstatus);
		end;
	end;
	
return;
end;

procedure SetORAcceptanceFlag(var record ORVc ORr,record ORVc prevORr,LongInt stat)
begin
  val bc1v;
  Boolean testf;
  
  testf = true;
  switch (stat) begin
    case Rs_update:
      if (prevORr.OKFlag!=0) then begin
        testf = false;
      end;
    otherwise
      ;
  end;
  if (testf) then begin
    switch (ORr.AcceptanceStatus) begin
      case kAcceptanceStatePending:
      case kAcceptanceStateApproved:
      case kAcceptanceStateRejected:
      otherwise
        bc1v = MulRateToBase1(ORr.CurncyCode,ORr.Sum4,ORr.FrRate,ORr.ToRateB1,ORr.ToRateB2,ORr.BaseRate1,ORr.BaseRate2,DefaultCurRoundOff);
        ORr.AcceptanceStatus = SetAcceptanceStatus(kAcceptanceOR,ORr.CustCode,bc1v);      
    end;
  end;
  return;
end;

function Boolean CheckOrderQtys(row ORVc ORrwp,Integer rownr,record ORVc oldORp)
begin
  Boolean res;
  row ORVc oldORrw;
    
  res = true;
  if (rownr<=MatRowCnt(oldORp)) then begin
    MatRowGet(oldORp,rownr,oldORrw);
    if (oldORrw.Quant>=oldORrw.Shipd1) then begin
      if (ORrwp.Quant<oldORrw.Shipd1) then begin
        res = false;
      end;
    end;
  end;  
  CheckOrderQtys = res;
  return;
end;

global
function Integer PayTermType(string paydeal)
begin
  Integer res;
  record PDVc PDr;
  Integer i,mrwcnt;
  record PMBlock PMRec;
  row PMBlock pmrw;
  
  res = 1;
  PDr.Code = paydeal;
  if (blank(paydeal)) then begin
    if (GetPD(PDr)) then begin end;
    res = PDr.PDType;
    goto LPayTermType;
  end;
  if (GetPD(PDr)) then begin
    res = PDr.PDType;
    goto LPayTermType;
  end;

  BlockLoad(PMRec);
  mrwcnt = MatRowCnt(PMRec);
  for (i=0;i<mrwcnt;i=i+1) begin
    MatRowGet(PMRec,i,pmrw);
    if (pmrw.Code==paydeal) then begin 
      res = 2;
      goto LPayTermType;
    end;
  end;
LPayTermType:;
  PayTermType = res;
  return;
end;

function Boolean ValidOrderDataForVATLaw_Portuguese(record ORVc ORr,record CUVc CUr,var Integer errcode,var string gotofield)
begin
  Boolean res;
  val rval,rvalb1;
  Boolean testf;
  record CountryVc Countryr;
  
  res = true;
  if (blank(ORr.VATNr)) then begin
    errcode = 20275;
    gotofield = "VATNr";
    res = false;
    goto LValidOrderDataForVATLaw_Portuguese;
  end;
  
  testf = true;
  if (ORr.VATNr=="999999990") then begin testf = false; end;
  if (CUr.CustType==1) then begin
    if (ORr.Sum1<=1000) then begin
      if (blank(ORr.Addr1) and blank(ORr.Addr2) and blank(ORr.Addr3) and blank(ORr.InvAddr3) and blank(ORr.InvAddr4)) then begin
        testf = false;
      end;
    end;
  end;
  if (testf) then begin
    testf = false;
    if (blank(ORr.Addr1) and blank(ORr.Addr2)) then begin
      gotofield = "Addr1";
      testf = true;
    end;
    if (blank(ORr.Addr3)) then begin
      gotofield = "Addr3";
      testf = true;
    end;
    if (blank(ORr.InvAddr3)) then begin
      gotofield = "InvAddr3";
      testf = true;
    end;
    if (blank(ORr.InvAddr4)) then begin
      gotofield = "InvAddr4";
      testf = true;
    end;
    if (testf) then begin
      errcode = 20276;
      res = false;
      goto LValidOrderDataForVATLaw_Portuguese;
    end;
  end;
  if (nonblank(ORr.InvAddr4)) then begin
    Countryr.Comment = ORr.InvAddr4;
    if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
      errcode = 20277;
      res = false;
      gotofield = "InvAddr4";
      goto LValidOrderDataForVATLaw_Portuguese;
    end;
  end;
  if (blank(ORr.InvAddr4)) or (ORr.InvAddr4=="Portugal") then begin
    if (nonblank(ORr.Addr3)) then begin
      if (IsPostcodeFormatCorrect(ORr.Addr3)==false) then begin
        errcode = 24620;
        res = false;
        gotofield = "Addr3";
        goto LValidOrderDataForVATLaw_Portuguese;
      end;
    end;
  end;

  if (ORr.VATNr!="999999990") then begin
    if (nonblank(ORr.ShipAddr1) or nonblank(ORr.ShipAddr2) or nonblank(ORr.DelAddr3) or nonblank(ORr.DelAddr4)) then begin
      testf = false;
      if (blank(ORr.ShipAddr1) and blank(ORr.ShipAddr2)) then begin
        gotofield = "ShipAddr1";
        testf = true;
      end;
      if (blank(ORr.ShipAddr3)) then begin
        gotofield = "ShipAddr3";
        testf = true;
      end;
      if (blank(ORr.DelAddr3)) then begin
        gotofield = "DelAddr3";
        testf = true;
      end;
      if (blank(ORr.DelAddr4)) then begin
        gotofield = "DelAddr4";
        testf = true;
      end;
      if (testf) then begin
        errcode = 20276;
        res = false;
        goto LValidOrderDataForVATLaw_Portuguese;
      end;
    end;
  end;

  if (nonblank(ORr.DelAddr4)) then begin
    Countryr.Comment = ORr.DelAddr4;
    if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
      errcode = 20277;
      res = false;
      gotofield = "DelAddr4";
      goto LValidOrderDataForVATLaw_Portuguese;
    end;
  end;
  if (blank(ORr.DelAddr4)) or (ORr.DelAddr4=="Portugal") then begin
    if (nonblank(ORr.ShipAddr3)) then begin
      if (IsPostcodeFormatCorrect(ORr.ShipAddr3)==false) then begin
        errcode = 24620;
        res = false;
        gotofield = "ShipAddr3";
        goto LValidOrderDataForVATLaw_Portuguese;
      end;
    end;
  end;
  
LValidOrderDataForVATLaw_Portuguese:;  
  ValidOrderDataForVATLaw_Portuguese = res;
  return;
end;

global
function Boolean ValidOrderDataForVATLaw(record ORVc ORr,record CUVc CUr,var Integer errcode,var string gotofield)
begin
  Boolean res;
  
  res = true;
  switch (GetVATLaw) begin
    case vatPortuguese:
      res = ValidOrderDataForVATLaw_Portuguese(ORr,CUr,errcode,gotofield);
  end;
LValidOrderDataForVATLaw:;  
  ValidOrderDataForVATLaw = res;
  return;
end;

function Boolean SOHasOpenDwnPayInvoices(record ORVc ORp,var val TotDownPaymentval)
begin
  record ARVc ARr;
  record IVVc IVr;
  record CUVc CUr;
  Boolean TrHs;
  val fr,to1,to2,br1,br2;
  val rval,rval2;
  string 10 basecur1;  
  Boolean res;
  
  res = false;
  GetBaseCurncy(1,basecur1);
  TotDownPaymentval = blankval;
  ARr.InvoiceNr = 0;
  ARr.CustCode = ORp.CustCode;
  TrHs = true;
  while (LoopKey("CustCode",ARr,2,TrHs)) begin
    IVr.SerNr = ARr.InvoiceNr;
    if (ReadFirstMain(IVr,1,true)) then begin end;
    if ((IVr.InvType==kInvoiceTypeDownpayment) and (IVr.OrderNr==ORp.SerNr)) then begin
      CUr.Code = IVr.CustCode;
      if (ReadFirstMain(CUr,1,true)) then begin
      end; 
      res = true;
      GetFullCurncyRate(CUr.CurncyCode,CurrentDate,fr,to1,to2,br1,br2);
      if (IVr.CurncyCode==CUr.CurncyCode) then begin
        rval = ARr.RVal;
      end else begin
        if (blank(CUr.CurncyCode)) or (CUr.CurncyCode==basecur1) then begin
          rval = ARr.RVal;
        end else begin
          rval = DivRateToBase1(CUr.CurncyCode,ARr.BookRVal,fr,to1,to2,br1,br2,DefaultCurRoundOff);
        end;
      end;      
      TotDownPaymentval = TotDownPaymentval + rval;
    end;
  end;
SOHasOpenDwnPayInvoices = res;
  return;
end;

global
updating function LongInt ORVcRecordCheck(record ORVc ORr,record ORVc OR2r,LongInt stat,LongInt check)
begin
  LongInt res;
  Integer insertmode,updatemode;
  record CreditLimitBlock CreditLimitRec;
  record AccBlock ARAccRec;
  record SRBlock SRRec;
  record AccVc Accr;
  record ORVc lORr;
  record CUVc CUr;
  record INVc INr;
  record PRVc PRr;
  record ItemStatusVc ISr;
  record MainStockBlock MSb;  
  row ORVc ORrw;
  row ORVc OR2rw;
  Integer i,j,rwcnt,errcode;
  LongInt oldnr,ErrorCode;
  LongInt newnr;
  val bal;
  val limit,rsrvd;
  string 255 tstr,errstr;
  Boolean gentrans,transf,unokf,testf,test2f;
  record OrdSettBlock OSb;
  string 20 location,oldOfficialSerNr;
  val orsrv,orsrved;
  record OrderClassVc OrderClassr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  record LocationVc Locationr;
  record ModuleBlock OptRec;
  record PlanDeliveryBlock PDb;
  val ordqty;
  string 60 comment;
  record UserVc User;
  Boolean closingf;
  record TaxTemplateVc TTr;
  record LegalInvNrBlock LINrb;
  row LegalInvNrBlock LINrbrw;
  Date td;
  Boolean limitdaysf;
  record POVc POr;
  val TotDownPaymentval;
  Array string 255 otcheckaccs;
  Array string 255 otcheckobjtyps;
  Integer otcheckcnt;
  record OTCheckBlock OTCheckr;
  Boolean initotcheckf;  
  record CUUserLabelBlock CUUerLb;
  record CountryVc Countryr;
  record NPCityVc NPCityr;
  record NPWarehouseVc NPWarehouser;
  string 80 tmpStr, resStr;
  string 20 char, nextChar;
  integer nameLen;
  boolean ifBegin;
  record PLVc PLr;

  res = 0;
  insertmode = 1;//Rs_insert
  updatemode = 2;//Rs_update
  if (ORr.OKFlag!=0 and ORr.Reserved!=0) then begin //Edit***************************Sasha2,11:24 18.08.2015 {
    if (blankdate(ORr.ReservToDate)) then begin
      //ORr.ReservToDate = AddDay(ORr.OrdDate,3);
    end else begin
      if (DateDiff(ORr.ReservToDate,ORr.OrdDate)>31) then begin
        RecordCheckError(32702,". " & UsetStr(14642) & "31 " & LowerCase(UsetStr(9640)),-1,"ReservToDate");      
        res = -1;
        goto LORVcRecordCheck;
      end;
      if (ORr.ReservToDate<ORr.OrdDate) then begin
        RecordCheckError(32702,"",-1,"ReservToDate");      
        res = -1;
        goto LORVcRecordCheck; 
      end;
    end;
  end; //Edit***************************Sasha2,11:24 18.08.2015 }
  
  if(ORr.FeedBackStatus==3 and ORr.FeedBackStatus > OR2r.FeedBackStatus) then begin	//Edit----------------------Dima  31.08.2015
  	ORr.CustomStatusFlag = 10;
		ORr.Closed = 1;
		ORr.Addr0 = USetStr(31112) & ORr.Addr0;
	end;
	
	//if (ORr.CustomStatusFlag==10 and OR2r.CustomStatusFlag!=10) then begin		//Edit----------------------Dima  07.10.2015
	//ORr.Reserved = 0;
	//end;	   
  
  if (ORr.OKFlag==0) then begin
    if (stat==updatemode) then begin
      if (OR2r.OKFlag==1) then begin unokf = true; end;
    end;
  end;
  if (unokf) then begin
    errcode = IsUnOKAllowed_ORVc(ORr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,"",-1,"OrdDate");      
      res = -1; 
    end;
    goto LORVcRecordCheck;
  end;

  if (stat==updatemode) then begin
    if (ORr.SerNr<=0) then begin
      ORr.SerNr = OR2r.SerNr;
    end;
  end; 
  if (ORr.Closed!=0) then begin
    if (stat==updatemode) then begin
      if (OR2r.Closed==0) then begin 
        if (SOHasOpenDwnPayInvoices(ORr,TotDownPaymentval)) then begin 
          RecordCheckError(29090," " & TotDownPaymentval,-1,"CustCode");      
          res = -1;
          goto LORVcRecordCheck;            
        end else begin
          closingf = true;
        end;
      end;
    end;
  end;
  User.Code = CurrentUser;
  if ReadFirstMain(User,1,true) then begin 
  end;
  BlockLoad(ARAccRec);
  BlockLoad(SRRec);
  BlockLoad(MSb);
  BlockLoad(OSb);
  BlockLoad(OptRec);
  BlockLoad(PDb);
  oldnr = ORr.SerNr;
  oldOfficialSerNr = ORr.OfficialSerNr;
  BlockLoad(CreditLimitRec);
  if ((CreditLimitRec.ORSave==1) or (CreditLimitRec.ORSaveWarn==1)) then begin
    CUr.Code = ORr.CustCode;
    if (GetCustAndBal(CUr,limit,bal,CreditLimitRec.Base,CreditLimitRec.OwnCheques,CreditLimitRec.ThirdCheques,CreditLimitRec.IOUCheques,CreditLimitRec.ThirdIOUCheques,CreditLimitRec.ORSaveWarn,limitdaysf)) then begin
      if (limitdaysf) then begin
        if (CreditLimitRec.ORSave==1) then begin    
          RecordCheckError(22260,"",-1,"CustCode");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
      if (blank(limit)==false) then begin 
        if (stat==updatemode) then begin
          switch (CreditLimitRec.Base) begin
            case 0: bal = bal - OR2r.Sum4;
            case 1: ;//nothing
            case 2: bal = bal - OR2r.Sum4;
          end;
        end;
        switch (CreditLimitRec.Base) begin
          case 0: bal = bal + ORr.Sum4;
          case 1: ;//nothing
          case 2: bal = bal + ORr.Sum4;
        end;
        if (bal>limit) then begin
          if (CreditLimitRec.ORSave==1) then begin
            RecordCheckError(1164,"",-1,"CustCode");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if (CreditLimitRec.ORSaveWarn==1) then begin
            MessageBox(1164,"");
          end;
        end;
      end;
    end;
  end;
  if (RecordValid(OR2r)) then begin
    if (ORr.OKFlag==1) and (OR2r.OKFlag<>1) then begin
      if (UserCanAction("OROK",true)==false) then begin
        RecordCheckError(1274,StringFromStringSet(3,"OROK"),-1,"SerNr");      
        res = -1;
        goto LORVcRecordCheck;
      end;  
    end;
    if (OR2r.OKFlag!=0) and (ORr.OKFlag!=1)  then begin
      if (UserCanAction("UnOKOR",true)==false) and (UserCanAction("UnOKAll",true)==false) then begin
        RecordCheckError(1274,StringFromStringSet(3,"UnOKOR"),-1,"SerNr");      
        res = -1;
        goto LORVcRecordCheck;
      end;
    end;  
  end;
  
  if(blankdate(ORr.DebtUpdateDate) and nonblank(ORr.CustCode))then begin
  	CalcCustBalrem(ORr);// Edit ************************** Friday, 22 July 2016 11:20:19
  end;
  
  if (blank(ORr.CustCode)) then begin
    RecordCheckError(1058,"",-1,"CustCode");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  if (blank(ORr.OfficialSerNr)) then begin
    ORr.OfficialSerNr = GetCustomOfficialSerNr; //Edit***************************Sasha2,11:44 08.01.2015
  end;
  if (blank(ORr.OfficialSerNr)) then begin	//Edit by Victor 08.01.15
    RecordCheckError(1058,"",-1,"OfficialSerNr");      
    res = -1; 
    goto LORVcRecordCheck; 
  end;
  
  CUr.Code = ORr.CustCode;
  if (ReadFirstMain(CUr,1,true)==false) then begin
    RecordCheckError(1120,ORr.CustCode,-1,"CustCode");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  
  // Edit Start ---------------------------------------------- Edit Start
	//Friday, 14 August 2015 11:00:32
	
  if(stat==updatemode)then begin
  	if(ORr.CustomStatusFlag!=OR2r.CustomStatusFlag)then begin
  		if(Nonblank(CUr.WarnText1))then begin
  			messagebox(0,CUr.WarnText1);
  		end;
  	end;
  end;
  
	// Edit End ---------------------------------------------- Edit End
	
  if (CUr.CUType==0) then begin
    RecordCheckError(1120,ORr.CustCode,-1,"CustCode");      
    res = -1; 
    goto LORVcRecordCheck;
  end;
  if (CUr.blockedFlag!=0) then begin
    RecordCheckError(1265,ORr.CustCode,-1,"CustCode");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  if (CheckPDExists(ORr.PayDeal)==false) then begin
    RecordCheckError(1256,"",-1,"PayDeal");      
    res = -1;
    goto LORVcRecordCheck;        
  end;
  switch (stat) begin
    case Rs_update:
      if (ORr.OKFlag!=0) and (OR2r.OKFlag==0) then begin
        ORr.RegDate = CurrentDate;
        ORr.RegTime = CurrentTime;
      end;
    otherwise
      if (ORr.OKFlag!=0) then begin
        ORr.RegDate = CurrentDate;
        ORr.RegTime = CurrentTime;
      end;
  end;
  
  if(blank(CUr.InvAddr0)) then begin
  	messagebox(31062, "");
  end;

  BlockLoad(LINrb);  		
  /*if (nonblank(ORr.OfficialSerNr)) then begin		// Comment by Victor 08.01.15 *****
    GetLegalInvNrRow(ORr.OfficialSerNr,LINrbrw);
    switch (LINrbrw.SelectionType) begin
      case kLegalInvNrSelectionTypeManual:
        if (blank(LINrbrw.Serie)) then begin
          ORr.OfficialSerNr = "";
        end;
      case kLegalInvNrSelectionTypeAtOK:
        if (transf) then begin
          ORr.OfficialSerNr = "";
        end;
      case kLegalInvNrSelectionTypeAtInsert:
        if (blank(LINrbrw.Serie)) or (stat==Rs_insert) then begin
          ORr.OfficialSerNr = "";
        end;
    end;
  end;*/	// *****
  if (blank(ORr.OfficialSerNr)) then begin
    FindNextORVcOfficialSerialNr(ORr);
  end;
  if (ValidateOfficialSerialNrChronology("ORVc",ORr.OfficialSerNr,ORr.SerNr,ORr.OrdDate,td)==false) then begin
    RecordCheckError(26201," " & td,-1,"OrdDate");  
    res = -1;
    goto LORVcRecordCheck;
  end;  
  if (nonblank(ORr.OfficialSerNr)) and (MatRowCnt(LINrb)>0) then begin    
    errcode = 0;
    rwcnt = MatRowCnt(LINrb);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(LINrb,i,LINrbrw);
      test2f = true;
      if (Left(ORr.OfficialSerNr,len(LINrbrw.Serie))!=LINrbrw.Serie) then begin test2f = false; end;
      if (test2f) then begin
        testf = true;
        test2f = TestNextOfficialSerialNr_ORVc(LINrbrw,CUr.Classification,ORr,false);
        if (test2f==false) then begin
          errcode = 1557;
          testf = false;
        end else begin
          i = rwcnt;
        end;
      end;
    end;
    if (testf==false) then begin
      RecordCheckError(errcode," " & ORr.OfficialSerNr,-1,"OfficialSerNr");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;

   
  if (nonblank(ORr.PRCode)) then begin
    PRr.Code = ORr.PRCode;
    if (ReadFirstMain(PRr,1,true)) then begin
      if (ORr.CustCode!=PRr.CustCode) then begin
        RecordCheckError(1218,"",-1,"PRCode");      
        res = -1;
        goto LORVcRecordCheck;
      end;
      if (nonblank(PRr.CurncyCode)) then begin
        if (ORr.CurncyCode!=PRr.CurncyCode) then begin
          RecordCheckError(20573,"",-1,"PRCode");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
    end else begin
      RecordCheckError(1232,"",-1,"PRCode");      
      res = -1;
      goto LORVcRecordCheck;
    end;    
    if (PRr.Terminated!=0) then begin
      RecordCheckError(1232,"",-1,"PRCode");      
      res = -1;
      goto LORVcRecordCheck;
    end;        
  end;   
  if (ORr.SerNr<=0) then begin
    newnr = GetCurUserLastNr("ORVc");
    if (newnr==-1) then begin
      newnr = SRRec.LastOrdNr;
    end;
    ORr.SerNr = NextSerNr("ORVc",ORr.OrdDate,newnr,false,"");
  end;
  if ((stat==insertmode) or (ORr.SerNr!=OR2r.SerNr)) then begin
    lORr.SerNr = ORr.SerNr;
    if (ReadFirstMain(lORr,1,true)) then begin
      RecordCheckError(1547,"",-1,"SerNr");      
      res = -1;
      goto LORVcRecordCheck;
    end;
    if (SerNrTestORVc(ORr.SerNr,ORr.OrdDate,gentrans)==false) then begin
      RecordCheckError(1557,"",-1,"SerNr");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  if (Date2Test("ORVc",ORr.OrdDate,"OrdDate",-1)==false) then begin
    res = -1;
    goto LORVcRecordCheck;
  end;
  if ((stat==insertmode) or ((stat==updatemode) and (OR2r.OKFlag==0))) then begin
//    if (ORr.OKFlag==1) then begin
      if (BA_ORMinMarkupWarning(ORr,i)) then begin
        if (UserCanAction("DisallowSaleBelowGP",false)) then begin
          RecordCheckError(22050,"",i,"Sum");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
//    end;
  end;
  if (OSb.ReqORClass==1) then begin
    if (blank(ORr.OrderClass)) then begin
      RecordCheckError(20101,"",-1,"OrderClass");
      res = -1;
      goto LORVcRecordCheck;  
    end;
  end;  
  if (OSb.RequireCustOrdNo!=0) then begin
    if (blank(ORr.CustOrdNr)) then begin
      RecordCheckError(2281,"",-1,"CustOrdNr");
      res = -1;
      goto LORVcRecordCheck;  
    end;
  end;  
  if (OSb.RequireDeliveryAddress!=0) then begin
    if (blank(ORr.ShipAddr0)) then begin
      RecordCheckError(1058,"",-1,"ShipAddr0");
      res = -1;
      goto LORVcRecordCheck;  
    end;
  end;  
  if (nonblank(ORr.OrderClass)) then begin
    OrderClassr.Code = ORr.OrderClass;
    if (ReadFirstMain(OrderClassr,1,true)==false) then begin
      RecordCheckError(1290,"",-1,"OrderClass");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  if (OrderClassr.TREOFlag!=0) then begin
    if (ORr.TREONr<=0) then begin
      RecordCheckError(27370,"",-1,"TREONr");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  if (nonblank(ORr.ShipMode)) then begin
    DMr.Code = ORr.ShipMode;
    if (ReadFirstMain(DMr,1,true)==false) then begin
      RecordCheckError(1290,"",-1,"ShipMode");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  if (nonblank(ORr.ShipDeal)) then begin
    ShipDealr.Code = ORr.ShipDeal;
    if (ReadFirstMain(ShipDealr,1,true)==false) then begin
      RecordCheckError(1290,"",-1,"ShipDeal");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  
  if (blank(ORr.Location)) then begin //Edit***************************Sasha2,13:53 28.10.2014 {
    RecordCheckError(1290,"",-1,"Location");      
    res = -1;
    goto LORVcRecordCheck;
  end; //Edit***************************Sasha2,13:53 28.10.2014 }
  
  if (nonblank(ORr.Location)) then begin
    Locationr.Code = ORr.Location;
    if (ReadFirstMain(Locationr,1,true)==false) then begin
      RecordCheckError(1290,"",-1,"Location");      
      res = -1;
      goto LORVcRecordCheck;
    end;
    if (AllowedToTakeFromThisLoc(Locationr)==false) then begin
      RecordCheckError(1768,"",-1,"Location");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  switch (stat) begin
    case Rs_update:
      if (OR2r.OrderType==kOrderTypeDropShip) then begin
        POr.OrdNr = ORr.SerNr;
        if (ReadFirstKey("OrdNr",POr,1,true)) then begin
          RecordCheckError(20848,"",-1,"OrderType");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
  end;
  errcode = CheckObjs("",ORr.Objects,errstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,errstr,-1,"Objects");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  if (PayTermType(ORr.PayDeal)==3) then begin
    RecordCheckError(1227,ORr.PayDeal,-1,"PayDeal");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  errcode = CheckVATNrMask(ORr.VATNr,CUr.CountryCode,CUr.CustType,tstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,tstr,-1,"VATNr");      
    res = -1;
    goto LORVcRecordCheck;
  end;
  if (nonblank(CUr.CurncyCode)) then begin
    if (CUr.CurncyCode!=ORr.CurncyCode) then begin
      RecordCheckError(1217,"",-1,"CurncyCode");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;      
  if (nonblank(ORr.SalesMan)) then begin    
    errcode = VerifySalesmen(ORr.SalesMan,tstr);
    if (errcode!=0) then begin
      RecordCheckError(errcode,": " & tstr,-1,"SalesMan");   
      res = -1; 
      goto LORVcRecordCheck;
    end;
  end;
  errcode = CheckRates(ORr.CurncyCode,ORr.FrRate,ORr.ToRateB1,ORr.ToRateB2,ORr.BaseRate1,ORr.BaseRate2,tstr);
  if (errcode!=0) then begin
    RecordCheckError(errcode,"",-1,tstr);      
    res = -1; 
    goto LORVcRecordCheck;
  end;    
  if (HasLocalization("PRT")) then begin
    BlockLoad(CUUerLb);  
    tstr = "";
    switch (CUUerLb.CountryAddrLine) begin
      case kCountryAddrLineUserAddr0: tstr = ORr.Addr0; errstr = "Addr0";
      case kCountryAddrLineUserAddr1: tstr = ORr.Addr1; errstr = "Addr1";
      case kCountryAddrLineUserAddr2: tstr = ORr.Addr2; errstr = "Addr2";
      case kCountryAddrLineUserAddr3: tstr = ORr.InvAddr3; errstr = "InvAddr3";
      case kCountryAddrLineUserAddr4: tstr = ORr.InvAddr4; errstr = "InvAddr4";
    end;
    if (nonblank(tstr)) then begin
      Countryr.Comment = tstr;
      if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
        RecordCheckError(20277,tstr,-1,errstr);      
        res = -1;
        goto LORVcRecordCheck;
      end;
    end;
    if (blank(tstr)) or (tstr=="Portugal") then begin
      if (nonblank(ORr.Addr3)) then begin
        if (IsPostcodeFormatCorrect(ORr.Addr3)==false) then begin
          RecordCheckError(24620,tstr,-1,"Addr3");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
    end;
    
    tstr = "";
    switch (CUUerLb.CountryAddrLine) begin
      case kCountryAddrLineUserAddr0: tstr = ORr.ShipAddr0; errstr = "ShipAddr0";
      case kCountryAddrLineUserAddr1: tstr = ORr.ShipAddr1; errstr = "ShipAddr1";
      case kCountryAddrLineUserAddr2: tstr = ORr.ShipAddr2; errstr = "ShipAddr2";
      case kCountryAddrLineUserAddr3: tstr = ORr.DelAddr3; errstr = "DelAddr3";
      case kCountryAddrLineUserAddr4: tstr = ORr.DelAddr4; errstr = "DelAddr4";
    end;
    if (nonblank(tstr)) then begin
      Countryr.Comment = tstr;
      if (ReadFirstKey("Comment",Countryr,1,true)==false) then begin
        RecordCheckError(20277,tstr,-1,errstr);      
        res = -1;
        goto LORVcRecordCheck;
      end;
    end;
    if (blank(tstr)) or (tstr=="Portugal") then begin
      if (nonblank(ORr.ShipAddr3)) then begin
        if (IsPostcodeFormatCorrect(ORr.ShipAddr3)==false) then begin
          RecordCheckError(24620,tstr,-1,"ShipAddr3");      
          res = -1;
          goto LORVcRecordCheck;
        end;
      end;
    end;
  end;
  if (HasLocalization("BRA")) then begin
    if ((CUr.CUType!=0 or CUr.VEType!=0) and (ORr.InvCountry=="1058" or blank(ORr.InvCountry))) then begin 
      errcode = CheckAddressForLocalisation("BRA",ORr.Addr1,"Addr1",ORr.Addr2,"Addr2",ORr.Addr3,"Addr3",ORr.InvAddr3,"InvAddr3",ORr.InvAddr4,"InvAddr4",tstr);
      if (errcode!=0) then begin 
        RecordCheckError(errcode,"",-1,tstr);
        res = -1;
        goto LORVcRecordCheck;      
      end;
    end;
  end;    
  if (ORr.OKFlag!=0 and OR2r.OKFlag==0) then begin
    if (ValidOrderDataForVATLaw(ORr,CUr,errcode,tstr)==false) then begin
      RecordCheckError(errcode,"",-1,tstr);      
      res = -1; 
      goto LORVcRecordCheck;
    end;   
  end;
  if (HasLocalization("PRT")) then begin 
    if (blank(ORr.OfficialSerNrSerie)) then begin 
      ORr.OfficialSerNrSerie = UpdateOfficialSerNrSerie(stat,ORr.OKFlag,OR2r.OKFlag,ORr.OfficialSerNr,true);
    end;
  end;
  transf = false;
  if (ORr.OKFlag==1) then begin
    if (stat==insertmode) then begin transf = true; end;
    if (stat==updatemode) then begin
      if (OR2r.OKFlag==0) then begin transf = true; end;
    end;
  end;
  if (transf) then begin
    if (GetVATLaw==vatPortuguese) then begin
      if (blank(ORr.OfficialSerNr)) then begin
        RecordCheckError(1058,"",-1,"OfficialSerNr");  
        res = -1;
        goto LORVcRecordCheck;
      end;
    end;
  end;
  /*if (ORr.ExportFlag==0) then begin
    if (UserCanAction("DisallowDomSales",false)) then begin
      RecordCheckError(20056,"",-1,"CustCode");   
      res = -1; 
      goto LORVcRecordCheck;
    end; 
  end;*/
  if (ORr.ExportFlag!=0) then begin
    if (UserCanAction("DisallowExpSales",false)) then begin
      RecordCheckError(20049,"",-1,"CustCode");   
      res = -1; 
      goto LORVcRecordCheck;
    end; 
  end;
  if (transf) then begin
    if (UserCanAction("OROK",true)==false) then begin
      RecordCheckError(1274,StringFromStringSet(3,"OROK"),-1,"SerNr");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;  
  if (ValidEInvoiceData_OR(ORr,CUr,errcode,tstr)==false) then begin
    RecordCheckError(errcode,"",-1,tstr);      
    res = -1; 
    goto LORVcRecordCheck;
  end;
  if (transf) then begin
    if (ARAccRec.DisallowNegativeTotalsonSales!=0) then begin
      if (ORr.Sum4<0) then begin
        RecordCheckError(22047,"",0,"Sum");      
        res = -1; 
        goto LORVcRecordCheck;
      end;
    end;
  end;

  rwcnt = MatRowCnt(ORr);
  if (transf) then begin
    if (rwcnt==0) then begin
      RecordCheckError(1030,"",0,"ArtCode");      
      res = -1;
      goto LORVcRecordCheck;
    end;
  end;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORr,i,ORrw);
    
    if(nonblank(ORrw.ArtCode) and ORrw.RRPPrice==0)then begin
    	PLr.ArtCode = ORrw.ArtCode;
    	PLr.PLCode = "RRP";
    	if(readfirstmain(PLr,2,true))then begin
    		ORrw.RRPPrice = PLr.ExVatPrice;
    		MatRowPut(ORr,i,ORrw);
    	end;
    	
    end;
    switch (ORrw.stp) begin
      case 1:
        if (nonblank(ORrw.Spec) and blank(ORrw.ArtCode) and blank(ORrw.Quant)) then begin
          goto LORVcRecordRowCheck;
        end;
        if (HasModNL) then begin
        if (ARAccRec.VATCodeCtrl==1) then begin
          Accr.AccNumber = ORrw.SalesAcc;
          if (blank(Accr.AccNumber)) then begin
            //Get Account from setting ? 
          end;
          if (ReadFirstMain(Accr,1,true)) then begin
            if ((nonblank(Accr.VATCode)) and (Accr.VATCode!=ORrw.VATCode)) then begin
              RecordCheckError(1245,"",i,"VATCode");      
              res = -1;
              goto LORVcRecordCheck;
            end;
          end else begin
            tstr = ORrw.SalesAcc;
            ConvertSalesAcc(tstr,ORr.ExportFlag);
            Accr.AccNumber = tstr;
            if (ReadFirstMain(Accr,1,true)) then begin
              if ((nonblank(Accr.VATCode)) and (Accr.VATCode!=ORrw.VATCode)) then begin
                RecordCheckError(1245,"",i,"VATCode");      
                res = -1;
                goto LORVcRecordCheck;
              end;
            end;
          end;
        end else begin
          if (nonblank(ORrw.SalesAcc)) then begin
            Accr.AccNumber = ORrw.SalesAcc;
            if (ReadFirstMain(Accr,1,true)==false) then begin
              RecordCheckError(1931,"",i,"SalesAcc");      
              res = -1;
              goto LORVcRecordCheck;
            end;
          end;
        end;
        end;
        if (VATAccIsClosed(ORrw.VATCode,tstr,1)) then begin
          RecordCheckError(1258,tstr,i,"VATCode");      
          res = -1; 
          goto LORVcRecordCheck;
        end;          
        if ((nonblank(ORrw.VATCode)) and (IsVATCodeDefined(ORrw.VATCode)==false)) then begin
          RecordCheckError(1120,ORrw.VATCode,i,"VATCode");      
          res = -1; 
          goto LORVcRecordCheck;
        end;
        if (transf) then begin
          if (ARAccRec.DisallowNegativeRowSumsonSales!=0) then begin
            if (ORrw.Sum<0) then begin
              RecordCheckError(22047,"",i,"Sum");      
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;
        end;
        if (nonblank(ORrw.Location)) then begin
          Locationr.Code = ORrw.Location;
          if (ReadFirstMain(Locationr,1,true)==false) then begin
            RecordCheckError(1290,"",i,"Location");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if (AllowedToTakeFromThisLoc(Locationr)==false) then begin
            RecordCheckError(1768,"",i,"Location");      
            res = -1;
            goto LORVcRecordCheck;
          end;
        end;
        if (nonblank(ORrw.Salesmen)) then begin    
          errcode = VerifySalesmen(ORrw.Salesmen,tstr);
          if (errcode!=0) then begin
            RecordCheckError(errcode,": " & tstr,i,"Salesmen");
            res = -1; 
            goto LORVcRecordCheck;
          end;
        end;
        if (nonblank(ORrw.ArtCode)) then begin
          if (HasLocalization("PRT")) then begin
            if (ORrw.vRebate<0) then begin
              RecordCheckError(22034,"",i,"vRebate");      
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;
          if (ReadFirstItemInclClosed(ORrw.ArtCode,INr,true,true)==false) then begin
            RecordCheckError(1120,ORrw.ArtCode,i,"ArtCode");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if (!INVc_AllowSales(INr,ErrorCode)) then begin
            RecordCheckError(ErrorCode,"",i,"ArtCode");      
            res = -1; 
            goto LORVcRecordCheck;
          end;
          if (closingf==false) then begin
            if (INr.Terminated!=0) then begin
              RecordCheckError(1266,ORrw.ArtCode,i,"ArtCode");      
              res = -1;
              goto LORVcRecordCheck;
            end;
          end;
          if (check!=0) then begin
            if (IsRecipeClosed(INr.Recepy)) then begin
              RecordCheckError(2088,"",i,"ArtCode");      
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;          
          if (CheckAllowedSize(INr,ORrw.UnitXval,ORrw.UnitYval,ORrw.UnitZval)==false) then begin
            RecordCheckError(1480,ORrw.ArtCode,i,"UnitXval");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if (IsSerialNrCorrect(ORrw.SerialNr)==false) then begin
            RecordCheckError(24154,ORrw.SerialNr,i,"SerialNr");      
            res = -1; 
            goto LORVcRecordCheck;
          end;
          if (CheckSerialStatus(ORrw.ArtCode,ORrw.SerialNr,tstr)==2) then begin
            RecordCheckError(2210," " & tstr,i,"SerialNr");      
            res = -1;
//            MessageBox(0,tstr);
            goto LORVcRecordCheck;
          end;
          if (AllowThisItem("ORVc",ORr.PRCode,ORrw.ArtCode,INr.ItemType)==false) then begin
            RecordCheckError(1285,ORrw.ArtCode,i,"ArtCode");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if(stat==updatemode)then begin //Edit***************************Sasha2,14:01 28.10.2014 {
			if(ORr.Reserved!=0 and OR2r.Reserved!=0)then begin
				if(ORr.Location!=OR2r.Location)then begin
					RecordCheckError(22067,"",-1,"Location");      
					res = -1;
					goto LORVcRecordCheck;
				end;
			end;
          end; //Edit***************************Sasha2,14:01 28.10.2014 }
          location = ORrw.Location;
          if (blank(location)) then begin
            location = ORr.Location;
          end;          
          if (blank(location)) then begin
            location = MSb.MainStock;
          end;            
          if (StockRecordForLocationAllowed("ORVc",location,ORrw.ArtCode,ORr.OrdDate,ORr.OKFlag,errcode,errstr)==false) then begin
            RecordCheckError(errcode,errstr,i,"ArtCode");      
            res = -1;
            goto LORVcRecordCheck;
          end;
          if (nonblank(ORrw.Position) and nonblank(ORrw.SerialNr)) then begin 
            errcode = CheckSerialatPositionInItemHist(ORrw.ArtCode,location,ORrw.Position,ORrw.SerialNr,ORrw.Quant);
            if (errcode!=0) then begin 
              RecordCheckError(15057," : " & USetStr(12872) & " " & USetStr(16148) ,i,"Position");
              res = -1;
              goto LORVcRecordCheck;
            end;  
          end;   
          if (ORr.Reserved!=0 or (ORr.OKFlag!=0 and ORr.Reserved==0)) then begin //Edit***************************Sasha2,14:04 28.10.2014
            if (OSb.dontAllowOverreserving!=0) then begin
              switch (INr.ItemType) begin
                case 1:
                  location = ORrw.Location;
                  if (blank(location)) then begin
                    location = ORr.Location;
                  end;  
                  if (blank(location)) then begin
                    location = MSb.MainStock;
                  end;  
                  orsrv = ORrw.Quant;
                  FindStockValue(ORrw.ArtCode,location,ISr);
                  for (j=0;j<i;j=j+1) begin
                    MatRowGet(ORr,j,OR2rw);
                    if (OR2rw.ArtCode==ORrw.ArtCode) then begin
                      orsrv = orsrv + OR2rw.Quant;
                    end;
                  end;
                  orsrved = 0;
                  if (stat==updatemode) then begin
                    if (RecordValid(OR2r)) then begin
                      if (OR2r.Reserved!=0) then begin
                        for (j=0;j<MatRowCnt(OR2r);j=j+1) begin
                          MatRowGet(OR2r,j,OR2rw);
                          if (OR2rw.ArtCode==ORrw.ArtCode) then begin
                            orsrved = orsrved + OR2rw.Quant;
                          end;
                        end;
                      end;
                    end;
                  end;
                  if(ISr.RsrvQty<0) then begin //Edit***************************Sasha2,14:04 28.10.2014 {
                    ISr.RsrvQty = 0;
                  end; //Edit***************************Sasha2,14:04 28.10.2014 }
                  if ((orsrv)>(ISr.Instock-ISr.RsrvQty+orsrved)) then begin // StockRsrvQty ?
                  	if(currentuser!="SA" and currentuser!="ALENA_BYST")then begin// Edit ************************** Friday, 28 August 2015 15:49:44
											RecordCheckError(20011,"",i,"Quant");      
											res = -1;
											goto LORVcRecordCheck;
                    end else begin
                    	if(ORr.Reserved==0)then begin
                    		messagebox(20011," " & i);
                    	end else begin
                    		RecordCheckError(20011,"",i,"Quant");      
												res = -1;
												goto LORVcRecordCheck;
                    	end;
                    end;
                  end;// Edit ************************** Friday, 28 August 2015 15:49:51
                case 2:
//                  checkit
              end;
            end;
          end;
        end else begin
          if (nonblank(ORrw.SerialNr)) then begin
            RecordCheckError(1209,ORrw.SerialNr,i,"SerialNr");      
            res = -1; 
            goto LORVcRecordCheck;
          end;
          if (ORrw.Quant!=0) then begin
            RecordCheckError(1130,ORrw.ArtCode,i,"ArtCode");      
            res = -1; 
            goto LORVcRecordCheck;
          end;
        end;
        if (ORrw.Sum!=0) then begin
          if (blank(ORrw.ArtCode)) then begin
            RecordCheckError(1130,ORrw.ArtCode,i,"ArtCode");      
            res = -1;
            goto LORVcRecordCheck;
          end;
//          if (nonblank(ORrw.Objects)) then begin//this check must run even if this field is blank
          VerifyRowObjects("SL",ORr.Objects,ORrw.Objects,ORrw.SalesAcc,errcode,errstr,initotcheckf,otcheckaccs,otcheckobjtyps,otcheckcnt);
          if (errcode!=0) then begin
            RecordCheckError(errcode,errstr,i,"Objects");      
            res = -1;
            goto LORVcRecordCheck;
          end;
//          end;
          if (UseTaxTemplatesforTaxCalc) then begin
            if (blank(ORrw.TaxTemplateCode)) then begin
              RecordCheckError(24201,"",i,"TaxTemplateCode");      
              res = -1;
              goto LORVcRecordCheck;
            end;
            errcode = VerifyTaxTemplateCode(ORrw.TaxTemplateCode,tstr);
            if (errcode!=0) then begin
              RecordCheckError(errcode,tstr,i,"TaxTemplateCode");      
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end else begin
            if (blank(ORrw.VATCode)) then begin
              RecordCheckError(1134,"",i,"VATCode");      
              res = -1;
              goto LORVcRecordCheck;
            end;
          end;
        end;
        if (ORrw.Shipd1>0) then begin
          if ((MSb.DelOrdQty!=0) and (OR2r.Closed==0)) then begin
            if (CheckOrderQtys(ORrw,i,OR2r)==false) then begin
              RecordCheckError(1302,"",i,"Quant");      
              res = -1;
              goto LORVcRecordCheck;
            end;
          end else begin     
            if ((INr.ItemType!=kItemTypePlain) and (INr.ItemType!=kItemTypeService)) then begin
              if (ORrw.Quant<ORrw.Shipd1) then begin
                RecordCheckError(1302,"",i,"Quant");      
                res = -1;
                goto LORVcRecordCheck;
              end;
            end;
          end;
        end;
        if ((OptRec.NegQtyOnIV==0) or (INr.ItemType==1) or (INr.ItemType==2)) then begin
          if (ORrw.Quant<0) then begin
            RecordCheckError(1574,"",i,"Quant");      
            res = -1;
            goto LORVcRecordCheck;          
          end;
        end;
        if (CorrectM4ValProc(ORrw.vRebate)==false) then begin
          RecordCheckError(1019,"",i,"vRebate");      
          res = -1;
          goto LORVcRecordCheck;
        end;
        if (blank(ORr.PlanShip)) then begin
          if (blank(ORrw.PlanShipRow) and nonblank(ORrw.ArtCode)) then begin
            if (PDb.ForcePlanDelDate!=0) then begin
              RecordCheckError(1058,"",i,"PlanShipRow"); 
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;
        end;
        if (ORCheckForSalesmanPrice(ORr,i,location,User.MinPLCode,errstr)==false) then begin 
          RecordCheckError(20116,errstr,i,"Price");      
          res = -1; 
          goto LORVcRecordCheck;
        end;                     
        if (i<MatRowCnt(OR2r)) then begin
          MatRowGet(OR2r,i,OR2rw);
          rsrvd = GetORRowReserv(ORr.SerNr,OR2rw.ArtCode,OR2rw.SerialNr,ordqty,comment,tstr,true);
          if (OR2rw.ArtCode!=ORrw.ArtCode) then begin
            if (rsrvd>0) then begin
              RecordCheckError(20564,"",i,"ArtCode"); 
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;
          if (ORrw.Quant-ORrw.Shipd1>0) then begin
            if (rsrvd>ORrw.Quant-ORrw.Shipd1) then begin
              RecordCheckError(22067,"",i,"ArtCode"); 
              res = -1; 
              goto LORVcRecordCheck;
            end;
          end;
        end;
        
        if (ORrw.OrderQuant>0) then begin							//Edit----------------------Dima  06.10.2015
          if (ORrw.NecessaryQuant < ORrw.OrderQuant + ORrw.Quant) then begin
              RecordCheckError(31122,"",i,"OrderQuant");      
              res = -1;
              goto LORVcRecordCheck;
            end;
        end;
        if (ORrw.OrderQuant < ORrw.ProcessingQuant) then begin	//Edit----------------------Dima  26.01.2016
              RecordCheckError(31137,chr(10) & chr(10) & USetStr(31138),i,"OrderQuant");      
              res = -1;
              goto LORVcRecordCheck;
        end;
    end;
LORVcRecordRowCheck:;
  end;
  
  
  if (ORr.OKFlag!=0 and UserCanAction("AllowOKInvoicesWithZeroSum",false) == false) then begin			//Edit----------------------Dima  02.04.2015
  	rwcnt = MatRowCnt(ORr);
  	for(i=0;i<rwcnt;i=i+1) begin
  		MatRowGet(ORr,i,ORrw);
			if (ORrw.stp == kInvoiceRowTypeNormal and ORrw.Price == 0 and nonblank(ORrw.ArtCode)) then begin
				RecordCheckError(31042,"",i,"Price");
				res = -1;
		  	goto LORVcRecordCheck;
		  end;
  	end; 
  end; 
  
  
  if (ORr.DeliveryNewPost) then begin					//Edit-------------------------------------Dima  15.04.2015
  	if (blank(ORr.NPFirstName) or blank(ORr.NPLastName)) then begin
         RecordCheckError(31043,"",-1,"NPLastName"); 
         res = -1; 
         goto LORVcRecordCheck;
    end;
   	if (blank(ORr.NPPhone)) then begin
         RecordCheckError(31044,"",-1,"NPPhone"); 
         res = -1; 
         goto LORVcRecordCheck;
    end; 
   	if (blank(ORr.NPCityRecipient)) then begin
         RecordCheckError(31045,"",-1,"NPCityRecipient"); 
         res = -1; 
         goto LORVcRecordCheck;
    end;   
    
    NPCityr.City = ORr.NPCityRecipient;
    if (ReadFirstMain(NPCityr,1,true)==false) then begin
         RecordCheckError(31045,"",-1,"NPCityRecipient"); 
         res = -1; 
         goto LORVcRecordCheck;
		end;
		
		NPWarehouser.City = ORr.NPCityRecipient;
		NPWarehouser.Number = ORr.NPWarehouse;
		if (ReadFirstKey("City",NPWarehouser,2,true)==false) then begin
         RecordCheckError(31049,"",-1,"NPWarehouse"); 
         res = -1; 
         goto LORVcRecordCheck;
		end;	
  
  end;	//Edit----end----------------------------------Dima  15.04.2015
  
  if (ORr.AutoCreation!=0 and blank(ORr.Advance)) then begin	//Edit----------------------Dima  16.12.2015
      RecordCheckError(31131,"",-1,"Advance"); 
      res = -1; 
      goto LORVcRecordCheck;		
	end;
  
  
  if (ORr.DeliveryNewPost) then begin					//Edit by Victor 20.05.2015
  	if (nonblank(ORr.NPFirstName)) then begin
  		tmpStr = ORr.NPFirstName;
  		
  		i = 0;
  		char = Mid(tmpStr,i,1);
			while(char==chr(32)) begin
				i = i + 1;
				char = Mid(tmpStr,i,1);
			end;
			
			tmpStr = Right(tmpStr, len(tmpStr) - i);
			nameLen = len(tmpStr);
			
  		for (i=0;i<nameLen;i=i+1) begin
        char = Mid(tmpStr,i,1);
        nextChar = Mid(tmpStr,i+1,1);
        if(char == chr(32) and nextChar == chr(32))then begin
         goto nextI;
        end;			
        if (char!=chr(32) or (char==chr(32) and nonblank(nextChar))) then begin
	        resStr = resStr & char;
				end;     
				nextI:;
      end;
      ORr.NPFirstName = resStr;
    end;
  end;
  
  if (ORr.DeliveryNewPost) then begin					
  	if (nonblank(ORr.NPLastName)) then begin
  		tmpStr = ORr.NPLastName;
  		
  		i = 0;
  		char = Mid(tmpStr,i,1);
			while(char==chr(32)) begin
				i = i + 1;
				char = Mid(tmpStr,i,1);
			end;
			
			tmpStr = Right(tmpStr, len(tmpStr) - i);  		
  		nameLen = len(tmpStr);
  		resStr = "";
  		for (i=0;i<nameLen;i=i+1) begin
        char = Mid(tmpStr,i,1);
        nextChar = Mid(tmpStr,i+1,1);	
        if(char == chr(32) and nextChar == chr(32))then begin
         goto nextI2;
        end;					
        if (char!=chr(32) or (char==chr(32) and nonblank(nextChar))) then begin
	        resStr = resStr & char;
				end;  
				nextI2:;    
      end;  
      ORr.NPLastName = resStr;		  		
    end;
  end;
  
LORVcRecordCheck:;
  if (res!=0) then begin 
    ORr.SerNr = oldnr; 
    ORr.OfficialSerNr = oldOfficialSerNr;
    ORr.OfficialSerNrSerie = "";
  end;
  ORVcRecordCheck = res;
  return;
end;

function LongInt ORRemoveTest(record ORVc ORp,LongInt errmf)
begin
  record DBLockBlock DBLockRec;
  record SHVc SHr;
  record RetVc Retr;
  row ORVc ORrw;
  LongInt res;
  Boolean shipf;
  Boolean notfullyshpf;
  Integer i,rwcnt;
  record ARPayHistVc ARPayHr;
  record OPPVc OPPr;
  
  res = 1;
  SHr.OrderNr = ORp.SerNr;
  rwcnt = MatRowCnt(ORp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORp,i,ORrw);
    if (ORrw.Shipd1>0) then begin
      shipf = true;
      if ((ORrw.Shipd2!=ORrw.Quant) or
          (ORrw.Invd!=ORrw.Quant)) then begin
        notfullyshpf = true;
      end;
    end;
    if (ORrw.Invd>0) then begin
      shipf = true;
      if ((ORrw.Shipd2!=ORrw.Quant) or
          (ORrw.Invd!=ORrw.Quant)) then begin
        notfullyshpf = true;
      end;
    end;
  end;
  Retr.OrdNr = ORp.SerNr;
  if (ReadFirstKey("OrdNr",Retr,1,true)) then begin
    if (errmf!=0) then begin MessageBox(1560,""); end;
    res = 0;
    goto LORRemoveTest;
  end;
  ARPayHr.OrderNr = ORp.SerNr;
  if(currentuser!="SA")then begin// Edit ************************** Tuesday, 15 September 2015 14:51:55
		if (ReadFirstKey("OrderNr",ARPayHr,1,true)) then begin
			if (errmf!=0) then begin MessageBox(1876," " & ORp.SerNr); end;
			res = 0;
			goto LORRemoveTest;
		end;
  end;
  if (ORp.OKFlag!=0) then begin
    BlockLoad(DBLockRec);
    if (ORp.OrdDate>DBLockRec.DeleteBeforeDate) then begin
      if (errmf!=0) then begin MessageBox(1560,""); end;
      res = 0;
      goto LORRemoveTest;
    end;
  end;
  if (shipf==false) then begin
    goto LORRemoveTest;
  end;
  if (notfullyshpf or shipf) then begin
    if (errmf!=0) then begin MessageBox(1560,""); end;
    res = 0;
    goto LORRemoveTest;
  end;
  if (AcceptanceActivityExists(kAcceptanceOR,"ORVc",ORp.SerNr,ORp.CustCode)) then begin
    if (errmf>0) then begin MessageBox(1560,""); end;
    res = 0;
    goto LORRemoveTest;
  end;  
  if (ORp.Closed!=0) then begin
    res = 1;
  end;
LORRemoveTest:;
  ORRemoveTest = res;
  return;
end;

global
function LongInt ORVcRecordRemoveTest(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record ORVc locORr;

  locORr.SerNr = ORr.SerNr;
  if (ReadFirstMain(locORr,1,true)) then begin
    res = ORRemoveTest(locORr,long3);
  end else begin
    res = ORRemoveTest(ORr,long3);
  end;
  ORVcRecordRemoveTest = res; 
  return;
end;

global
updating procedure UpdateOrdOut(record ORVc ORp,Boolean addf,Boolean futorf)
begin
  record MainStockBlock MSb;
  record SHVc SHr;
  row SHVc SHrw;
  row ORVc ORrw;
  Integer i,rwcnt;
  val t,theqty;
  val t2,t3;
  Integer j,shrwcnt;
  Boolean isstruct;
  string 255 location,theloc;
  record DropSHVc DropSHr;
  
  switch (ORp.OrderType) begin
    case kOrderTypeDropShip:
      goto LUpdateOrdOut;
  end;
  BlockLoad(MSb);
  location = ORp.Location;
  if (blank(location)) then begin
    location = MSb.MainStock;
  end;
  rwcnt = MatRowCnt(ORp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORp,i,ORrw);
    if (ORrw.OrderType!=kOrderTypeDropShip) then begin
    if (ORrw.stp==kInvoiceRowTypeNormal) or (ORrw.stp==kInvoiceRowTypeStructuredItemComponent) then begin
      if (nonblank(ORrw.Location)) then begin
        theloc = ORrw.Location;
      end else begin
        theloc = location;
      end;
      theqty = ORrw.Quant;
      isstruct = false;
      if (ORrw.stp!=kInvoiceRowTypeStructuredItemComponent) then begin
        isstruct = ExpandStructItem(ORrw.ArtCode,ORrw.Recepy,theqty,SHr);
      end;
      if (isstruct==false) then begin
        t2 = theqty;
        t3 = blankval;
        if (ORp.Reserved!=0) then begin
          t3 = ORrw.Quant - ORrw.Shipd2;
        end;
        if (addf==false) then begin
          t2 = -t2;
          t3 = -t3;
        end else begin
          if (ORp.Closed!=0) then begin  // if ord is closed then nothing left to deliver
//            if (MSb.UpdateAvailable==1) then begin
//              t2 = theqty;
//            end else begin
              if (ORrw.Shipd2<ORrw.Quant) then begin
                t2 = ORrw.Shipd2;
              end;
//            end;            
            if (ORp.Reserved!=0) then begin
//              t3 = t2;
              t3 = blankval;
            end else begin
              t3 = blankval;
            end;
            DropSHr.OrderNr = ORp.SerNr;
            if (ReadFirstKey("OrderNr",DropSHr,1,true)) then begin //this means someone changed Drop Ship type to Normal
              t2 = blankval;
            end;
          end;
        end;
        if ((t2!=0) or (t3!=0)) then begin
          UpdateInstock("ORVc",ORp.SerNr,ORrw.ArtCode,theloc,ORp.OrdDate,t,t2,t3,t,t,t,t,t,t);
        end;
      end else begin
        // We save the original item as well as the components! 
        if (nonblank(ORrw.Location)) then begin
          theloc = ORrw.Location;
        end else begin
          theloc = location;
        end;
        t2 = theqty;
        if (ORp.Reserved!=0) then begin
          t3 = theqty;
        end else begin
          t3 = blankval;
        end;
        if (addf==false) then begin
          t2 = -t2;
          t3 = -t3;
        end else begin
          if (ORp.Closed!=0) then begin  //
            t2 = ORrw.Shipd2;
            if (ORp.Reserved!=0) then begin
              t3 = theqty;
              t3 = blankval;
            end else begin
              t3 = blankval;
            end;
          end;
        end;
        if ((t2!=0) or (t3!=0)) then begin
          UpdateInstock("ORVc",ORp.SerNr,ORrw.ArtCode,theloc,ORp.OrdDate,t,t2,t3,t,t,t,t,t,t);
        end;
        shrwcnt = MatRowCnt(SHr);
        for (j=0;j<shrwcnt;j=j+1) begin
          MatRowGet(SHr,j,SHrw);
          t2 = SHrw.Ship;
          if (ORp.Reserved!=0) then begin
            t3 = SHrw.Ship;
          end else begin
            t3 = blankval;
          end;
          if (addf==false) then begin
            t2 = -t2;
            t3 = -t3;
          end else begin
            if (ORp.Closed!=0) then begin  // if ord is closed then nothing left to deliver
              t2 = (SHrw.Ship/theqty)*ORrw.Shipd2;
              if (ORp.Reserved!=0) then begin
                t3 = ORrw.Shipd2;
              //former code was wrong
                t3 = SHrw.Ship;
                t3 = blankval;
              end else begin
                t3 = blankval;
              end;
            end;
          end;
          if ((t2!=0) or (t3!=0)) then begin
            UpdateInstock("ORVc",ORp.SerNr,SHrw.ArtCode,theloc,ORp.OrdDate,t,t2,t3,t,t,t,t,t,t);
          end;
        end;
      end;
    end;
    end;
  end;
  if (futorf) then begin
    UpdateORPlanned(ORp,location,addf);
  end;
LUpdateOrdOut:;  
  return;
end;

updating procedure PRSOINStatUp(LongInt posernr,Date td,string project,string artcode,val quantp,val sump,Boolean addf)
begin
  record PRSOINVc PRSOr;
  record PRSOINVc oldPRSOr;
  Boolean found;
  Boolean delf;
  val qty,sum;
  
  if (blank(artcode)) then begin goto LPRSOINStatUp; end;
  if (blank(project)) then begin goto LPRSOINStatUp; end;
  if ((quantp!=0) or (sump!=0)) then begin
    delf = false;
    PRSOr.SOSerNr = posernr;
    PRSOr.Project = project;
    PRSOr.Item = artcode;
    found = ReadFirstMain(PRSOr,3,true);
    RecordCopy(oldPRSOr,PRSOr);
    if (found) then begin
    end else begin
      PRSOr.SOSerNr = posernr;
      PRSOr.Project = project;
      PRSOr.Item = artcode;
      PRSOr.TransDate = td;
      PRSOr.SOQty = 0;
      PRSOr.SOVal = 0;
    end;
    qty = quantp;
    sum = sump;
    if (addf==false) then begin
      qty = -quantp;
      sum = -sump;
    end;
    PRSOr.SOQty = PRSOr.SOQty + qty;
    PRSOr.SOVal = PRSOr.SOVal + sum;
    if (PRSOr.SOVal<=0) then begin delf = true; end;
    if (PRSOr.SOQty<=0) then begin delf = true; end;
    if (delf==false) then begin
      if (found) then begin
        if (RecordUpdate(oldPRSOr,PRSOr,false)==0) then begin end;
      end else begin
        if (RecordStore(PRSOr,false)) then begin end;
      end;
    end else begin
      if (found==true) then begin
        RecordDelete(oldPRSOr);
      end;
    end;
  end;
LPRSOINStatUp:;
  return;
end;

global
updating procedure UpdatePRSO(record ORVc ORp,Boolean addf)
begin
  row ORVc ORrw;
  Integer i,rwcnt;
  val valinbase1;

  rwcnt = MatRowCnt(ORp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORp,i,ORrw);
    if (ORrw.stp==1) then begin
      if (nonblank(ORp.PRCode) or nonblank(ORp.PRCode)) then begin
        valinbase1 = MulRateToBase1(ORp.CurncyCode,ORrw.Sum,ORp.FrRate,ORp.ToRateB1,ORp.ToRateB2,ORp.BaseRate1,ORp.BaseRate2,DefaultCurRoundOff);
        PRSOINStatUp(ORp.SerNr,ORp.OrdDate,ORp.PRCode,ORrw.ArtCode,ORrw.Quant,valinbase1,addf);
      end;
    end;
  end;
  return;
end;

global
updating procedure UpdateEDIOR(record ORVc ORp)
begin
  record EDIORVc oldEDIORr;
  record EDIORVc EDIORr;
  
  EDIORr.ORSerNr = ORp.SerNr;
  EDIORr.VersionNr = 1;
  if (ReadFirstKey("ORSerNr",EDIORr,1,true)) then begin
    RecordCopy(oldEDIORr,EDIORr);
    EDIORr.ORSerNr = -1;
    if (RecordUpdate(oldEDIORr,EDIORr,true)) then begin end;
  end;
  return;
end;

updating procedure ORVcRecordRemove_UpdateQT(LongInt ordnr)
begin
  record QTVc QTr;
  record QTVc oldQTr;
  Boolean found;
  
  found = true;
  QTr.OrderNr = ordnr;
  while (LoopKey("OrderNr",QTr,1,found)) begin
    if (QTr.OrderNr!=ordnr) then begin found = false;  end;
    if (found) then begin
      RecordCopy(oldQTr,QTr);
      QTr.OrderNr = -1;
      RecordUpdate(oldQTr,QTr,false);
      StepBack(QTr);
    end;
  end;
  return;
end;

global
updating function LongInt ORVcRecordRemove(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  Integer tmp;
  string 20 location;
  record MainStockBlock MSb;

  if (ORr.Closed==0) then begin
    UpdateOrdOut(ORr,false,true);
    UpdatePRSO(ORr,false);
    UpdateEDIOR(ORr);
    ORVcRecordRemove_UpdateQT(ORr.SerNr);
  end else begin
    BlockLoad(MSb);
    location = ORr.Location;
    if (blank(location)) then begin
      location = MSb.MainStock;
    end;
    UpdateORPlanned(ORr,location,false);
  end;
  tmp = ORr.Closed;
  ORr.Closed = 1;
  UpdateStockResFromOR(ORr);
  ORr.Closed = tmp;
  if (nonblank(ORr.OfficialSerNr)) then begin 
    DeleteOffSerNr(ORr.SerNr,"ORVc");
  end;
  
  ORVcRecordRemove = res; 
  return;
end;

global
procedure AutDelNonStockItem(record ORVc ORp)
begin
  row ORVc ORrw;
  Integer i,rwcnt;
  record MainStockBlock MSb;
  record INVc INr;
  Boolean updf;

  BlockLoad(MSb);
  if (MSb.DelivPlainItems==0) then begin goto LAutDelNonStockItem; end;
  rwcnt = MatRowCnt(ORp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORp,i,ORrw);
    INr.Code = ORrw.ArtCode;
    if (ReadFirstMain(INr,1,true)) then begin
      if ((INr.ItemType==kItemTypePlain) or (INr.ItemType==kItemTypeService)) then begin 
        if (ORrw.Quant!=ORrw.Shipd1) then begin
          ORrw.Shipd1 = ORrw.Quant;
          updf = true;
        end;
        if (ORrw.Quant!=ORrw.Shipd2) then begin
          ORrw.Shipd2 = ORrw.Quant;
          updf = true;
        end;
        if (updf) then begin
          MatRowPut(ORp,i,ORrw);
        end;
      end;
    end;
  end;
  if (updf) then begin SetORFlags(ORp); end;
LAutDelNonStockItem:;
  return;
end;

function Boolean ObjStatSameOR(record ORVc OR1p,record ORVc OR2p)
begin
  Boolean res;
  
  if (OR1p.Objects==OR2p.Objects) then begin
    if (OR1p.OrdDate==OR2p.OrdDate) then begin
      res = true;
    end;
  end;
  ObjStatSameOR = res;
  return;
end;

updating procedure ORObjectStats(record ORVc OR1p,record ORVc OR2p)
begin
  record ObjStatVc OSr;
  Integer pos;
  string 255 ostr;
  
  if (RecordValid(OR2p)) then begin  /* delete the OR2 objects */
    if (ObjStatSameOR(OR1p,OR2p)==false) then begin
      pos = 0;
      ExtractObj(OR2p.Objects,pos,ostr);
      while (nonblank(ostr)) begin
        OSr.SerNr = OR2p.SerNr;
        OSr.Date = OR2p.OrdDate;
        OSr.FileName = "ORVc";
        OSr.Object = ostr;
        if (ReadFirstMain(OSr,4,true)) then begin
          RecordDelete(OSr);
        end;
        ExtractObj(OR2p.Objects,pos,ostr);
      end;
    end;
  end;
  pos = 0;
  ExtractObj(OR1p.Objects,pos,ostr);
  while (nonblank(ostr)) begin
    OSr.SerNr = OR1p.SerNr;
    OSr.Date = OR1p.OrdDate;
    OSr.FileName = "ORVc";
    OSr.Object = ostr;
    if (RecordInsert(OSr,false)) then begin end;
    ExtractObj(OR1p.Objects,pos,ostr);
  end;
  return;
end;

procedure MoreORVcHandling(var record ORVc ORr,record ORVc OR2r) //Edit***************************Sasha2,11:57 15.07.2014 {
begin
row ORVc ORrw,OR2rw;
integer rwcnt1,rwcnt2,i;

  if (Blank(ORr.SalesMan) and UserCanAction("DoNotSetSalesManInOR",false)==false) then begin 
  	ORr.SalesMan = CurrentUser;
  end;
  if (ORr.CustomStatusFlag!=OR2r.CustomStatusFlag) then begin
  	ORr.TransDate = CurrentDate;
  	ORr.TransTime = CurrentTime;
  	ORr.SyncFlag = 1;
  end; 
  rwcnt1 = MatRowCnt(ORr);
  rwcnt2 = MatRowCnt(OR2r);
  if (rwcnt1!=rwcnt2) then begin
  	ORr.SyncFlag = 1;
  end else begin
  	for (i=0;i<rwcnt1;i=i+1) begin
	  	MatRowGet(ORr,i,ORrw);
	  	MatRowGet(OR2r,i,OR2rw);
	  	if (ORrw.ArtCode!=OR2rw.ArtCode or ORrw.Quant!=OR2rw.Quant or ORrw.Price!=OR2rw.Price or ORrw.Sum!=OR2rw.Sum) then begin
	  		ORr.SyncFlag = 1;
	  	end;
  	end;
  end;
  
  return;
end; //Edit***************************Sasha2,11:57 15.07.2014 }



global
function boolean CheckORVcConfirmStatus(record ORVc ORr)			//Edit----------------------Dima  23.09.2015
begin
integer i,rwcnt;
row ORVc ORrw;
boolean res;

	res = true;
/*
	if (ORr.CustomStatusFlag > 3 or ORr.Reserved==0) then begin
		res = false;
		goto LCheckORVcConfirmStatus;
	end;
*/	
	rwcnt = MatRowCnt(ORr);
	for(i=0;i<rwcnt;i=i+1) begin
		MatRowGet(ORr,i,ORrw);
		if (ORrw.NecessaryQuant!= ORrw.Quant) then begin
			res = false;
			i = rwcnt;
		end;
	end;
	
	LCheckORVcConfirmStatus:;
	CheckORVcConfirmStatus = res;
return;
end;



global
function boolean CheckORVcWaitingStatus(record ORVc ORr)			//Edit----------------------Dima  23.09.2015
begin
integer i,rwcnt;
row ORVc ORrw;
boolean res;

	res = false;
	
	rwcnt = MatRowCnt(ORr);
	for(i=0;i<rwcnt;i=i+1) begin
		MatRowGet(ORr,i,ORrw);
		if (ORrw.OrderQuant > 0) then begin
			res = true;
			i = rwcnt;
		end;
	end;	

	CheckORVcWaitingStatus = res;
return;
end;



global 
procedure Recalculate_CustomStatusFlagText(var record ORVc ORr) 	//Edit----------------------Dima  24.03.2015
begin
	  switch (ORr.CustomStatusFlag) begin
    case 0: ORr.CustomStatusFlagText = USetStr(31102);
    case 1: ORr.CustomStatusFlagText = USetStr(31103);
    case 2: ORr.CustomStatusFlagText = USetStr(31104);
    case 3: ORr.CustomStatusFlagText = USetStr(31105);
    case 4: ORr.CustomStatusFlagText = USetStr(31106);
    case 12: ORr.CustomStatusFlagText = USetStr(31113);
    case 13: ORr.CustomStatusFlagText = USetStr(31114);
    case 11: ORr.CustomStatusFlagText = USetStr(31036);
    case 5: ORr.CustomStatusFlagText = USetStr(31107);
    case 6: ORr.CustomStatusFlagText = USetStr(31108);
    case 7: ORr.CustomStatusFlagText = USetStr(31109);
    case 8: ORr.CustomStatusFlagText = USetStr(31110);
    case 9: ORr.CustomStatusFlagText = USetStr(31111);
    case 10: ORr.CustomStatusFlagText = USetStr(31112);           

  end;
  
  ORr.Group_Status = ORr.SalesGroup & ":" & ORr.CustomStatusFlagText;

return;
end;


procedure SetCustomStatusFlagBack(var record ORVc ORr,record ORVc OR2r)
begin
	if(OR2r.FeedBackStatus!=0 and ORr.FeedBackStatus==0) then begin 
		ORr.CustomStatusFlag = 1;

	end;
end;


global updating procedure UpdateORVcNewPostStatuses(record SHVc SHr)		//Edit----------------------Dima  23.09.2015
begin
	record ORVc ORr,oldORr;
	string 50 sent, received,received2;
	
	sent = USetStr(31120);
	received = USetStr(31121);
	received2 = USetStr(31063);
	
	if (SHr.NPStatus == sent or SHr.NPStatus == received or SHr.NPStatus == received2) then begin
	
		ORr.SerNr = SHr.OrderNr;
		if (ReadFirstMain(ORr,1,true)) then begin
				if(ORr.CustomStatusFlag < 7) then Begin //we don't set lower status
						if (SHr.NPStatus == sent) then begin
							ORr.CustomStatusFlag = 7;
						end;
						if (SHr.NPStatus == received) then begin
							ORr.CustomStatusFlag = 8;
						end;	
						if (SHr.NPStatus == received2) then begin
							ORr.CustomStatusFlag = 8;
						end;
						Recalculate_CustomStatusFlagText(ORr);		
						oldORr.SerNr = ORr.SerNr;
						if(readfirstmain(oldORr,1,true))then begin
							CreateORHistoryVcFromORVc(ORr,oldORr,true);// Edit ************************** Wednesday, 1 March 2017 10:50:38
						end;											
						RecordStore(ORr,true);
						SetNewORCustomStatusFlagOnWeb(ORr);// Edit ************************** Friday, 18 November 2016 09:52:07
				end;
		end;		
	end;
end;



global procedure SetRowsUID(var record ORVc ORr)		//Edit----------------------Dima  14.08.2015
begin
	row ORVc ORrw;
	integer rwcnt,i,maxUID,currentUID;
	maxUID = 0;
	
	rwcnt = MatRowCnt(ORr);
	for(i=0;i<rwcnt;i=i+1) begin
		MatRowGet(ORr,i,ORrw);
		if (maxUID < ORrw.UID) then begin
			maxUID = ORrw.UID;
		end;
	end;
	currentUID = maxUID + 1;
		
	for(i=0;i<rwcnt;i=i+1) begin
		MatRowGet(ORr,i,ORrw);
		if (ORrw.UID < 1 and nonblank(ORrw.ArtCode)) then begin
			ORrw.UID = currentUID;
			currentUID = currentUID + 1;
			//LogText(0,ORrw.ArtCode & "   " & currentUID);
			MatRowPut(ORr,i,ORrw);
		end;
	end;
		
end;


global updating procedure SendNoticeSMS(record ORVc ORr)	//Edit----------------------Dima  28.08.2015
begin
	string 20 phone;
  record SMSTextBlock SMSb;
  record CUVc CUr;
  string 255 text,newtext;
  record SMSstackVc SMSr;
  longint smsNr;

  BlockLoad(SMSb);	
	
	if (nonblank(ORr.NPPhone)) then begin
		phone = ORr.NPPhone;
	end else begin	
		CUr.Code = ORr.CustCode;
		ReadFirstMain(CUr,1,true);
		phone = CUr.Phone;
	end;
	
	switch (ORr.FeedBackStatus) begin	
		case 1: text = SMSb.Text31;
		case 2: text = SMSb.Text32;
		case 3: text = SMSb.Text33;	
	end;

	newtext = ParseSMStext(text,ORr);

	if (nonblank(text)) then begin
		newtext = ParseSMStext(text,ORr);
  	smsNr =	AddSMStoStack(phone,SMSb.Title3,newtext,ORr.CustCode,"ORVc",ORr.SerNr,ORr.OrderClass,"","");
  end;
end;

global updating function string 200 SendPaymentSMS(record ORVc ORr) //Edit----------------------Dima  14.12.2015
begin
	string 200 response,text;
	longint smsNr;
  record CUVc CUr;
  record SMSTextBlock SMSb;
  string 20 phone

	BlockLoad(SMSb);

	if (nonblank(ORr.NPPhone)) then begin
		phone = ORr.NPPhone;
	end else begin	
		CUr.Code = ORr.CustCode;
		ReadFirstMain(CUr,1,true);
		phone = CUr.Phone;
	end;

  text = ParseSMStext(SMSb.Requisites,ORr);  
  smsNr = AddSMStoStack(phone,SMSb.Title1,text,ORr.CustCode,"ORVc",ORr.SerNr,ORr.OrderClass,"","");
	response = CheckAndSendSMS(smsNr); 

SendPaymentSMS = response;
return;
end;


global updating function boolean AcceptIVVcFromORVcweb(record ORVc ORr)	//Edit----------------------Dima  23.11.2015
begin
	record IVVc IVr,oldIVr;
  Integer err1,err2;
  record LocalMachineBlock LMb;
  boolean res;
  
	res = false;
	IVr.OrderNr = ORr.SerNr;
	if (ORr.OrderClass=="WEB" and ORr.NPPaymentType == 0 and ORr.PrepaymentReceived == 1) then begin
		if (ReadFirstKey("OrderNr",IVr,1,true)) then begin
			if (IVr.OKFlag == 0) then begin
				RecordCopy(oldIVr,IVr);
				IVr.OKFlag = 1;
				IVr.InvDate = CurrentDate;
				IVVc_PasteInvDate(IVr,LMb,err1,err2);
				IVr.TransDate = CurrentDate;//Edit----------------------Dima 29.12.2015
				if (RecordUpdate(oldIVr,IVr,true) != 0) then begin
      	  //RecordCheckError(31128,IVr.SerNr,-1,"SerNr");
      	end;
      end;
      res = true;
    end;  
	end;

AcceptIVVcFromORVcweb = res;
return;  
end;

updating
procedure MakeInvoiceAndShipmentForOR(record ORVc ORr)		//Edit----------------------Dima  14.12.2015
begin
	integer res,error;
	string 60 warning;
	record IVVc IVr,oldIVr;
	record SHVc SHr;

	RecordNew(IVr);
	if(ORr.AutoCreation>0 and ORr.NPPaymentType==0)then begin// Edit ************************** Monday, 23 January 2017 16:04:57
		IVr.FiscalFlag = 1;
	end;
	res = RecordAction_raPasteOrdInInv(IVr,ORr.SerNr,true,error);
  LogText(0,ORr.SerNr & ":  Invoice was created   " & IVr.SerNr);	
  if (error>0 or res>0) then begin
    LogText(error,"");
    LogText(res,"");
  end else begin
  	if(IVr.SerNr>-1)then begin
  		if(ORr.AutoCreation>0 and ORr.NPPaymentType==0)then begin// Edit ************************** Monday, 23 January 2017 16:04:57
				RecordCopy(oldIVr,IVr);
				IVr.FiscalFlag = 1;
				if (RecordUpdate(oldIVr,IVr,true) != 0) then begin end;
			end;
  	end;
  end;
  if (ORr.NPPaymentType==1 and IVr.OKFlag==0) then begin	// set OK if not prepayment
		RecordCopy(oldIVr,IVr);
		IVr.OKFlag = 1;
		if (RecordUpdate(oldIVr,IVr,true) != 0) then begin end;
  end;
    
  res = RecordAction_raPasteOrdInShip(SHr,ORr.SerNr,warning);
  if (nonblank(warning)) then begin
    LogText(0,warning);
  end;
  
  LogText(0,ORr.SerNr & ":  Shipment was created   " & SHr.SerNr);  
  
  if (ORr.NPPaymentType == 0) then begin
	  warning = SendPaymentSMS(ORr); 
	end;
end;



global
updating function LongInt ORVcRecordUpdate(var record ORVc ORr,record ORVc OR2r,LongInt stat,LongInt long4)
begin
  LongInt res;
	val fr,to1,to2;//Edit---------------------------Dima 29.01.2015
	Date edt;	//Edit--------------------------------Dima 29.01.2015
	record NPCounterpartyVc NPCounterpartyr;
	record ORVc oldORr;
	row ORVc ORrw;
	integer rwcnt;

  ORr.Prntdf = 0;
  HandlePromotionObjectsIV(ORr,OR2r,2); //Edit***************************Sasha2,10:31 25.01.2017
  AutDelNonStockItem(ORr);
  UpdateOrdOut(OR2r,false,true);
  UpdateOrdOut(ORr,true,true);
  UpdatePRSO(OR2r,false);
  UpdatePRSO(ORr,true);
  SetORFlags(ORr);
  SetORAcceptanceFlag(ORr,OR2r,stat);
  RecalculateWeightORVc(ORr,false);
  if (ORr.OrderClass == "WEB") then begin //Edit***************************Sasha2,11:57 15.07.2014
  	MoreORVcHandling(ORr,OR2r); 
  end; //Edit***************************Sasha2,11:57 15.07.2014
  if (blank(ORr.OptUAHRate)) then begin		//Edit--------------------------Dima  29.01.2015
		GetForeignCurncyRate("UAH",fr,to1,to2,ORr.OrdDate,edt);
    ORr.OptUAHRate = fr/to1;
  end;
  
  rwcnt = MatRowCnt(ORr);
  MatRowGet(ORr,0,ORrw);
  if (blank(ORrw.AvailableQuant)) then begin
  	GetAvailableItems(ORr);		//only first time //Edit----------------------Dima  24.09.2015
	end;
	
	SetCustomStatusFlagBack(ORr,OR2r);
  
  if (OR2r.Reserved==0 and ORr.Reserved!=0) then begin
		ORr.CustomStatusFlag = 1;	//Edit----------------------Dima  22.09.2015
	end;
	if (ORr.AutoCreation!=0 and OR2r.AutoCreation==0 and ORr.Reserved!=0) then begin
		ORr.CustomStatusFlag = 2;
	end;
	if (ORr.CustomStatusFlag == 2 and CheckORVcConfirmStatus(ORr)==false) then begin
	  ORr.CustomStatusFlag = 12;
	  ORr.WaitingForItemsDate = CurrentDate;
	  ORr.WaitingForItemsTime = CurrentTime;
	end;
	
	if (CheckORVcWaitingStatus(ORr)) then begin
			if (NonBlankDate(ORr.WaitingForItemsDate) and (HoursDiffWithoutRestDays(ORr.WaitingForItemsDate,ORr.WaitingForItemsTime,CurrentDate,CurrentTime) > 18)) then begin
				ORr.CustomStatusFlag = 13;
			end else begin
	  		ORr.CustomStatusFlag = 12;
	  		ORr.WaitingForItemsDate = CurrentDate;
	  		ORr.WaitingForItemsTime = CurrentTime;
			end;
	end;
	
	if (CheckORVcConfirmStatus(ORr)==true  and ORr.Reserved!=0  and (ORr.CustomStatusFlag < 5 or ORr.CustomStatusFlag > 11)) then begin //recalculate after StockMov (logistics)
		ORr.CustomStatusFlag = 2;
	end;	
		
  if (OR2r.Closed==0 and ORr.Closed!=0 and ORr.CustomStatusFlag!=10) then begin //Edit***************************Sasha2,16:19 04.02.2015 {
    ORr.CustomStatusFlag = 10;
    ORr.Addr0 = USetStr(31112) & ORr.Addr0;
  end; //Edit***************************Sasha2,16:19 04.02.2015 }
  if(ORr.DeliveryNewPost != 0)then begin
	  if(ORr.NPPhone == OR2r.NPPhone and (ORr.NPLastName != OR2r.NPLastName or ORr.NPFirstName != OR2r.NPFirstName)) then begin
	  	NPCounterpartyr.Phone = OR2r.NPPhone;
	  	NPCounterpartyr.LastName = OR2r.NPLastName;
	  	NPCounterpartyr.FirstName = OR2r.NPFirstName;
	  	if(readfirstKey("Phone",NPCounterpartyr, 3, true)) then begin
	  		NPDeleteCounterparty(NPCounterpartyr);
	  		CheckCounterparty(ORr);
	  		
	  	end;
	  end;
  end;
  
  if(ORr.FeedBackStatus==1 or ORr.FeedBackStatus==2) then begin
  		ORr.CustomStatusFlag = 3;		//Edit----------------------Dima  22.09.2015
  end;  
  if(OR2r.FeedBackStatus==3 and ORr.FeedBackStatus > OR2r.FeedBackStatus) then begin 
  		//OR.Closed sets in the begining of ORVcRecordCheck
  			ORr.CustomStatusFlag = 10;//Edit----------------------Dima  31.08.2015
  			ORr.Addr0 = USetStr(31112) & ORr.Addr0;
  end;
   
  Recalculate_CustomStatusFlagText(ORr); //Edit----------------------Dima  24.03.2015
  
  //if ((ORr.DeliveryNewPost!=0) and (OR2r.DeliveryNewPost==0)) then begin
	//	CheckCounterparty(ORr);							//Edit----------------------Dima  16.04.2015
	//end;
  TableSortOR2(ORr);//Edit----------------------Dima  07.07.2015
  SetRowsUID(ORr);	//Edit----------------------Dima  14.08.2015
  
  if (ORr.OrderClass == "RETAI" and ORr.Reserved!=0 and OR2r.Reserved==0) then begin		//Edit----------------------Dima  18.12.2015
	  ORr.ReservToDate = AddDay(CurrentDate,1);
	end;  

 
  ORVcRecordUpdate = res; 
  return;
end;

global
updating function LongInt ORVcRecordUpdateAfter(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  val bc1v;
  record SHVc SHr,oldSHr;
  boolean invoiceAccepted;
  string 50 oldstatus,newstatus;
  
  if (ORr.CustomStatusFlag == 2 and ORr.AutoCreation!=0) then begin //Edit----------------------Dima  17.12.2015
  	MakeInvoiceAndShipmentForOR(ORr);
  end;    
  // Edit Start ---------------------------------------------- Edit Start
	//Monday, 14 November 2016 15:05:50
	
  if(ORr.CustomStatusFlag!=OR2r.CustomStatusFlag)then begin
  	switch(OR2r.CustomStatusFlag)begin
  		case 0:oldstatus = "pending";//Новый
  		case 1:oldstatus = "processing";//Открыт
  		case 2:oldstatus = "approved";//Подтвержден
  		case 3:oldstatus = "nocall";//Не дозвонились
  		case 4:oldstatus = "changed";//Заказ изменен
  		case 5:oldstatus = "vsborke";//В сборке
  		case 6:oldstatus = "sobran";//Собран
  		case 7:oldstatus = "otpravlen";//Отправлен
  		case 8:oldstatus = "dostavlen";//Доставлен
  		case 9:oldstatus = "complete";//Завершен
  		case 10:oldstatus = "canceled";//Отменен
  		case 11:oldstatus = "pending_payment";//В ожидании опл.
  		case 12:oldstatus = "pending_stock";//В ожидании товаров
  		case 13:oldstatus = "no_stock";//Не достаточно тов-в
  	end;
  	switch(ORr.CustomStatusFlag)begin
  		case 0:newstatus = "pending";//Новый
  		case 1:newstatus = "processing";//Открыт
  		case 2:newstatus = "approved";//Подтвержден
  		case 3:newstatus = "nocall";//Не дозвонились
  		case 4:newstatus = "changed";//Заказ изменен
  		case 5:newstatus = "vsborke";//В сборке
  		case 6:newstatus = "sobran";//Собран
  		case 7:newstatus = "otpravlen";//Отправлен
  		case 8:newstatus = "dostavlen";//Доставлен
  		case 9:newstatus = "complete";//Завершен
  		case 10:newstatus = "canceled";//Отменен
  		case 11:newstatus = "pending_payment";//В ожидании опл.
  		case 12:newstatus = "pending_stock";//В ожидании товаров
  		case 13:newstatus = "no_stock";//Не достаточно тов-в
  	end;
  	if(oldstatus!=newstatus and nonblank(newstatus))then begin
  		if(ORr.OrderClass=="WEB" and nonblank(ORr.CustOrdNr))then begin
  			SOAPUpdateStatus(ORr.CustOrdNr,newstatus);
  		end;
  	end;
  end;
  
	// Edit End ---------------------------------------------- Edit End
	
  if (ORr.NPPaymentType == 0 and ORr.PrepaymentReceived == 1 and OR2r.PrepaymentReceived == 0 ) then begin
  	invoiceAccepted = AcceptIVVcFromORVcweb(ORr);		//if invoice isn't accepted, we will not add invoice to IPVc (AddPaymentToIPFromSH)
  end;
  
  if(ORr.DeliveryNewPost == 1)then begin		//Edit by Victor 02.06.15
		SHr.OrderNr = ORr.SerNr;
		if(ReadFirstKey("OrderKey",SHr, 1, true))then begin
			if(ORr.NPPaymentType == 0 and ORr.PrepaymentReceived == 1 and invoiceAccepted)then begin
				RecordCopy(oldSHr,SHr);
				
				//if SHr.Assembly == 1 already, RecordUpdate will not start,because nothing is changed
				//so we run  AddPaymentToIPFromSH, but only first time
				if (SHr.Assembly == 1 and OR2r.PrepaymentReceived == 0) then begin	//Edit----------------------Dima  28.10.2015
					AddPaymentToIPFromSH(SHr);			
				end;
				SHr.Assembly = 1;
				RecordUpdate(oldSHr,SHr,true);//Edit----------------------Dima  16.07.2015
			end;
			
			if(ORr.NPPaymentType == 0 and ORr.PrepaymentReceived == 0)then begin
				RecordCopy(oldSHr,SHr);
				SHr.Assembly = 0;
				RecordUpdate(oldSHr,SHr,true);//Edit----------------------Dima  16.07.2015
			end;
		end;
	end;	// end edit

//  ORObjectStats(ORr,OR2r); it is stored only and not used ever
  UpdateVARItemsOR(ORr);
  UpdateStockResFromOR(ORr);
  if (nonblank(ORr.OfficialSerNr)) then begin
    if (ORr.OfficialSerNr!=OR2r.OfficialSerNr) then begin
      UpdateOffSerNr(ORr.SerNr,"ORVc",0,ORr.OfficialSerNr,true);
    end;
  end else begin
    if (nonblank(OR2r.OfficialSerNr)) then begin
      DeleteOffSerNr(OR2r.SerNr,"ORVc");
    end;
  end;
  switch (ORr.AcceptanceStatus) begin
    case kAcceptanceStatePending:
      if (OR2r.AcceptanceStatus!=kAcceptanceStatePending) then begin
        bc1v = MulRateToBase1(ORr.CurncyCode,ORr.Sum4,ORr.FrRate,ORr.ToRateB1,ORr.ToRateB2,ORr.BaseRate1,ORr.BaseRate2,DefaultCurRoundOff);
        FindAcptRulesAndCreateAcceptanceAlert2(kAcceptanceOR,OR2r.AcceptanceStatus,"ORVc",ORr.SerNr,ORr.SalesMan,bc1v,ORr.Sum4,ORr.CurncyCode,ORr.CustCode,ORr.AcceptanceBy,ORr.AcceptanceFYI);
      end;
    case kAcceptanceStateNotRequested:
      if (OR2r.AcceptanceStatus==kAcceptanceStatePending) then begin
        CancelApprovalRequestActivities(kAcceptanceOR,"ORVc",ORr.SerNr,ORr.CustCode);
      end;
  end;
  
  if(OR2r.FeedBackStatus!=ORr.FeedBackStatus and ORr.FeedBackStatus > OR2r.FeedBackStatus) then begin 
  	SendNoticeSMS(ORr);			//Edit----------------------Dima  31.08.2015
  end;  
  CreateORHistoryVcFromORVc(ORr,OR2r,true);
  
  ORVcRecordUpdateAfter = res; 
  return;
end;

global
procedure ORRowInsertValues(record ORVc ORp,row ORVc orrp,Integer UseDiscount)
begin
  record INVc INr;
  Boolean calcpricef;
  val t,s,price,tax2prc,p;
  string 255 curitemname,salesacc,tax2code,location,taxtemplatecode;
  Boolean dummyf;
  record TaxMatrixVc TMr;
  Time blankt;
  
  if (GetFirstItem(orrp.ArtCode,INr)) then begin
    orrp.ArtCode = INr.Code;
    location = orrp.Location;
    if (blank(location)) then begin
      location = ORp.Location;
    end;
    if (GetItemPriceDiscount3(orrp.ArtCode,orrp.Quant,INr,ORp.CurncyCode,
                ORp.FrRate,ORp.ToRateB1,ORp.ToRateB2,ORp.BaseRate1,ORp.BaseRate2,
                ORp.LangCode,ORp.CustCat,ORp.PriceList,ORp.RebCode,
                price,curitemname,s,
                orrp.VATCode,t,salesacc,ORp.ExportFlag,calcpricef,ORp.OrdDate,blankt,ORp.CustCode,true,dummyf,ORp.PayDeal,tax2code,tax2prc,ORp.Region,location,taxtemplatecode)) then begin
                
      orrp.TaxTemplateCode = FillupTaxMatrix(0,ORp.BranchID,ORp.CustCode,ORp.CustCat,ORp.DelAddrCode,taxtemplatecode,TMr);
      if (blank(orrp.Price)) then begin
        orrp.Price = price;
      end;
      if (blank(orrp.vRebate)) then begin
        orrp.vRebate = s;
      end;
      if (blank(orrp.BasePrice)) then begin
        orrp.BasePrice = t;
      end;
      if (blank(orrp.Spec)) then begin
        orrp.Spec = curitemname;
      end;
      if (blank(orrp.SalesAcc)) then begin
        orrp.SalesAcc = salesacc;
      end;
      if (nonblank(ORp.CustVATCode)) then begin
        orrp.VATCode = ORp.CustVATCode;
      end;
      if ((INr.ItemType==2) and (nonblank(INr.Recepy))) then begin
        orrp.Recepy = INr.Recepy;
      end else begin
        orrp.Recepy = "";
      end;
      orrp.Objects = FindINObjects(INr.Objects,INr.Group);
      p = orrp.Price; 
      CalcPrice(orrp.BasePrice,orrp.PriceFactor,orrp.vRebate,p,UseDiscount);
      orrp.Price = p;  
      CalcSum(orrp.Quant,orrp.Price,orrp.PriceFactor,orrp.vRebate,s,UseDiscount);
      orrp.Sum = s;
      orrp.PriceFactor = INr.PriceFactor;
      t = orrp.Quant*orrp.BasePrice;   
      if (orrp.PriceFactor!=0) then begin
        t = t/orrp.PriceFactor;
      end;
      s = MulRateToBase1(ORp.CurncyCode,orrp.Sum,ORp.FrRate,ORp.ToRateB1,ORp.ToRateB2,ORp.BaseRate1,ORp.BaseRate2,DefaultCurRoundOff);
      UnpackRowFieldMatrix(orrp,"TaxMatrix",TMr);
      FindSalesExVat(TMr,orrp.VATCode,s,ORp.InclVAT,ORp.NoTAXonVAT,s);
      orrp.rowGP = s - t;          
    end;
  end;
  return;
end;

procedure ReadORFunctions(var record ORVc ORp)
begin
  Integer i,rwcnt;
  row ORVc ORrw;
  
  rwcnt = MatRowCnt(ORp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORp,i,ORrw);
    switch (ORrw.stp) begin
      case 1:
        if (ORrw.Recepy=="_") then begin
          ORrw.Recepy = "";
        end;
        if ((nonblank(ORrw.ArtCode)) and (blank(ORrw.Spec))) then begin
          ORRowInsertValues(ORp,ORrw,0);//GenOptr.UseDiscount KH??
          MatRowPut(ORp,i,ORrw);
        end;
    end;
  end;
  return;
end;




global
updating function LongInt ORVcRecordSave(var record ORVc ORr,record ORVc OR2r,LongInt stat,LongInt long4)
begin
  LongInt res;
	val fr,to1,to2;//Edit---------------------------Dima 29.01.2015
	Date edt;	//Edit--------------------------------Dima 29.01.2015

  if (blankdate(ORr.RegDate)) then begin
    ORr.RegDate = CurrentDate;
  end;
  if (blanktime(ORr.RegTime)) then begin
    ORr.RegTime = CurrentTime;
  end;
  HandlePromotionObjectsIV(ORr,OR2r,1); //Edit***************************Sasha2,10:31 25.01.2017
  AutDelNonStockItem(ORr);
  UpdateOrdOut(ORr,true,true);
  UpdatePRSO(ORr,true);
  SetORFlags(ORr);
  SetORAcceptanceFlag(ORr,OR2r,stat);
  RecalculateWeightORVc(ORr,false);
//  MakeActFromSubSys_ORVc(ORr,false,false);  done below in CreateActFromOR
  if (blank(ORr.OfficialSerNr)) then begin
    ORr.OfficialSerNr = GetCustomOfficialSerNr; //Edit***************************Sasha2,16:56 28.01.2015
    //FindNextORVcOfficialSerialNr(ORr); //Edit***************************Sasha2,16:56 28.01.2015
  end;
  if (blank(ORr.OptUAHRate)) then begin		//Edit--------------------------Dima  29.01.2015
		GetForeignCurncyRate("UAH",fr,to1,to2,ORr.OrdDate,edt);
    ORr.OptUAHRate = fr/to1;
  end;
  if (ORr.Reserved!=0) then begin
		ORr.CustomStatusFlag = 1;											//Edit----------------------Dima  22.09.2015
	end;
	if (ORr.AutoCreation!=0 and ORr.Reserved!=0) then begin
		ORr.CustomStatusFlag = 2;
	end;	
	if (CheckORVcConfirmStatus(ORr) and ORr.Reserved!=0 ) then begin			//Edit----------------------Dima  23.09.2015
		ORr.CustomStatusFlag = 2;
	end;
	if (ORr.CustomStatusFlag == 2 and CheckORVcConfirmStatus(ORr)==false) then begin
	  ORr.CustomStatusFlag = 12;
	  ORr.WaitingForItemsDate = CurrentDate;
	  ORr.WaitingForItemsTime = CurrentTime;
	end;		
  if (ORr.Closed!=0 and ORr.CustomStatusFlag!=10) then begin //Edit***************************Sasha2,16:19 04.02.2015 {
    ORr.CustomStatusFlag = 10;
  end; //Edit***************************Sasha2,16:19 04.02.2015 }
  if(ORr.FeedBackStatus==1 or ORr.FeedBackStatus==2) then begin
  		ORr.CustomStatusFlag = 3;		//Edit----------------------Dima  22.09.2015
  end;
  
     
  Recalculate_CustomStatusFlagText(ORr);
  SetNewORCustomStatusFlagOnWeb(ORr);
  
  if (ORr.OrderClass == "RETAI" and ORr.Reserved!=0) then begin		//Edit----------------------Dima  18.12.2015
	  ORr.ReservToDate = AddDay(CurrentDate,1);
	end;    
  
  //if (ORr.DeliveryNewPost) then begin
	//	CheckCounterparty(ORr);
	//end;
  TableSortOR2(ORr);//Edit----------------------Dima  07.07.2015
  SetRowsUID(ORr);	//Edit----------------------Dima  14.08.2015
  ORVcRecordSave = res; 
  return;
end;

global
updating function LongInt ORVcRecordSaveAfter(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  
//  ORObjectStats(ORr,OR2r);it is stored only and not used ever
  CreateActFromOR(ORr);
  UpdateVARItemsOR(ORr);
  SMSWhenOR(ORr,1);  
  if (nonblank(ORr.OfficialSerNr)) then begin
    UpdateOffSerNr(ORr.SerNr,"ORVc",0,ORr.OfficialSerNr,false);
  end;
  
  CreateORHistoryVcFromORVc(ORr,OR2r,false);
  
  ORVcRecordSaveAfter = res; 
  return;
end;

global
function LongInt ORVcRecordDefaults(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record OrdSettBlock OSr;
  record AccBlock ARAccRec;
  record UserVc USr;
  val fr,to1,to2,br1,br2;
  string 10 curcode;
  record MainStockBlock MSb;
  record NPSettingsBlock NPSettingsb;// Edit ************************** Monday, 17 October 2016 15:04:04
	
	
	BlockLoad(NPSettingsb);// Edit ************************** Monday, 17 October 2016 15:04:14
  BlockLoad(OSr);
  BlockLoad(ARAccRec);
  BlockLoad(MSb);
  ORr.SerNr = -1;
  ORr.OrdDate = CurrentDate;
  ORr.CustCat = "";
  ORr.Prntdf = 0;
  ORr.ExportFlag = 0;
  ORr.InvFlag = 0;
  ORr.Closed = 0;
  ORr.ShipFlag = 0;
  ORr.QuoteNr = -1;
  ORr.DiscSum = blankval;
  ORr.DiscPerc = blankval;
  ORr.TotGP = blankval;
  ORr.Probability = blankval;
  ORr.TotQty = blankval;
  ORr.TotWeight = blankval;
  ORr.TotVolume = blankval;
  ORr.Commision = blankval;
  ORr.DownPaySent = blankval;
  ORr.DownPayRedcd = blankval;
  ORr.TAX1Sum = blankval;
  ORr.InclVAT = ARAccRec.BasePriceInclVAT;
  ORr.NoTAXonVAT = ARAccRec.NoTAXonVAT;
  ORr.TotalwoTAX = ARAccRec.TotalwoTAX;
  GetCurUser(USr);
  ORr.Objects = USr.PersObjx;
  ORr.OurContact = USr.CurOurContact;
  ORr.Location = USr.Location;
  //if (UserCanAction("DoNotSetSalesManInOR",false)==false) then begin //Edit***************************Sasha2,15:40 19.12.2016
    ORr.SalesMan = USr.Code;
    ORr.SalesGroup = USr.SalesGroup;  
  //end;
  if (SingleUserMode) then begin
    ORr.SerNr = NextSerNr("ORVc",ORr.OrdDate,-1,false,"");
  end;
  ORr.PayDeal = "";
  ORr.CurncyCode = "";
  curcode = ORr.CurncyCode;
  GetFullCurncyRate(curcode,ORr.OrdDate,fr,to1,to2,br1,br2);
  ORr.CurncyCode = curcode;
  ORr.FrRate = fr;
  ORr.ToRateB1 = to1; 
  ORr.ToRateB2 = to2;
  ORr.BaseRate1 = br1;
  ORr.BaseRate2 = br2;  
  if (OSr.OrdToDespDate!=0) then begin
    ORr.DespatchDate = ORr.OrdDate;
  end;
  ORr.InvBeforeShip = MSb.AllowInvBeforeShip;
  ORr.AcceptanceStatus = kAcceptanceStateNotRequired;
  if (AcceptanceRulesExists(kAcceptanceOR,ORr.CustCode)) then begin
    ORr.AcceptanceStatus = kAcceptanceStateNotStarted;
  end;
  ORr.TerminalID = CurTerminalID;
  ORr.BranchID = CurBranchID;
  ORr.LocalMachineCode = CurMachineName;
  ORr.OfficialSerNr = "";
  ORr.OfficialSerNrSerie = "";
  ORr.Advance = 0;
  
  ORr.NPPayer = NPSettingsb.DefPayer;// Edit ************************** Monday, 17 October 2016 15:03:50
  ORr.PromotionCode = LookUpPromotionCode(ORr.OrdDate,ORr.Location); //Edit***************************Sasha2,15:32 24.01.2017
  
  ORVcRecordDefaults = res;  
  return;
end;

global
function val GetINCostPrice(string pricelist,string artcode,Boolean bbf)
begin
  val res;
  record INVc INr;
  record PLDefVc PLDr;
  record PLVc PLr;
  
  res = blankval;
  if (ReadFirstItem(artcode,INr,true,false)) then begin
    if (INr.ExplodeRec==0) then begin
      if (INr.InPrice!=0) then begin
        res = INr.InPrice;
        res = res + INr.ExtraCost;  
      end;
      if (bbf) then begin
        PLDr.Code = pricelist;
        if (ReadFIrstMain(PLDr,1,true)) then begin
          PLr.PLCode = pricelist;
          PLr.ArtCode = artcode;
          if (ReadFIrstMain(PLr,2,true)) then begin
            switch (PLDr.DepPrice) begin
              case 2:
                if (nonblank(PLr.CostPrice)) then begin
                  res = PLr.CostPrice;
                end;
            end;
          end;
        end;
      end;
    end;
  end;
  GetINCostPrice = res;
  return;
end;

global
function LongInt ORVcRecordDuplicate(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  record OrdSettBlock OSr;
  row ORVc ORrw;
  Integer i,rwcnt;
  val fr,to1,to2,br1,br2,t;
  string 10 curcode;
  record UserVc USr;
  record MainStockBlock MSb;
  Date bd;
  Time bt;
  record CreditLimitBlock CLb;
  record CUVc CUr;
  val bal,limit;
  Boolean limitdaysf;

  BlockLoad(MSb);
  BlockLoad(OSr);
  ORr.SerNr = -1;
  ORr.Prntdf = 0;
  ORr.Closed = 0;
  ORr.OKFlag = 0;
  ORr.QuoteNr = -1;
  ORr.DiscSum = blankval;
  ORr.DiscPerc = blankval;
  ORr.Probability = blankval;
  rwcnt = MatRowCnt(ORr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORr,i,ORrw);
    ORrw.Shipd1 = blankval;
    ORrw.Shipd2 = blankval;
    ORrw.Invd = blankval;
    ORrw.SerialNr = "";
    ORrw.BasePrice = GetINCostPrice(ORr.PriceList,ORrw.ArtCode,true);
    MatRowPut(ORr,i,ORrw);
    ORDchsum(ORr,i);
  end;
  ORSumup(ORr);
  GetCurUser(USr);
  ORr.OurContact = USr.CurOurContact;
  ORr.PlanShip = "";
  ORr.CustOrdNr = "";
  ORr.OrdDate = CurrentDate;
  ORr.DownPaySent = blankval;
  ORr.DownPayRedcd = blankval;
  ORr.PrepaidAmount = blankval;
  curcode = ORr.CurncyCode;
  GetFullCurncyRate(curcode,ORr.OrdDate,fr,to1,to2,br1,br2);
  ORr.CurncyCode = curcode;
  ORr.FrRate = fr;
  ORr.ToRateB1 = to1; 
  ORr.ToRateB2 = to2;
  ORr.BaseRate1 = br1;
  ORr.BaseRate2 = br2;    
  ORr.OfficialSerNr = "";
  ORr.OfficialSerNrSerie = "";
  if (OSr.OrdToDespDate!=0) then begin
    if (blankdate(ORr.DespatchDate)) then begin
      ORr.DespatchDate = ORr.OrdDate;
    end;
  end;
  SetORFlags(ORr);
  if (SingleUserMode) then begin
    ORr.SerNr = NextSerNr("ORVc",ORr.OrdDate,-1,false,"");
  end;
//  ORr.InvBeforeShip = MSb.AllowInvBeforeShip;//they want this to be copied
  ORr.AcceptanceStatus = kAcceptanceStateNotRequired;
  if (AcceptanceRulesExists(kAcceptanceOR,ORr.CustCode)) then begin
    ORr.AcceptanceStatus = kAcceptanceStateNotStarted;
  end;
  ORr.TerminalID = CurTerminalID;
  ORr.BranchID = CurBranchID;
  ORr.LocalMachineCode = CurMachineName;
  ORr.RegDate = bd;
  ORr.RegTime = bt;
  ORr.Hash = "";
  ORr.HashKeyVersion = 0;
  BlockLoad(CLb);
  CUr.Code = ORr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
  end;
  if (nonblank(CUr.WarnText1)) then begin
    MessageBox(0,CUr.WarnText1);
  end;
  if (GetCustAndBal(CUr,limit,bal,CLb.Base,CLb.OwnCheques,CLb.ThirdCheques,CLb.IOUCheques,CLb.ThirdIOUCheques,CLb.ORSaveWarn,limitdaysf)) then begin
    if (CLb.IVPaste==1) then begin
      if (limitdaysf) then begin
        MessageBox(0,USetStr(22260));
      end;
      if (limit>0) then begin
        if (bal>limit) then begin
          MessageBox(0,USetStr(1164));
        end;
      end;
    end;
  end;
  ORr.TransDate = ""; //Edit***************************Sasha2,13:50 15.07.2014
  ORr.TransTime = ""; //Edit***************************Sasha2,13:50 15.07.2014
  ORr.SyncFlag = 0; //Edit***************************Sasha2,13:50 15.07.2014
  ORr.CustomStatusFlag = 0; //Edit***************************Sasha2,13:50 15.07.2014
  ORr.PrepaymentReceived = 0;
  ORr.WaitingForItemsDate = "";
  ORr.WaitingForItemsTime = "";//Edit----------------------Dima  17.12.2015
  
  ORVcRecordDuplicate = res;  
  return;
end;

procedure RetainORStatus(record ORVc ORp,record ORVc OR2p)
begin
  Integer i,rwcnt;
  row ORVc ORrw;
  row ORVc OR2rw;
  Integer rwcnt2;
  
  ORp.Prntdf = OR2p.Prntdf;
  ORp.InvFlag = OR2p.InvFlag;
  ORp.InvMark = OR2p.InvMark;
  ORp.ShipFlag = OR2p.ShipFlag;
  ORp.ShipMark = OR2p.ShipMark;
  ORp.OSFlag = OR2p.OSFlag;
  ORp.DownPaySent = OR2p.DownPaySent;
  ORp.DownPayRedcd = OR2p.DownPayRedcd;
  rwcnt = MatRowCnt(ORp);
  rwcnt2 = MatRowCnt(OR2p);
  for (i=0;i<rwcnt;i=i+1) begin
    if (i<rwcnt2) then begin
      MatRowGet(ORp,i,ORrw);
      MatRowGet(OR2p,i,OR2rw);
      ORrw.Invd = OR2rw.Invd;
      ORrw.Shipd1 = OR2rw.Shipd1;
      ORrw.Shipd2 = OR2rw.Shipd2;
      MatRowPut(ORp,i,ORrw);
    end;
  end;
  return;
end;

global
function LongInt ORVcRecordProtectFields(var record ORVc ORr,record ORVc OR2r,LongInt long3,LongInt long4)
begin
  LongInt res;
  
  RetainORStatus(OR2r,ORr);
  ORVcRecordProtectFields = res;
  return;
end;

global
function LongInt ORVcRecordInIndex(record ORVc ORr,string indexname)
begin
  LongInt res;
 
  res = 1;
  if ((ORr.OSFlag==0) or (ORr.Sum4<=ORr.PrepaidAmount)) then begin 
    if (indexname=="ActSerNr")  then begin res = 0; end;
    if (indexname=="ActOrdDate")  then begin res = 0; end;
    if (indexname=="ActCustCode")  then begin res = 0; end;
    if (indexname=="ActName")  then begin res = 0; end;
  end;
  if (ORr.OSFlag==0) then begin 
    if (indexname=="ActArtCodeOSFlag")  then begin res = 0; end;
  end;
  
  if (ORr.Closed>0  or (ORr.CustomStatusFlag==9 or ORr.CustomStatusFlag==10)) then begin 		//Edit----------------------Dima  26.08.2015
    if (indexname=="ActShipSerNr")  then begin res = 0; end;
    if (indexname=="ActShipInvFlag")  then begin res = 0; end;
    if (indexname=="ActShipCustCode")  then begin res = 0; end;
    if (indexname=="ActShipName")  then begin res = 0; end;
    if (indexname=="ActShipOrdDate")  then begin res = 0; end;
    if (indexname=="ActShipCustOrdNr")  then begin res = 0; end;
    if (indexname=="ActShipOKFlag")  then begin res = 0; end;
    if (indexname=="ActShipOrderClass")  then begin res = 0; end;
    if (indexname=="ActShipSum4")  then begin res = 0; end;
    if (indexname=="ActShipCustomStatusFlagText")  then begin res = 0; end;
    if (indexname=="ActLastShipDate")  then begin res = 0; end;

  end;  //Edit--------------------------------------------------------------------------------------------------------------Dima  26.08.2015
 //LogText(0, ORr.SerNr & "   " & ORr.CustomStatusFlag & "    " & indexname & "   index   " & res);
  ORVcRecordInIndex = res;
  return;
end;
