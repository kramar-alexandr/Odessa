SetLangMode(LangRussian,"RUS",0);external function Boolean SetInSet2(string,string);procedure LookupInHist(string Item, Date StartDate, Date EndDate, string Loc) BEGIN   	record ItemHistVc IHr;  	Boolean TrHs,testf;  	val sold, strRest, gotval, curRest;  	  	sold = 0; // Продано  	strRest = 0;  // Начальных остаток  	gotval = 0; // Получено  	curRest = 0;  // Остаток на период  	  	TrHs = true;  	IHr.ArtCode = Item;  	IHr.Location = Loc;  	IHr.TransDate = StartDate;	while (LoopKey("ArtCodeLoc",IHr,3,TrHs)) begin		testf = true;		if (IHr.ArtCode != Item) then begin TrHs = false; testf = false; end;		if ((nonblank(Loc) and IHr.Location != Loc)) then begin TrHs = false; testf = false; end;		if (IHr.TransDate > EndDate) then begin TrHs = false; testf = false; end;		if (IHr.Invalid!=0) then begin testf = false; end;		if (testf) then begin			if (IHr.TransDate < StartDate) then begin				if (IHr.StockAffectf!=0) then begin					strRest = strRest + IHr.Qty;				end;			end;			if (IHr.TransDate >= StartDate and IHr.TransDate <= EndDate) then begin				if (IHr.StockAffectf!=0) then begin					curRest = curRest + IHr.Qty;					if (IHr.FileName == "PUVc" or IHr.FileName == "RetPUVc") then begin						gotval = gotval + IHr.Qty;					end;				end;				if (IHr.FileName == "IVVc") then begin					sold = sold + IHr.Qty;				end;			end;		end;			end;		OutVal(4,0,sold,M4Val,true);  	OutVal(5,0,strRest,M4Val,true);	OutVal(6,0,gotval,M4Val,true);  	OutVal(7,0,curRest,M4Val,true);	  	return;end;// Загон всех строк по ORVc за искомый период у виртуальных ORVcprocedure CollectOrderRows(record ORVc ORr, var record ORVc OR2r, row ORVc ORrw, var row ORVc OR2rw,Date sStartDate,Date sEndDate) BEGIN   integer i,j,rwcnt,rwcnt2,existsItem;  Boolean TrHs,testf;	ORr.OrdDate = sStartDate;	TrHs = true;	while (LoopKey("OrdDate",ORr,1,TrHs)) begin	testf = true;	if (ORr.OrdDate > sEndDate) then begin TrHs = false; testf = false; end;	if (testf) then begin	  	rwcnt = MatRowCnt(ORr);	  	if (rwcnt>0) then begin		  	for (i=0;i<rwcnt;i=i+1) begin		  		rwcnt2 = MatRowCnt(OR2r);			  		MatRowGet(ORr,i,ORrw);		  		if (rwcnt2==0) then begin		  			if (ORr.Closed==0) then begin		  				OR2rw.ArtCode = ORrw.ArtCode;		  				OR2rw.Quant = ORrw.Quant;		  				OR2rw.Shipd2 = ORrw.Quant - ORrw.Shipd2;		  			end else begin		  				OR2rw.ArtCode = ORrw.ArtCode;		  				OR2rw.Quant = ORrw.Shipd2;		  				OR2rw.Shipd2 = 0;		  			end;  			  		MatRowPut(OR2r,i,OR2rw);  			  	end else begin  			  		existsItem = 0;  			  		for (j=0;j<rwcnt2;j=j+1) begin  			  			MatRowGet(OR2r,j,OR2rw);  			  			if (OR2rw.ArtCode==ORrw.ArtCode) then begin  			  				if (ORr.Closed==0) then begin	  			  				OR2rw.Quant = OR2rw.Quant + ORrw.Quant;	  			  				OR2rw.Shipd2 = OR2rw.Shipd2 + (ORrw.Quant - ORrw.Shipd2);	  			  			end else begin	  			  				OR2rw.Quant = OR2rw.Quant + ORrw.Shipd2;	  			  			end;	  			  			MatRowPut(OR2r,j,OR2rw);	  			  			existsItem = 1;  			  			end;  			  			if (j==(rwcnt2 - 1) and existsItem==0) then begin  			  				if (ORr.Closed==0) then begin  			  					OR2rw.ArtCode = ORrw.ArtCode;	  			  				OR2rw.Quant = ORrw.Quant;	  			  				OR2rw.Shipd2 = ORrw.Quant - ORrw.Shipd2;	  			  			end else begin	  			  				OR2rw.ArtCode = ORrw.ArtCode;	  			  				OR2rw.Quant = ORrw.Shipd2;	  			  			end;	  			  			MatRowPut(OR2r,j + 1,OR2rw);  			  			end;  			  		end;		  		end;		  	end;  		end;	end;	end;	  	return;end;globalprocedure VERepRn(record RcVc RepSpec)BEGIN      record INVc INr;  record ORVc ORr, OR2r;  row ORVc ORrw, OR2rw;  Boolean TrHs,testf,loopORVc;  integer i,rwcnt;    StartReportJob("Отчет по поставщику");    Header(0,"", 1);  EndHeader;  SetRepCol(2,20);  SetRepCol(3,100);  SetRepCol(4,150);  SetRepCol(5,190);  SetRepCol(6,220);  SetRepCol(7,250);  SetRepCol(8,280);  SetRepCol(9,310);  StartFormat(15);   OutString(2,0,"Код",true);   OutString(3,0,"Наименование",true);   OutString(4,0,"Продано",true);   OutString(5,0,"Нач. остаток",true);   OutString(6,0,"Получено",true);   OutString(7,0,"Остаток",true);   OutString(8,0,"Заказано",true);   OutString(9,0,"К отгрузке",true);    OutString(340,0,"Зак.пост-ку",true);    OutString(370,0,"TRWH",true);           EndFormat;  Gray_Divider(0,1);    INr.Code = RepSpec.f1;  TrHs = true;  loopORVc = true;  while (LoopMain(INr,1,TrHs)) begin  	testf = true;  	if (nonblank(RepSpec.f1) and INr.Code != RepSpec.f1) then begin testf = false; TrHs = false; end;  	if (nonblank(RepSpec.f3) and SetInSet2(RepSpec.f3,INr.DispGroups)==false) then begin testf = false; end;  	if (testf) then begin  		StartFormat(15);  			OutString(2,0,INr.Code,true);  			OutString(3,0,INr.Name,true);  			LookupInHist(INr.Code, RepSpec.sStartDate, RepSpec.sEndDate, RepSpec.f2);  			if (loopORVc==true) then begin  				RECORDNEW(OR2r);  				CollectOrderRows(ORr,OR2r,ORrw,OR2rw,RepSpec.sStartDate,RepSpec.sEndDate);  				loopORVc = false;  			end;  			rwcnt = MatRowCnt(OR2r);	  			for (i=0;i<rwcnt;i=i+1) begin  				MatRowGet(OR2r,i,OR2rw);  				if (OR2rw.ArtCode==INr.Code) then begin  					OutString(8,0,OR2rw.Quant,true);  					OutString(9,0,OR2rw.Shipd2,true);  				end;  			end;  			  		EndFormat;  	end;  end;      EndJob;  return;end;