external procedure ExtractObj(string,var Integer,var string);
external function LongInt TimeToSeconds2(Time);
external function Integer SecondsToTime(LongInt,var Time);
external function LongInt DateDiff(Date,Date);

SetLangMode(LangRussian,"RUS",0);	

global
procedure ORHistoryRn(record RcVc RepSpec)
begin
  record ORVc ORr;
  row ORVc ORrw;
  record ORHistoryVc ORHr;
  record UserVc Ur;
  area tmparea;
  integer alen,pos,ordcnt,i,days;
  longint fromord,toord,order,printedorderscnt,prevCSF,timedif;
  string 100 ord,ordcondtype,tstr;
  array longint ords;
  array integer col;
  boolean testf,TrHs,TrHs2;
  Time prevTime,tim;
  Date prevDate;
  
  col[0] = 0;
  col[1] = col[0] + 25;
  col[2] = col[1] + 35;
  col[3] = col[2] + 35;
  col[4] = col[3] + 30;
  col[5] = col[4] + 40;
  
  col[6] = col[5] + 60;
  col[7] = col[6] + 40;
  col[8] = col[7] + 25;
  col[9] = col[8] + 40;
  col[10] = col[9] + 55;
  col[11] = col[10] + 45;
  col[12] = col[11] + 30;
  
  StartReportNoHeaderJob("Журнал изменений счетов клиентам");
    StartFormat(15);
      OutString(col[0],0,"SerNr",false);
      OutString(col[1],0,"Номер сч.",false);
      OutString(col[2],0,"Дата",false);
      OutString(col[3],0,"Время",false);
      OutString(col[4],0,"Статус",false);
      OutString(col[5],0,"Разница во врем.",false);
      OutString(col[6],0,"Менеджер",false);
      OutString(col[7],0,"Сумма",false);
      OutString(col[8],0,"Кол. поз.",false);
      OutString(col[9],0,"Статус обр.св.",false);
      OutString(col[10],0,"Предоплата",false);
      OutString(col[11],0,"Резерв",false);
      OutString(col[12],0,"ОК",false);
    EndFormat;
    Black_Divider(0,1);
    if (nonblank(RepSpec.f1)) then begin
      AddStringToArea(RepSpec.f1,tmparea);
      alen = GetAreaLength(tmparea);
      if (FindStringInArea(":",tmparea)!=alen) then begin
        fromord = StringToLongInt(FirstInRange(RepSpec.f1,20));
        toord = StringToLongInt(LastInRange(RepSpec.f1,20));
        ordcondtype = "fromto";
      end else begin
        if (alen!=1) then begin
          order = StringToLongInt(RepSpec.f1);
          ordcondtype = "one";
        end;
      end;
    
      switch (ordcondtype) begin
        case "one":
          ORr.SerNr = order;
        case "fromto":
          ORr.SerNr = fromord;
        case "array":
          ORr.SerNr = ords[0];
        otherwise
          ORr.SerNr = 0;
      end;
      TrHs = true;
      //while (LoopKey("OrdDate",ORr,1,TrHs)) begin
      while (LoopMain(ORr,1,TrHs)) begin
        testf = true;
        //if !((ORr.OrdDate>=RepSpec.sStartDate) and (ORr.OrdDate<=RepSpec.sEndDate)) then begin testf = false; end;
        switch (ordcondtype) begin
          case "one":
            TrHs = false;
            if (ORr.SerNr!=order) then begin
              testf = false;
            end;
          case "fromto":
            if !((ORr.SerNr>=fromord) and (ORr.SerNr<=toord)) then begin
              TrHs = false;
              testf = false;
            end;
          otherwise
            testf = true;
        end;
        if (nonblank(RepSpec.f2) and (ORr.CustCode!=RepSpec.f2)) then begin testf = false; end;
        if nonblank(RepSpec.AccStr) then begin
          if (ORr.SalesMan!=RepSpec.AccStr) then begin
            testf = false;
          end else begin
            Ur.Code = ORr.SalesMan;
            readfirstmain(Ur,1,true);
            if (nonblank(RepSpec.f3) and (Ur.SalesGroup!=RepSpec.f3)) then begin testf = false; end;
          end;
        end;
        if (nonblank(RepSpec.ObjStr) and (ORr.OrderClass!=RepSpec.ObjStr)) then begin testf = false; end;
        if (nonblank(RepSpec.f4) and (ORr.Location!=RepSpec.f4)) then begin testf = false; end;
        if (testf) then begin
          ORHr.ORNr = ORr.SerNr;
          printedorderscnt = printedorderscnt + 1;
          TrHs2 = true;
          resetloop(ORHr);
          prevCSF = -1;
          prevTime = "";
          prevDate = "";
          while (LoopKey("ORNr",ORHr,1,TrHs2)) begin
            if (ORHr.ORNr!=ORr.SerNr) then begin TrHs2 = false; end;
            if (TrHs2) then begin
              if (prevCSF==-1) then begin
                prevCSF = ORHr.CustomStatusFlag;
                prevTime = ORHr.Time;
                prevDate = ORHr.Date;
              end;
              StartFormat(15);
                OutString(col[0],0,ORHr.SerNr,false);
                OutString(col[1],0,ORHr.ORNr,false);
                OutString(col[2],0,ORHr.Date,false);
                OutString(col[3],0,ORHr.Time,false);
                tstr = "";
                switch (ORHr.CustomStatusFlag) begin
                  case 0: tstr = "Новый";
                  case 1: tstr = "Открыт";
                  case 2: tstr = "Подтвержден";
                  case 3: tstr = "Не дозвонились";
                  case 4: tstr = "Заказ изменен";
                  case 5: tstr = "В сборке";
                  case 6: tstr = "Собран";
                  case 7: tstr = "Отправлен";
                  case 8: tstr = "Доставлен";
                  case 9: tstr = "Завершен";
                  case 10: tstr = "Отменен";
                  case 11: tstr = "В ожидании опл.";
                  case 12: tstr = "В ожидании товаров";
                  case 13: tstr = "Не достаточно тов-в";
                end;
                OutString(col[4],0,tstr,false);
                if (prevCSF!=ORHr.CustomStatusFlag) then begin
                  timedif = TimeToSeconds2(ORHr.Time) - TimeToSeconds2(prevTime);
                  tstr = "";
                  days = DateDiff(ORHr.Date,prevDate);
                  if (timedif<0) then begin
                    timedif = 86400 + timedif;
                    days = days - 1;
                  end;
                  SecondsToTime(timedif,tim);
                  if (days != 0) then begin
                    tstr = days;
                    switch (days) begin
                      case 1: tstr = tstr & " день ";
                      case 2: tstr = tstr & " дня ";
                      case 3: tstr = tstr & " дня ";
                      case 4: tstr = tstr & " дня ";
                      otherwise
                        tstr = tstr & " дней ";
                    end;
                  end;
                  tstr = tstr & tim;
                  OutString(col[5],0,tstr,false);
                  
                  prevCSF = ORHr.CustomStatusFlag;
                  prevTime = ORHr.Time;
                  prevDate = ORHr.Date;
                end else begin
                  OutString(col[5],0,"",false);
                end;
                OutString(col[6],0,ORHr.SalesMan,false);
                OutString(col[7],0,ORHr.Sum4,false);
                OutString(col[8],0,ORHr.rwcnt,false);
                tstr = "";
                switch (ORHr.FeedBackStatus) begin
                  case 0: tstr = "Обратная связь от клиента получена";
                  case 1: tstr = "Не дозвонились 1-ый раз";
                  case 2: tstr = "Не дозвонились 2-ой раз";
                  case 3: tstr = "Не дозвонились 3-ий раз. Заказ закрыт";
                end;
                OutString(col[9],0,tstr,false);
                tstr = "";
                switch (ORHr.PrepaymentReceived) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[10],0,tstr,false);
                tstr = "";
                switch (ORHr.Reserved) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[11],0,tstr,false);
                tstr = "";
                switch (ORHr.OKFlag) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[12],0,tstr,false);
              EndFormat;
            end;
          end;
          Gray_Divider(0,1);
        end;
      end;
    end else begin
      ORr.OrdDate = RepSpec.sStartDate;
      TrHs = true;
      while (LoopKey("OrdDate",ORr,1,TrHs)) begin
        testf = true;
        if !((ORr.OrdDate>=RepSpec.sStartDate) and (ORr.OrdDate<=RepSpec.sEndDate)) then begin testf = false; end;
        if (nonblank(RepSpec.f2) and (ORr.CustCode!=RepSpec.f2)) then begin testf = false; end;
        if nonblank(RepSpec.AccStr) then begin
          if (ORr.SalesMan!=RepSpec.AccStr) then begin
            testf = false;
          end else begin
            Ur.Code = ORr.SalesMan;
            readfirstmain(Ur,1,true);
            if (nonblank(RepSpec.f3) and (Ur.SalesGroup!=RepSpec.f3)) then begin testf = false; end;
          end;
        end;
        if (nonblank(RepSpec.ObjStr) and (ORr.OrderClass!=RepSpec.ObjStr)) then begin testf = false; end;
        if (nonblank(RepSpec.f4) and (ORr.Location!=RepSpec.f4)) then begin testf = false; end;
        if (testf) then begin
          ORHr.ORNr = ORr.SerNr;
          printedorderscnt = printedorderscnt + 1;
          TrHs2 = true;
          resetloop(ORHr);
          prevCSF = -1;
          prevTime = "";
          prevDate = "";
          while (LoopKey("ORNr",ORHr,1,TrHs2)) begin
            if (ORHr.ORNr!=ORr.SerNr) then begin TrHs2 = false; end;
            if (TrHs2) then begin
              if (prevCSF==-1) then begin
                prevCSF = ORHr.CustomStatusFlag;
                prevTime = ORHr.Time;
                prevDate = ORHr.Date;
              end;
              StartFormat(15);
                OutString(col[0],0,ORHr.SerNr,false);
                OutString(col[1],0,ORHr.ORNr,false);
                OutString(col[2],0,ORHr.Date,false);
                OutString(col[3],0,ORHr.Time,false);
                tstr = "";
                switch (ORHr.CustomStatusFlag) begin
                  case 0: tstr = "Новый";
                  case 1: tstr = "Открыт";
                  case 2: tstr = "Подтвержден";
                  case 3: tstr = "Не дозвонились";
                  case 4: tstr = "Заказ изменен";
                  case 5: tstr = "В сборке";
                  case 6: tstr = "Собран";
                  case 7: tstr = "Отправлен";
                  case 8: tstr = "Доставлен";
                  case 9: tstr = "Завершен";
                  case 10: tstr = "Отменен";
                  case 11: tstr = "В ожидании опл.";
                  case 12: tstr = "В ожидании товаров";
                  case 13: tstr = "Не достаточно тов-в";
                end;
                OutString(col[4],0,tstr,false);
                if (prevCSF!=ORHr.CustomStatusFlag) then begin
                  timedif = TimeToSeconds2(ORHr.Time) - TimeToSeconds2(prevTime);
                  tstr = "";
                  days = DateDiff(ORHr.Date,prevDate);
                  if (timedif<0) then begin
                    timedif = 86400 + timedif;
                    days = days - 1;
                  end;
                  SecondsToTime(timedif,tim);
                  if (days != 0) then begin
                    tstr = days;
                    switch (days) begin
                      case 1: tstr = tstr & " день ";
                      case 2: tstr = tstr & " дня ";
                      case 3: tstr = tstr & " дня ";
                      case 4: tstr = tstr & " дня ";
                      otherwise
                        tstr = tstr & " дней ";
                    end;
                  end;
                  tstr = tstr & tim;
                  OutString(col[5],0,tstr,false);
                  
                  prevCSF = ORHr.CustomStatusFlag;
                  prevTime = ORHr.Time;
                  prevDate = ORHr.Date;
                end else begin
                  OutString(col[5],0,"",false);
                end;
                OutString(col[6],0,ORHr.SalesMan,false);
                OutString(col[7],0,ORHr.Sum4,false);
                OutString(col[8],0,ORHr.rwcnt,false);
                tstr = "";
                switch (ORHr.FeedBackStatus) begin
                  case 0: tstr = "Обратная связь от клиента получена";
                  case 1: tstr = "Не дозвонились 1-ый раз";
                  case 2: tstr = "Не дозвонились 2-ой раз";
                  case 3: tstr = "Не дозвонились 3-ий раз. Заказ закрыт";
                end;
                OutString(col[9],0,tstr,false);
                tstr = "";
                switch (ORHr.PrepaymentReceived) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[10],0,tstr,false);
                tstr = "";
                switch (ORHr.Reserved) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[11],0,tstr,false);
                tstr = "";
                switch (ORHr.OKFlag) begin
                  case 0: tstr = "Да";
                  case 1: tstr = "Нет";
                end;
                OutString(col[12],0,tstr,false);
              EndFormat;
            end;
          end;
          Gray_Divider(0,1);
        end;
      end;
    end;
  EndJob;
  return;
end;