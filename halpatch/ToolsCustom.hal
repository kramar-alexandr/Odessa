external function roundmode SetRoundModeD(Integer);// Edit ************************** Monday, 13 October 2014 15:06:01external procedure RecalculateActOkFlag(var record POVc);	//Edit----------------------Dima  12.03.2015external procedure Recalculate_CustomStatusFlagText(var record ORVc); //Edit----------------------Dima  24.03.2015external function Boolean IsDigit(string);external procedure ExtractObj(string,var Integer,var string);remote function Boolean StockMovVc_PasteArtCode(var record StockMovVc,Integer,Integer,var array string);external updating function longint AddSMStoStack(string,string,string,string,string,longint,string,date,time); //Edit***************************Sasha2,16:45 28.08.2015external function string 255 ParseSMStext(string, record ORVc);external procedure Recalculate_CustomStatusFlagText(var record ORVc);	//Edit----------------------Dima  22.09.2015external function boolean CheckORVcConfirmStatus(record ORVc);		//Edit----------------------Dima  24.09.2015external procedure PrintAcceptanceActivities(Integer,string,string,string);external procedure PurgeTRExtYc(record PurgeTRVc,var string);external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);external function Integer GetIntYc(Date);external function string 255 CreateInvoiceNumber(LongInt,string);external procedure SubPrePayments(record IVVc,var val,var val);external procedure TRExtYc(record TRVc,var string);external function Integer TypeOfCurncy(var string,var Integer);	external updating procedure CreateLinksToOrders(record StockMovVc);//Edit----------------------Dima  22.12.2015external function val AbsoluteVal(val);//Edit----------------------Dima  18.02.2016SetLangMode(LangRussian,"RUS",0);global //Edit***************************Sasha2,17:05 14.08.2015 {updating procedure RemoveReservedMarkMn()begin  record ORVc ORr,OR2r;  boolean TrHs,testf,okedf;  date mindate;  LongInt res;  record SMSstackVc SMSr;  longint smsNr;  time sendTime;  record SMSTextBlock SMSb;  string 200 newtext;    	BlockLoad(SMSb);      mindate = AddDay(CurrentDate,-31);    sendTime = StringToTime("10:00:00");    TrHs = true;    ORr.OrdDate = mindate;    while (LoopKey("OrdDate",ORr,1,TrHs)) begin      testf = true;      if (ORr.Reserved!=1 or ORr.OrdDate<mindate or blankdate(ORr.ReservToDate) or ORr.Closed==1) then begin testf = false; end;      if (NonBlank(ORr.ReservToDate) and ORr.ReservToDate>CurrentDate) then begin testf = false; end;      if (ORr.OrderClass!="WEB" and ORr.OrderClass!="RETAI") then begin testf = false; end;// Edit ************************** Saturday, 29 August 2015 08:53:18      if (ORr.NPPaymentType!=0 or ORr.PrepaymentReceived!=0) then begin testf = false; end;			//Edit----------------------Dima  23.09.2015      if (ORr.CustomStatusFlag!=5) then begin testf = false; end;// Edit ************************** Saturday, 29 August 2015 08:53:19                  if (testf and NonBlank(ORr.ReservToDate) and ORr.ReservToDate==CurrentDate) then begin// Edit ************************** Saturday, 29 August 2015 08:57:08      	if (nonblank(SMSb.Text41)) then begin      		newtext = ParseSMStext(SMSb.Text41,ORr);	        smsNr = AddSMStoStack(ORr.NPPhone,SMSb.Title4,newtext,ORr.CustCode,"ORVc",ORr.SerNr,ORr.OrderClass,CurrentDate,sendTime);        end;        testf = false;      end;      if (testf) then begin        res = 0;        okedf = false;        if (ORr.OKFlag!=0) then begin          RecordCopy(OR2r,ORr);          ORr.OKFlag = 0;          res = RecordUpdate(OR2r,ORr,true);          okedf = true;        end;        if (res==0) then begin              RecordCopy(OR2r,ORr);          ORr.Reserved = 0;          if (RecordUpdate(OR2r,ORr,true)==0) then begin      	      	if (nonblank(SMSb.Text42)) then begin			      		newtext = ParseSMStext(SMSb.Text42,ORr);              		AddSMStoStack(ORr.NPPhone,SMSb.Title4,newtext,ORr.CustCode,"ORVc",ORr.SerNr,ORr.OrderClass,CurrentDate,sendTime);            	end;	            res = 0;            if (okedf) then begin              RecordCopy(OR2r,ORr);              ORr.OKFlag = 1;              ORr.CustomStatusFlag = 10;		//Edit----------------------Dima  16.09.2015              ORr.Comment = USetStr(31101) & ORr.Comment;              ORr.Closed = 1;              res = RecordUpdate(OR2r,ORr,true);            end;            if (res!=0) then begin              LogText(0,"Reserve off problem with order #" & ORr.SerNr);            end;          end;        end;      end;     end;    return;end; //Edit***************************Sasha2,17:06 14.08.2015 }global function CreateEAN128(var string str)beginstring 255 res,res1;integer ksum,sum,c,lenth,i;val csum;area arr;  res = "";  sum = 0;  res = res & chr(195) & chr(144);  sum = sum+103;  lenth = len(str);  for(i=0;i<lenth;i=i+1)begin    c = asc(mid(str,i,1));    c = c - 32;    sum = sum + c*(i+1);  end;  csum = sum/103;  if(csum<round(csum,SetRoundModeD(0))) then begin     ksum = round(csum,SetRoundModeD(0))-1;   end else begin    ksum = round(csum,SetRoundModeD(0));  end;  sum = sum-(ksum*103);  res = res & str;  if(sum<95) then begin    If(sum==0) then begin      res = res & chr(195) & chr(148);    end else begin      res = res & chr(sum+32);    end;    end else begin  res = res & chr(195) & chr(sum+41);  end;  //res = res & chr(211);  //res = res & chr(211);  res = res & chr(195) & chr(147);  addtexttoarea(res,arr);  writeareatofile(arr,"888",0);  str = res;return;end;global // Edit ************************** Monday, 13 October 2014 14:42:59procedure CalcEANCHS(var string str)begininteger c1,c2,lenth,i,chsum,litle;val sum;  sum = 0;  lenth = len(str);  if (lenth==12)then begin    for(i=0;i<12;i=i+2)begin      c1 = evaltoval(mid(str,i,1));      c2 = evaltoval(mid(str,i+1,1));      c2=c2*3;      sum = sum+c1+c2;    end;    if(round(sum/10,SetRoundModeD(0))>sum/10) then begin      litle = round(sum/10,SetRoundModeD(0))-1;    end else begin      litle = round(sum/10,SetRoundModeD(0));    end;    chsum  = 10-(10*(sum/10-litle));    if(chsum==10) then begin chsum = 0; end;    str = str & chsum;  end else begin    str = "";  end;  return;end;globalprocedure BarcodeIncrement(var string barcode,Integer increment)begin  integer lenght,i,lastindex,leftover,base,incr;  array integer digit;  boolean testf;        testf = true;    lenght = len(barcode);    incr = increment;    for (i=0;i<lenght;i=i+1) begin      digit[i] = StringToInt(mid(barcode,i,1));      lastindex = i;    end;    digit[lastindex] = digit[lastindex] + incr;    while (digit[lastindex]>9 and testf) begin      leftover = Mod(digit[lastindex],10);      base = digit[lastindex] - leftover;      if (base>0) then begin        digit[lastindex] = leftover;        incr = base/10;        lastindex = lastindex - 1;        digit[lastindex] = digit[lastindex] + incr;      end;      if (lastindex==0 and digit[lastindex]>9) then begin        testf = false;      end;    end;    barcode = "";    if (testf) then begin      for (i=0;i<lenght;i=i+1) begin        barcode = barcode & digit[i];      end;    end;   return; end;global  //Edit***************************Sasha2,12:00 22.01.2015 {updating procedure HandleSetEAN13PU(var record PUVc PUr)begin  row PUVc PUrw;  record INVc INr,IN2r;  integer mrcnt,i;  string 40 barcode,tempean;  boolean TrHs,testf;      mrcnt = MatRowCnt(PUr);    for (i=0;i<mrcnt;i=i+1) begin      MatRowGet(PUr,i,PUrw);      if (NonBlank(PUrw.ArtCode) and blank(PUrw.BarCode)) then begin        INr.Code = PUrw.ArtCode;        if (ReadFirstMain(INr,1,true)) then begin          if (NonBlank(INr.BarCode)) then begin            PUrw.BarCode = INr.BarCode;            MatRowPut(PUr,i,PUrw);          end else begin            IN2r.BarCode = "2";            TrHs = true;            testf = true;            if (blank(tempean)) then begin              while (LoopKey("BarCode",IN2r,1,TrHs)) begin                if (left(IN2r.BarCode,1)!="2") then begin TrHs = false; end;                if (Len(IN2r.BarCode)==13) then begin testf = false; end;                if (Len(IN2r.BarCode)!=13 and testf==false) then begin TrHs = false; end;                if (TrHs) then begin                  tempean = IN2r.BarCode;                end;              end; RESETLOOP(IN2r);            end;            if (tempean=="2999999999991") then begin              goto LHandleSetEAN13PU;            end;            if (blank(tempean) or left(tempean,1)!="2" or len(tempean)!=13) then begin              barcode = "199999999999";            end else begin              barcode = mid(tempean,0,12);            end;            BarcodeIncrement(barcode,1);            if (NonBlank(barcode)) then begin               CalcEANCHS(barcode);              INr.BarCode = barcode;              tempean = barcode;              RECORDSTORE(INr,true);              PUrw.BarCode = barcode;              MatRowPut(PUr,i,PUrw);            end else begin              goto LHandleSetEAN13PU;            end;          end;        end;      end;    end;    LHandleSetEAN13PU:;      return;end; //Edit***************************Sasha2,12:01 22.01.2015 }global updating procedure RecalcINVolumeMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record INVc INr;	roundmode rnd;			rnd = DefaultValRoundoff;  	rnd.decimals = 0;  	rnd.mode = kRoundingModeHalfUp;		INr.Code = "";	while(loopmain(INr,1,true))begin		if (INr.Volume > 0) then begin			//INr.Volume = Round(INr.Volume,rnd) / 100000; //Edit***************************Sasha2,17:25 30.07.2014			INr.Volume = INr.Volume / 1000; //Edit***************************Sasha2,11:24 31.07.2014			RECORDSTORE(INr, true);		end;	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global updating procedure DelLoyaltyCardMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record LoyaltyCardVc LoyaltyCardr;	Boolean TrHs;		LoyaltyCardr.SerNr = "";	TrHs = true;	while(loopmain(LoyaltyCardr,1,TrHs))begin		if (TrHs) then begin			RecordDelete(LoyaltyCardr);    		StepBack(LoyaltyCardr);		end;	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global updating procedure CleaningMn() //Edit------------------------------Dima,   24.12.2014begin	record CLInVc CLInr;	record CLOutVc CLOutr;	record IPVc IPr;	record OPVc OPr;	record IVVc IVr;	record VIVc VIr;	record POVc POr;	record SHVc SHr;	record PUVc PUr;	record SDVc SDr;	record StockMovVc StockMovr;	record RetVc Retr;	record RetPUVc RetPUr;	record ORVc ORr;	record TRVc TRr;	record FBVc FBr;	record ItemHistVc IHr;	record ItemStatusVc ISr;	record PPVc PPr;	record CUVc CUr;	record INVc INr;	Boolean TrHs;			TrHs = true;	while (LoopMain(CLInr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(CLInr);	    StepBack(CLInr);	  end;	end;	TrHs = true;	while (LoopMain(CLOutr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(CLOutr);	    StepBack(CLOutr);	  end;	end;	TrHs = true;	while (LoopMain(IPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IPr);	    StepBack(IPr);	  end;	end;	TrHs = true;	while (LoopMain(IVr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IVr);	    StepBack(IVr);	  end;	end;	TrHs = true;	while (LoopMain(VIr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(VIr);	    StepBack(VIr);	  end;	end;	TrHs = true;	while (LoopMain(POr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(POr);	    StepBack(POr);	  end;	end;	TrHs = true;	while (LoopMain(OPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(OPr);	    StepBack(OPr);	  end;	end;	TrHs = true;	while (LoopMain(SHr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(SHr);	    StepBack(SHr);	  end;	end;	TrHs = true;	while (LoopMain(PUr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(PUr);	    StepBack(PUr);	  end;	end;	TrHs = true;	while (LoopMain(SDr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(SDr);	    StepBack(SDr);	  end;	end;	TrHs = true;	while (LoopMain(StockMovr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(StockMovr);	    StepBack(StockMovr);	  end;	end;	TrHs = true;	while (LoopMain(Retr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(Retr);	    StepBack(Retr);	  end;	end;	TrHs = true;	while (LoopMain(RetPUr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(RetPUr);	    StepBack(RetPUr);	  end;	end;	TrHs = true;	while (LoopMain(ORr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(ORr);	    StepBack(ORr);	  end;	end;	TrHs = true;	while (LoopMain(TRr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(TRr);	    StepBack(TRr);	  end;	end;	TrHs = true;	while (LoopMain(FBr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(FBr);	    StepBack(FBr);	  end;	end;	TrHs = true;	while (LoopMain(IHr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IHr);	    StepBack(IHr);	  end;	end;	TrHs = true;	while (LoopMain(ISr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(ISr);	    StepBack(ISr);	  end;	end;	TrHs = true;	while (LoopMain(PPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(PPr);	    StepBack(PPr);	  end;	end;	TrHs = true;	while (LoopMain(CUr,1,TrHs)) begin	  if (TrHs and (CUr.VEType==0)) then begin	    RecordDelete(CUr);	    StepBack(CUr);	  end;	end;	TrHs = true;	while (LoopMain(INr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(INr);	    StepBack(INr);	  end;	end;return;end;global //Edit***************************Sasha2,16:10 29.01.2015 {updating procedure ReplaceUAHtoUAHRinWEBandRetailCUMn() begin  record CUVc CUr;  boolean testf;        CUr.Code = "";    while (LoopMain(CUr,1,true)) begin      testf = true;      if (CUr.CustCat!="RETAI" and CUr.CustCat!="WEB") then begin testf = false; end;      if (testf) then begin        CUr.CurncyCode = "UAH_R";        RECORDSTORE(CUr,true);      end;    end;  return;end; //Edit***************************Sasha2,16:11 29.01.2015 }global //Edit by Victor 30.01.15	***updating procedure PutQtysToPOMn() begin  record POVc POr;  record INVc INr;  row POVc POrw;  integer rwcnt, i;        POr.SerNr = "";    while (LoopMain(POr,1,true)) begin      rwcnt = MatRowCnt(POr);			for (i=0;i<rwcnt;i=i+1) begin				MatRowGet(POr,i,POrw);				if (nonblank(POrw.ArtCode)) then begin					INr.Code = POrw.ArtCode;					if(ReadfirstMain(INr, 1, true))then begin						POrw.QtyPack = INr.AddUnitCoef3;	   					POrw.QtyBox = INr.AddUnitCoef2;						end;									end;				MatRowPut(POr,i,POrw);			end;				    	RECORDSTORE(POr,true);          end;  return;end;	// ***global updating procedure RestoreLinksFromORtoSHandIVMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record ORVc ORr;	record SHVc SHr;	record IVVc IVr;	string 255 rlink;	boolean TrHs;		while (loopmain(ORr,1,true)) begin	 IVr.OrderNr = ORr.SerNr;	 TrHs = true;	 while (LoopKey("OrderNr",IVr,1,TrHs)) begin  	 if (IVr.OrderNr!=ORr.SerNr) then begin TrHs=false; end;  	 if (TrHs) then begin  	    CreateRecordLink(ORr,CurrentCompany,IVr,CurrentCompany);        CreateRecordLink(IVr,CurrentCompany,ORr,CurrentCompany);  	 end;	 end; RESETLOOP(IVr);	 SHr.OrderNr = ORr.SerNr;	 TrHs = true;	 while (LoopKey("OrderKey",SHr,1,TrHs)) begin	   if (SHr.OrderNr!=ORr.SerNr) then begin TrHs=false; end;	   if (TrHs) then begin	     CreateRecordLink(ORr,CurrentCompany,SHr,CurrentCompany);       CreateRecordLink(SHr,CurrentCompany,ORr,CurrentCompany);	   end;	 end; RESETLOOP(SHr);	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global 	//Edit----------------------Dima  11.02.2015updating procedure PutFlagsForCUWeb() begin  record CUVc CUr;    CUr.CustCat = "WEB";    while (LoopMain(CUr,1,true)) begin      if (CUr.CustCat=="WEB") then begin 					Cur.OnAccount = 1;							Cur.SelfBilling = 1;       		RECORDSTORE(CUr,true);      end;    end;  return;end;global 	//Edit***************************Sasha2,15:21 26.02.2015 {updating procedure CreateLoyaltyForWebClients() begin  record CUVc CUr;  record LoyaltyCardVc LoyaltyCardr;  record IVVc IVr;  Boolean TrHs,TrHs1,testf,testf1;  val sum;    CUr.CustCat = "WEB";    TrHs = true;    while (LoopKey("ActGroup",CUr,1,TrHs)) begin      testf = true;      if (CUr.CustCat!="WEB") then begin TrHs = false; testf = false; end;      if (testf) then begin        LoyaltyCardr.SerNr = CUr.Code;        if (!ReadFirstMain(LoyaltyCardr,1,true)) then begin          RECORDNEW(LoyaltyCardr);          LoyaltyCardr.SerNr = CUr.Code;          LoyaltyCardr.CustCode = CUr.Code;          LoyaltyCardr.CustName = CUr.Name;          LoyaltyCardr.LCMLevel = "1";          //LoyaltyCardr.PointsBalance = StringToVal(Cur.Comment1,M4Val);          IVr.CustCode = CUr.Code;          TrHs1 = true;          sum = 0;          while (LoopKey("CustCode",IVr,1,TrHs1)) begin            testf1 = true;            if (IVr.CustCode!=CUr.Code) then begin TrHs1 = false; testf1 = false; end;            if (IVr.OKFlag==0 or IVr.Invalid!=0) then begin testf1 = false; end;            if (testf1) then begin              if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin                sum = sum - IVr.Sum4;              end else begin                sum = sum + IVr.Sum4;              end;            end;          end; RESETLOOP(IVr);          RECORDSTORE(LoyaltyCardr,true);          LoyaltyCardr.PointsBalance = LoyaltyCardr.PointsBalance + sum;          RECORDSTORE(LoyaltyCardr,true);        end;      end;    end;  return;end; //Edit***************************Sasha2,15:21 26.02.2015 }global		updating procedure RecalculatePOVC_ActOkFlag_Mn()		//Edit----------------------Dima  12.03.2015	begin	record POVc POr;	row POVc POrw;	integer rwcnt,i;	longint totQuant,totShip;		totQuant=0;	totShip=0;		while (LoopMain(POr,1,true)) begin			RecalculateActOkFlag(POr);			RecordStore(POr,true);	end;return;end;global		updating procedure RecalculateORVC_CustomStatusFlagText_Mn()		//Edit----------------------Dima  24.03.2015	begin	record ORVc ORr;		while (LoopMain(ORr,1,true)) begin			Recalculate_CustomStatusFlagText(ORr);			RecordStore(ORr,true);	end;return;end;globalupdating procedure ChangeCUCategoryMn(record RcVc RepSpec)		//Edit----------------------Dima  27.03.2015begin	record CUVc CUr;	boolean TrHs,testf;		CUr.CustCat = RepSpec.f1;	TrHs = true;	while (LoopMain(CUr,1,TrHs)) begin	//while (LoopKey("CustCat",CUr,2,TrHs)) begin		testf = true;		if (CUr.CustCat != RepSpec.f1) then begin				//TrHs = false;				testf= false;		end;		if (CUr.RebCode != RepSpec.f2)	 then begin					testf = false;		end;						if (testf) then begin			CUr.RebCode = RepSpec.f3;			RecordStore(CUr,true);		end;			end;		return;	end;globalupdating procedure FillCommentsInPricesMn(record RcVc RepSpec)		//Edit----------------------Dima  06.04.2015begin	record PLVc PLr;	record INVc INr;		boolean TrHs,testf;		PLr.Comment = "";	TrHs = true;	while (LoopKey("Comment",PLr,1,TrHs)) begin		if (nonblank(PLr.Comment)) then begin TrHs = false; end;						if (TrHs) then begin			INr.Code = PLr.ArtCode;			if (ReadFirstMain(INr,1,true)) then begin				PLr.Comment = INr.Name;				RecordStore(PLr,true);				StepBack(PLr);			end;		end;			end;		return;	end;global procedure ExportRegsMn(record RcVc RepSpec)		begin	record IPVc IPr;	record OPVc OPr;	record IVVc IVr;	record VIVc VIr;	record POVc POr;	record SHVc SHr;	record PUVc PUr;	record SDVc SDr;	record StockMovVc StockMovr;	record RetVc Retr;	record ORVc ORr;	record TRVc TRr;	record ItemHistVc IHr;	record ItemStatusVc ISr;	record CUVc CUr;	record INVc INr;   string 50 reg,filename;  area a;  		reg = RepSpec.f1;		switch(reg) begin		case "CUVc":				While(LoopMain(CUr,1,true)) begin					AddRecordToArea(CUr,"CUVc",a);				end;		case "INVc":				While(LoopMain(INr,1,true)) begin					AddRecordToArea(INr,"INVc",a);				end;		case "IVVc":				While(LoopMain(IVr,1,true)) begin					AddRecordToArea(IVr,"IVVc",a);				end;		case "IPVc":				While(LoopMain(IPr,1,true)) begin					AddRecordToArea(IPr,"IPVc",a);				end;		case "OPVc":				While(LoopMain(OPr,1,true)) begin					AddRecordToArea(OPr,"OPVc",a);				end;		case "VIVc":				While(LoopMain(VIr,1,true)) begin					AddRecordToArea(VIr,"VIVc",a);				end;		case "POVc":				While(LoopMain(POr,1,true)) begin					AddRecordToArea(POr,"POVc",a);				end;			case "PUVc":				While(LoopMain(PUr,1,true)) begin					AddRecordToArea(PUr,"PUVc",a);				end;		case "SDVc":				While(LoopMain(SDr,1,true)) begin					AddRecordToArea(SDr,"SDVc",a);				end;		case "StockMovVc":				While(LoopMain(StockMovr,1,true)) begin					AddRecordToArea(StockMovr,"StockMovVc",a);				end;		case "RetVc":				While(LoopMain(Retr,1,true)) begin					AddRecordToArea(Retr,"RetVc",a);				end;		case "ORVc":				While(LoopMain(ORr,1,true)) begin					AddRecordToArea(ORr,"ORVc",a);				end;		case "TRVc":				While(LoopMain(TRr,1,true)) begin					AddRecordToArea(TRr,"TRVc",a);				end;		case "ItemHistVc":				While(LoopMain(IHr,1,true)) begin					AddRecordToArea(IHr,"ItemHistVc",a);				end;			case "ItemStatusVc":				While(LoopMain(ISr,1,true)) begin					AddRecordToArea(ISr,"ItemStatusVc",a);				end;																																																									end;			filename = reg & ".txt";		WriteAreaToFile(a,filename,0);	return;	end;globalupdating procedure CutDigitCUMn(record RcVc RepSpec)		//Edit by Victor 25.05.15begin	record CUVc CUr;	record ORVc ORr;	record NPCityVc Cityr;	string 60 str;	string 255 city;	string 10 c;	boolean TrHs, testf;	Integer pos;  pos = 0;		CUr.Code = "";		while (LoopMain(CUr,1,true)) begin		str = CUr.InvAddr0;			if(nonblank(str))then begin			c = left(str, 1);			if(IsDigit(c)==true)then begin				CUr.InvAddr0 = right(str, len(str) - 1);				RecordStore(CUr, true);			end;		end else begin			ORr.CustCode = CUr.Code;			TrHs = true;			while(LoopBackKey("CustCode", ORr, 1, TrHs)) begin				testf = true;				if(ORr.CustCode != CUr.Code) then begin					testf = false;					TrHs = false;				end;				if(testf and TrHs)then begin					if(nonblank(ORr.NPCityRecipient)) then begin						CUr.InvAddr0 = ORr.NPCityRecipient;						RecordStore(CUr, true);						TrHs = false;					end else begin						str = ORr.ShipAddr2;						pos = 0;						city = "";						ExtractObj(str,pos,city);						if(nonblank(city)) then begin							Cityr.City = city;														if (ReadFirstMain(Cityr,1,true)) then begin								CUr.InvAddr0 = Cityr.City;								RecordStore(CUr, true);								TrHs = false;							end else begin								Cityr.CityRU = city;								if(ReadFirstKey("CityRU", Cityr, 1, true)) then begin									CUr.InvAddr0 = Cityr.City;									RecordStore(CUr, true);									TrHs = false;								end;							end;						end;										end;				end;			end;			resetloop(ORr);		end;				end;		return;	end;globalupdating procedure RecalculateFIFOforInvoiceMn(record RcVc RepSpec)		//Edit----------------------Dima  03.06.2015begin	record IVVc IVr;	row IVVc IVrw;	record ItemHistVc IHr;	boolean TrHs,testf;	integer i,rwcnt;	val cost;	While(LoopMain(IVr,1,true)) begin		testf = true;		if (IVr.UpdStockFlag==0) then begin testf=false; end;				if (testf) then begin			rwcnt =	MatRowCnt(IVr);			for(i=0;i<rwcnt;i=i+1) begin				MatRowGet(IVr,i,IVrw);				if(IVrw.Quant<0) then	begin					IHr.TransDate = IVr.TransDate;					IHr.ArtCode = IVrw.ArtCode;					IHr.FileName = "PUVc";					if (ReadLastKey("FNArtCode",IHr,2,false)) then begin												cost = IHr.TotCostPrice / IHr.Qty;							IVrw.FIFO = cost*(-IVrw.Quant);							IVrw.FIFORowVal = cost;							//LogText(0,IHr.ArtCode & ":  " & IHr.SerNr & "   " & cost);//Edit----------------------Dima  03.06.2015							MatRowPut(IVr,i,IVrw);							RecordStore(IVr,true);					end;				end;			end;		end;			end;return;	end;global updating procedure FixStockMovMn()begin	record StockMovVc SMr;	row StockMovVc SMrw;	record SDVc SDr;	row SDVc SDrw;		record ItemHistVc IHr;	integer i,mtrw;	boolean TrHs,testf,changed;	val outcost;		SMr.TransDate = stringtodate("1/1/2015");	while(loopkey("TransDate",SMr,1,true)) begin		changed = false;		mtrw = matrowcnt(SMr);		For(i=0;i<mtrw;i=i+1) begin	  	matrowget(SMr,i,SMrw);	  	if(SMrw.Quant>1)then begin	  		IHr.FileName = "StockMovVc";	  		IHr.TransNr = SMr.SerNr;	  		IHr.Row = i;	  		TrHs = true;	  		outcost = blankval;	  		while(loopkey("FNTransNr",IHr,3,TrHs)) begin	  			if(IHr.FileName!="StockMovVc" or IHr.TransNr!=SMr.SerNr or IHr.Row!=i)then begin TrHs = false; end;	  				  			if(TrHs)then begin	  				if(IHr.Qty<0)then begin	  					outcost = outcost + IHr.TotCostPrice;	  				end;	  			end;	  		end;	  			  		if(outcost!=SMrw.FIFORowVal)then begin	  			changed = true;	  			SMrw.FIFORowVal = outcost;	  			/*SMrw.SentOldPrice = SMrw.SentFIFORowVal/SMrw.Quant;      					SMrw.SentOldPrice = Round(SMrw.SentOldPrice,SetRoundModeD(5));					SMrw.SentNewPrice = SMrw.SentOldPrice;*/					SMrw.OldPrice = SMrw.FIFORowVal/SMrw.Quant;      					SMrw.OldPrice = Round(SMrw.OldPrice,SetRoundModeD(5));					SMrw.NewPrice = SMrw.OldPrice;					matrowput(SMr,i,SMrw);	  		end;	  		resetloop(IHr);	  	end;		end;		if(changed)then begin			recordStore(SMr,true);		end; 	end;				while(loopmain(SDr,1,true)) begin		changed = false;		mtrw = matrowcnt(SDr);		For(i=0;i<mtrw;i=i+1) begin	  	matrowget(SDr,i,SDrw);	  	if(SDrw.Qty>1)then begin	  		IHr.FileName = "SDVc";	  		IHr.TransNr = SDr.SerNr;	  		IHr.Row = i;	  		TrHs = true;	  		outcost = blankval;	  		while(loopkey("FNTransNr",IHr,3,TrHs)) begin	  			if(IHr.FileName!="SDVc" or IHr.TransNr!=SDr.SerNr or IHr.Row!=i)then begin TrHs = false; end;	  				  			if(TrHs)then begin	  				if(IHr.Qty<0)then begin	  					outcost = outcost + IHr.TotCostPrice;	  				end;	  			end;	  		end;	  			  		if(outcost!=SMrw.FIFORowVal)then begin	  			changed = true;	  			SDrw.FIFORowVal = outcost;					SDrw.FIFO = outcost/SDrw.Qty;					matrowput(SDr,i,SDrw);	  		end;	  		resetloop(IHr);	  	end;		end;		if(changed)then begin			recordStore(SDr,true);		end; 	end;	return;end;global updating procedure SetSalesGroupToIPVcMn()begin	record IPVc IPr;	record UserVc Userr;		While(LoopMain(IPr,1,true)) begin		if (nonblank(IPr.Sign)) then begin			Userr.Code = IPr.Sign;			if(ReadFirstMain(Userr,1,true)) then begin    		IPr.SalesGroup = Userr.SalesGroup;    		RecordStore(IPr,true);			end;		end;	end;end;global updating procedure CancelSyncFlORVcMn() //Edit---------------Vitalii 11:31 28.07.2015begin	record ORVc ORr;	boolean TrHs;		ORr.OrdDate = "";	TrHs = true;	while (LoopKey("OrdDate",ORr,1,TrHs)) begin		if(ORr.OrdDate<AddDay(CurrentDate,-10) and TrHs) then begin			ORr.SyncFlag = 0;			RecordStore(ORr,true);		end else begin			TrHs = false;		end;	end;end;function val Min(val v1,val v2)begin  val res;    if (v1>v2) then begin    res = v2;  end else begin    res = v1;  end;  Min = res;  return;end;global procedure CollectOrdersForStockMove(var record StockMovVc SMr, record RcVc RepSpec)	//Edit----------------------Dima  20.08.2015begin	record ORVc ORr;	row ORVc ORrw;	row StockMovVc SMrw;	boolean TrHs,testf;	integer rwcnt,i,j;	longint pos;	array string 255 aWarning;	string 10 str1,str2;	date sStartDate,sEndDate;		j=0;	pos = 0;	GetNextSubstring(RepSpec.Period2Str,pos,":",str1);	GetNextSubstring(RepSpec.Period2Str,pos,":",str2);	sStartDate = StringToDate(str1);	sEndDate = StringToDate(str2);		SMr.SerNr = NextSerNr("StockMovVc",CurrentDate,-1,false,"");	SMr.FrLocation = RepSpec.f1;	SMr.ToLocation = RepSpec.f2;			ORr.OrdDate = sStartDate;	TrHs = true;	While(LoopKey("OrdDate",ORr,1,TrHs)) begin		testf = true;		if (ORr.OrdDate > sEndDate) then begin TrHs = false; testf=false; end;		if (RepSpec.f2 != ORr.Location) then begin testf=false; end;		if (ORr.OKFlag>0 or ORr.Closed>0 or ORr.Reserved==0) then begin testf=false; end;				if (testf) then begin				rwcnt = MatRowCnt(ORr);			for(i=0;i<rwcnt;i=i+1)  begin				MatRowGet(ORr,i,ORrw);				if (ORrw.OrderQuant - ORrw.ProcessingQuant > 0) then begin								LogText(0,"logistics creation: " & SMr.SerNr & "  OR:" & ORr.SerNr & "  code " & ORrw.ArtCode & "  ord:" & ORrw.OrderQuant & "  proc:" & ORrw.ProcessingQuant);									SMrw.ArtCode = ORrw.ArtCode;					SMrw.OrdQuant = ORrw.OrderQuant - ORrw.ProcessingQuant;					//SMrw.OrderProcessing =  SMrw.OrdQuant;					SMrw.ORSerial = ORr.SerNr;					SMrw.ORRowUID = ORrw.UID;					MatRowPut(SMr,j,SMrw);					StockMovVc_PasteArtCode(SMr,j,1,aWarning);					j=j+1;				end;						end;				end;	end;end;global updating procedure ReSaveORVcMn()	//Edit----------------------Dima  28.08.2015begin	record ORVc ORr, oldORr;		While(LoopMain(ORr,1,true)) begin		RecordStore(ORr,true);//  	RecordUpdate(oldORr,ORr,true);  end;  end;global updating procedure UpdateLastShipDateMn()//Edit----------------------Dima  31.08.2015begin	record ORVc ORr;	record SHVc SHr,SHprev;	date lastShipDate;	boolean TrHs;	longint previousOrder;	TrHs = true;		While(LoopKey("OrderKey",SHr,1,TrHs)) begin		if(SHr.OrderNr != previousOrder) then begin				 ORr.SerNr = previousOrder;				 if (ReadFirstMain(ORr,1,true)) then begin						ORr.LastShipDate = lastShipDate;						RecordStore(ORr,true);				 end;				 previousOrder = SHr.OrderNr;				 lastShipDate = ""; 		end;				if (SHr.ShipOkDate > lastShipDate) then begin			lastShipDate = SHr.ShipOkDate;		end;	end;  end;/* updating procedure SetORStatusFinished2(record IPVc IPr)	//Edit----------------------Dima  24.09.2015begin  record ORVc ORr,oldORr;  record ARVc ARr;	record IVVc IVr,IV1r;  row IPVc IPrw;	val orderedSum;	integer rwcnt,i;	Boolean TrHs;	longint serialNr;			rwcnt = MatRowCnt(IPr);		for(i=0;i<rwcnt;i=i+1) begin		MatRowGet(IPr,i,IPrw);		if (nonblank(IPrw.InvoiceNr)) then begin			orderedSum = 0;			TrHs = true;			IV1r.SerNr = IPrw.InvoiceNr;			ReadFirstMain(IV1r,1,true);			serialNr = IV1r.OrderNr;						IVr.OrderNr = serialNr;			While(LoopKey("OrderNr",IVr,1,TrHs)) begin				if(IVr.OrderNr != serialNr) then begin TrHs = false; end;				ARr.InvoiceNr = IVr.SerNr;				if (ReadFirstMain(ARr,1,true)) then begin 					if (ARr.RVal>0) then begin TrHs = false; end;				end; //ARVc exist if only ARr.RVal>0 (invoice is open)								if (TrHs) then begin					orderedSum = orderedSum + IVr.Sum4;				end;			end;			ResetLoop(IVr);						ORr.SerNr = serialNr;			if (ReadFirstMain(ORr,1,true)) then begin				if (ORr.Sum4 == orderedSum and ORr.CustomStatusFlag<9) then begin       			ORr.CustomStatusFlag = 9; //order is finished;      			Recalculate_CustomStatusFlagText(ORr);      			RecordStore(ORr,true);				end;				end;							end;		end;	end;*/global updating procedure RecalculateORStatusFinishedMn()		//Edit----------------------Dima  18.02.2016beginrecord ORVc ORr,oldORr;record IVVc IVr;record ARVc ARr;record SHVc SHr;boolean testf,TrHs;val allowableDebt,allowableDebtUSD,debt,orderedSum;integer count;	allowableDebt = 10;	allowableDebtUSD = 1;	while(LoopMain(ORr,1,true)) begin		testf = false;		if (ORr.CustomStatusFlag==6 or ORr.CustomStatusFlag==7 or ORr.CustomStatusFlag==8) then begin testf = true; end;		if (ORr.Closed!=0) then begin testf = false; end;				if (testf) then begin			debt = 0;			orderedSum = 0;			TrHs = true;			IVr.OrderNr = ORr.SerNr;			While(LoopKey("OrderNr",IVr,1,TrHs)) begin				if(IVr.OrderNr != ORr.SerNr) then begin TrHs = false; end;				if (TrHs) then begin					orderedSum = orderedSum + IVr.Sum4;									ARr.InvoiceNr = IVr.SerNr;					if (ReadFirstMain(ARr,1,true)) then begin 						if (AbsoluteVal(ARr.RVal)>allowableDebt) then begin							TrHs = false; debt = debt + ARr.RVal;						end else begin							debt = debt + ARr.RVal;						end;					end;				end;			end;			ResetLoop(IVr);						if ((ORr.CurncyCode == "USD" and debt<allowableDebtUSD) or (Left(ORr.CurncyCode,3)=="UAH" and AbsoluteVal(debt)<allowableDebt)) then begin										SHr.OrderNr = ORr.SerNr;				if (ReadFirstKey("OrderKey",SHr,1,true)) then begin					if (SHr.OKFlag!=0  and ORr.Sum4 == orderedSum) then begin							LogText(0,ORr.SerNr & "   fl " & ORr.CustomStatusFlag & "   " & debt & "   sums " & ORr.Sum4 & "  ++  " & orderedSum);							RecordCopy(oldORr,ORr);      				ORr.CustomStatusFlag = 9; //order is finished;      				Recalculate_CustomStatusFlagText(ORr);      				if (RecordStore(ORr,true)) then begin      					      					LogText(0,ORr.SerNr & "  class " & ORr.OrderClass & "    cur " & ORr.CurncyCode & "   debt " & debt);      					count = count + 1;      				end;					end;				end;						end;		end;	end;  		LogText(0,count & "  records has received Finish status");	end;updating procedure SetNewStatusesORVc(var record ORVc ORr)	//Edit----------------------Dima  24.09.2015beginrecord IVVc IVr;record SHVc SHr;  if (ORr.Reserved!=0) then begin		ORr.CustomStatusFlag = 1;	//Edit----------------------Dima  22.09.2015	end;	if (CheckORVcConfirmStatus(ORr)) then begin		ORr.CustomStatusFlag = 2;	end;  if(ORr.FeedBackStatus==1 or ORr.FeedBackStatus==2) then begin  		ORr.CustomStatusFlag = 3;		//Edit----------------------Dima  22.09.2015  end;     IVr.OrderNr = ORr.SerNr;  SHr.OrderNr = ORr.SerNr;  if (ReadFirstKey("OrderKey",SHr,1,true)) then begin  	if (ReadFirstKey("OrderNr",IVr,1,true)) then begin  			if (IVr.OKFlag!=0) then begin  				ORr.CustomStatusFlag = 5;  				if (SHr.OKFlag!=0) then begin        		ORr.CustomStatusFlag = 6;      								if (SHr.NPStatus == USetStr(31120)) then begin	//sent							ORr.CustomStatusFlag = 7;						end;						if (SHr.NPStatus == USetStr(31063)) then begin //received							ORr.CustomStatusFlag = 8;						end;							if (SHr.NPStatus == USetStr(31121)) then begin //delivered to the warehouse							ORr.CustomStatusFlag = 8;						end;         							end;								end;  	  	end;  end;	 	end;global updating procedure SetNewStatusesORVcMn()		//Edit----------------------Dima  24.09.2015begin	record ORVc ORr;record IPVc IPr;	While(LoopMain(ORr,1,true)) begin			switch(ORr.CustomStatusFlag) begin				case 0: ORr.CustomStatusFlag = 0;				case 1: SetNewStatusesORVc(ORr);				case 2: SetNewStatusesORVc(ORr);				case 3: ORr.CustomStatusFlag = 9;				case 4: ORr.CustomStatusFlag = 10;				case 5: ORr.CustomStatusFlag = 10;			end;			Recalculate_CustomStatusFlagText(ORr);			RecordStore(ORr,true);	end;		//set status "finished" for old orders	//While(LoopMain(IPr,1,true)) begin	//	SetORStatusFinished2(IPr);	//end;	  end;global updating procedure FixItemHistMn()begin	record ItemHistVc IHr;			while(loopkey("ActiveQty",IHr,1,true))begin		if((IHr.TotCostPrice/IHr.Qty*IHr.RemQty-IHr.RemCostPrice)>0.001 or (IHr.TotCostPrice/IHr.Qty*IHr.RemQty-IHr.RemCostPrice)<-0.001)then begin			IHr.RemCostPrice = IHr.TotCostPrice/IHr.Qty*IHr.RemQty;			recordstore(IHr,true);			logtext(0,IHr.FileName & " " & IHr.TransNr & " " & IHr.TotCostPrice/IHr.Qty*IHr.RemQty-IHr.RemCostPrice);		end;	end;return;end;global updating procedure FixRecordLinkMn(record RcVc RepCpec)begin	record ORVc ORr;	record SHVc SHr;	record IVVc IVr;	row IVVc IVrw;	record StockMovVc SMr;	row StockMovVc SMrw;	record PUVc PUr;	record POVc POr;	record VIVc VIr;	record RetPUVc RetPUr;	record RetVc Retr;	record IPVc IPr;	row IPVc IPrw;	record SMSstackVc SMSr;	integer i;	boolean TrHs;		/*		while(loopmain(SHr,1,true))begin		if(SHr.OrderNr>-1)then begin			ORr.SerNr = SHr.OrderNr;			if(readfirstmain(ORr,1,true))then begin				CreateRecordLink(SHr,CurrentCompany,ORr,CurrentCompany);				CreateRecordLink(ORr,CurrentCompany,SHr,CurrentCompany);			end;		end;	end;			while(loopmain(IVr,1,true))begin		if(IVr.OrderNr>-1)then begin			ORr.SerNr = IVr.OrderNr;			if(readfirstmain(ORr,1,true))then begin				CreateRecordLink(IVr,CurrentCompany,ORr,CurrentCompany);				CreateRecordLink(ORr,CurrentCompany,IVr,CurrentCompany);			end;		end;	end;	ResetLoop(IVr);		while(loopmain(PUr,1,true)) begin		if(PUr.PONr>-1) then begin			POr.SerNr = PUr.PONr;			if(readfirstmain(POr,1,true))then begin				CreateRecordLink(PUr,CurrentCompany,POr,CurrentCompany);				CreateRecordLink(POr,CurrentCompany,PUr,CurrentCompany);			end;		end;	end;				while(loopmain(VIr,1,true)) begin		if(VIr.POSerNr>-1) then begin			POr.SerNr = VIr.POSerNr;			if(readfirstmain(POr,1,true))then begin				CreateRecordLink(VIr,CurrentCompany,POr,CurrentCompany);				CreateRecordLink(POr,CurrentCompany,VIr,CurrentCompany);			end;		end;	end;	ResetLoop(VIr);				//--------------------   SHVc <--> RetVc <--> Credit IVVc   ----------------------------------------//		while(loopmain(Retr,1,true)) begin		if(Retr.SHNr>-1) then begin			SHr.SerNr = Retr.SHNr;			if(readfirstmain(SHr,1,true))then begin				CreateRecordLink(Retr,CurrentCompany,SHr,CurrentCompany);				CreateRecordLink(SHr,CurrentCompany,Retr,CurrentCompany);			end;		end;	end;			while(loopmain(IVr,1,true)) begin		if (MatRowCnt(IVr)>0) then begin			MatRowGet(IVr,0,IVrw);			if (IVrw.stp==kInvoiceRowTypeCredit and IVr.OrderNr>-1) then begin				Retr.OrdNr = IVr.OrderNr;				if(ReadFirstKey("OrdNr",Retr,1,true))then begin					CreateRecordLink(Retr,CurrentCompany,IVr,CurrentCompany);					CreateRecordLink(IVr,CurrentCompany,Retr,CurrentCompany);				end;			end;		end;		end;	ResetLoop(IVr);	//------------------------------------------------------------------------------------------////--------------------   PUVc <--> RetPUVc <--> Credit VIVc   ----------------------------------------//	while(loopmain(RetPUr,1,true)) begin		if(RetPUr.PUNr>-1) then begin			PUr.SerNr = RetPUr.PUNr;			if(readfirstmain(PUr,1,true))then begin				CreateRecordLink(RetPUr,CurrentCompany,PUr,CurrentCompany);				CreateRecordLink(PUr,CurrentCompany,RetPUr,CurrentCompany);			end;		end;	end;			while(loopmain(VIr,1,true)) begin		if (VIr.PayDeal=="CR") then begin						RetPUr.PONr = VIr.POSerNr;				if(readfirstKey("PONr",RetPUr,1,true)) then begin					CreateRecordLink(RetPUr,CurrentCompany,VIr,CurrentCompany);					CreateRecordLink(VIr,CurrentCompany,RetPUr,CurrentCompany);				end;		end;	end;	ResetLoop(VIr);	//---------------------------------------------------------------------------------------------------/				While(LoopMain(SMSr,1,true)) begin		switch (SMSr.SourceType) begin			case "ORVc":				ORr.SerNr = SMSr.SourceSerNr;				if (ReadFirstMain(ORr,1,true)) then begin					CreateRecordLink(ORr,CurrentCompany,SMSr,CurrentCompany);				end;						case "SHVc":				SHr.SerNr = SMSr.SourceSerNr;				if (ReadFirstMain(SHr,1,true)) then begin					CreateRecordLink(SHr,CurrentCompany,SMSr,CurrentCompany);				end;			end;	end;		*/	//----------------- Links IPVc <-- ORVc . Prepayments, when delivery by Nova Poshta -------------/			While(LoopMain(IPr,1,true)) begin		if (MatRowCnt(IPr)>3) then begin		//many paymnents, web-shop		for(i=0;i<MatRowCnt(IPr);i=i+1) begin			MatRowGet(IPr,i,IPrw);			if (nonblank(IPrw.InvoiceNr)) then begin				IVr.SerNr = IPrw.InvoiceNr;				if (ReadFirstMain(IVr,1,true)) then begin					ORr.SerNr = IVr.OrderNr;					if (ReadFirstMain(ORr,1,true)) then begin						if (ORr.PrepaymentReceived!=0) then begin																CreateRecordLink(ORr,CurrentCompany,IPr,CurrentCompany);						end;					end;				end;			end;		end;			end;	end;					//--------------------     Links for logistics      ----------------------------------------/	SMr.ToLocation = "RYBRAY";	TrHs = true;	While(LoopKey("ToLocOK",SMr,1,TrHs)) begin	if (SMr.ToLocation!="RYBRAY") then begin TrHs = false; end;		if (TrHs) then begin			CreateLinksToOrders(SMr);		end;		end;	return;end;global updating procedure FixPOSMn(record RcVc RepCpec)begin	record ItemStatusVc ISr;	record PISVc PISr,PIS2r,PIS3r;	boolean TrHs,testf;			ISr.Location = "1-KOC";	TrHs = true;	while(loopkey("Location",ISr,1,TrHs))begin		if(ISr.Location!="1-KOC")then begin TrHs = false; end;				if(TrHs)then begin			PIsr.ArtCode = ISr.Code;			PISr.Location = "1-KOC";			PISr.Position = "Ž‘’_3";			if(readfirstkey("Position",PISr,3,true))then begin				PIS2r.Location = "1-KOC";				PIS2r.Position = "ŠŽ‘_2";				PIS2r.ArtCode = PISr.ArtCode;				PIS2r.Instock = ISr.Instock - PISr.Instock;				PIS2r.LeftQty = PIS2r.Instock;				recordstore(PIS2r,true);				PIS2r.Location = ";;;";				PIS2r.Position = "ŠŽ‘_2";				PIS2r.ArtCode = PISr.ArtCode;				PIS2r.Instock = ISr.Instock;				PIS2r.LeftQty = PIS2r.Instock;				recordstore(PIS2r,true);				//LogText(0,PISr.ArtCode);			end else begin				PIS2r.Location = "1-KOC";				PIS2r.Position = "ŠŽ‘_2";				PIS2r.ArtCode = ISr.Code;				PIS2r.Instock = ISr.Instock;				PIS2r.LeftQty = PIS2r.Instock;				recordstore(PIS2r,true);				PIS2r.Location = ";;;";				PIS2r.Position = "ŠŽ‘_2";				PIS2r.ArtCode = ISr.Code;				PIS2r.Instock = ISr.Instock;				PIS2r.LeftQty = PIS2r.Instock;				recordstore(PIS2r,true);			end;				end;			end;		return;end;function Integer FindERecordStatus(string filename,Integer status,string custid,LongInt ivnr,var string reason)BEGIN  Integer res;  record ERecordStatusVc ERSr;    res = -1;  ERSr.FileName = filename;  ERSr.Status = status;  ERSr.CustID = custid;  ERSr.CustSerNr = ivnr;  if (ReadLastKey("FileNameStatus",ERSr,4,true)) then begin    res = status;    if (ERSr.FileName!=filename) then begin res = -1; end;    if (ERSr.Status!=status) then begin res = -1; end;    if (ERSr.CustID!=custid) then begin res = -1; end;    if (StringToLongInt(ERSr.CustSerNr)!=ivnr) then begin res = -1; end;    if (res>=0) then begin      reason = ERSr.Comment;    end;      end;  FindERecordStatus = res;  RETURN; END;procedure PrintERecordStatus(LongInt ivnr,string custcode)BEGIN  record InternetEnablerBlock IEb;  Integer status;  string 255 reason;      BlockLoad(IEb);  status = -1;  status = FindERecordStatus("IVVc",1,IEb.CustomerCode,ivnr,reason);  if (status==-1) then begin    status = FindERecordStatus("IVVc",0,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin    status = FindERecordStatus("IVVc",6,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin    status = FindERecordStatus("IVVc",5,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin    status = FindERecordStatus("IVVc",4,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin    status = FindERecordStatus("IVVc",3,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin    status = FindERecordStatus("IVVc",2,IEb.CustomerCode,ivnr,reason);  end;  if (status==-1) then begin//for old wrong record statusess      status = FindERecordStatus("IVVc",1,custcode,ivnr,reason);    if (status==-1) then begin      status = FindERecordStatus("IVVc",0,custcode,ivnr,reason);    end;    if (status==-1) then begin      status = FindERecordStatus("IVVc",6,custcode,ivnr,reason);    end;    if (status==-1) then begin      status = FindERecordStatus("IVVc",5,custcode,ivnr,reason);    end;    if (status==-1) then begin      status = FindERecordStatus("IVVc",4,custcode,ivnr,reason);    end;    if (status==-1) then begin      status = FindERecordStatus("IVVc",3,custcode,ivnr,reason);    end;    if (status==-1) then begin      status = FindERecordStatus("IVVc",2,custcode,ivnr,reason);    end;  end;  if (status>=0) then begin    OutString(40,0,USetStr(20220+status),false);    OutString(200,0,reason,false);  end;  RETURN; END;procedure PrintAccruals(record IVVc IVp)begin  record SMVc SMr;  record TRVc TRr;  record RLinkVc RLinkr;  Integer notenr;  string 255 tstr;  notenr = 1;  while (ReadRecordLink(IVp,notenr,SMr,RLinkr)) begin    StartFormat(15);     OutString(20,0,USetStr(11370),false);    EndFormat;        Gray_Divider(0,200);    StartFormat(15);     OutString(20,0,USetStr(1154),false);     OutLongInt(100,"DblSMVc",SMr.SerNr,false);     OutVal(380,0,SMr.DSum,M4Val,true);    EndFormat;        notenr = notenr + 1;    goto LSMEND;  end;LSMEND:;    notenr = 1;  while (ReadRecordLink(IVp,notenr,TRr,RLinkr)) begin    StartFormat(15);     OutString(20,0,USetStr(11371),false);     TRExtYc(TRr,tstr);     OutString(100,"DblTrans",tstr,false);     OutVal(450,0,TRr.DSum,M4Val,true);    EndFormat;        notenr = notenr + 1;  end;  RETURN;END;procedure RepShipments(record IVVc IVr)BEGIN  record SHVc SHr;  Boolean TrHs,headerf;    headerf = true;  TrHs = true;  SHr.SerNr = -1;  SHr.OrderNr = IVr.OrderNr;  while (LoopKey("OrderKey",SHr,1,TrHs)) begin    if (SHr.OrderNr<>IVr.OrderNr) then begin TrHs = false; end;    if (TrHs) then begin      if (headerf) then begin        Gray_Divider(0,1);        StartFormat(15);         OutString(0,0,USetStr(1334),false);        EndFormat;        StartFormat(15);         OutString(15,0,USetStr(5042),false);         OutString(130,0,USetStr(5043),false);         OutString(220,0,USetStr(7582),false);         OutString(330,0,USetStr(5047),true);        EndFormat;        headerf = false;      end;      StartFormat(15);       OutLongInt(15,"IVInfoSH",SHr.SerNr,false);       OutDate(130,0,SHr.ShipDate,false);       OutString(220,0,SHr.Location,false);       OutVal(330,0,SHr.TotQty,M4Qty,true);      EndFormat;    end;  end;  RETURN;END;// This layout is really uglyprocedure RepOrders(record IVVc IVr)BEGIN  record ORVc ORr;    ORr.SerNr = IVr.OrderNr;  if (ReadFirstMain(ORr,1,true)) begin    Gray_Divider(0,1);    StartFormat(15);    OutString(0,0,USetStr(5123),false);    EndFormat;    StartFormat(15);    OutString(15,0,USetStr(5042),false);    OutString(130,0,USetStr(5043),false);    OutString(220,0,USetStr(7582),false);    OutString(330,0,USetStr(5047),true);    EndFormat;    StartFormat(15);    OutLongInt(15,"DblORVc",ORr.SerNr,false);    OutDate(130,0,ORr.OrdDate,false);    OutString(220,0,ORr.Location,false);    OutVal(330,0,ORr.TotQty,M4Qty,true);    EndFormat;  end;  RETURN;END;procedure RepInvoice(record IVVc IVr,Integer com)begin  row IVVc IVrw;  string 255 tstr,t2;  Integer i,rwcnt;  val qty,sum1,sum3,totweight,t;  record INVc INr;  Boolean testf;  qty = 0;  totweight = 0;  StartFormat(15);  OutString(0,"DblIVVc",CreateInvoiceNumber(IVr.SerNr,IVr.OfficialSerNr),false);  tstr = "";  if (IVr.InvType==kInvoiceTypeNormal or IVr.InvType==kInvoiceTypeNormalSpecialSales) then begin    tstr = USetStr(1803);  end;  if (IVr.InvType==kInvoiceTypeCash or IVr.InvType==kInvoiceTypeCashInvoiceReceiptPRT) then begin    tstr = USetStr(1804);  end;  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin    tstr = USetStr(1805);  end;  if (IVr.InvType==kInvoiceTypeInterest) then begin    tstr = USetStr(1810);  end;  if (IVr.InvType==kInvoiceTypeDebit) then begin    tstr = USetStr(23250);  end;  if (IVr.InvType==kInvoiceTypePrepayment) then begin    tstr = USetStr(1806);  end;  if (IVr.InvType==kInvoiceTypeDownpayment) then begin    tstr = USetStr(1818);  end;  OutString(50,0,tstr,false);  OutDate(130,0,IVr.InvDate,false);  OutString(220,"DblCUVc",IVr.CustCode,false);  OutString(270,0,IVr.pdComment,false);  OutLongInt(350,0,IVr.OrderNr,false);  if (IVr.OKFlag==0) then begin    OutString(480,0,USetStr(2366),true);  end;  EndFormat;  StartFormat(15);  OutString(50,0,IVr.CustCat,false);  OutDate(130,0,IVr.PayDate,false);  OutString(220,0,IVr.Addr0,false);  EndFormat;  testf = true;  if (nonblank(IVr.Addr1)) or (nonblank(IVr.OfficialSerNr)) then begin    StartFormat(15);    if (Left(BuildProductCode,8)=="Standard" or (Left(BuildProductCode,6)=="WeHave")) then begin      if (HasLocalization("POL")) then begin        testf = false;      end;    end;    if (testf) then begin      OutString(130,0,IVr.OfficialSerNr,false);    end;    OutString(220,0,IVr.Addr1,false);    EndFormat;  end;  StartFormat(15);  OutString(50,0,IVr.OurContact,false);  OutString(220,0,IVr.Addr2,false);  EndFormat;  if (IVr.Addr3<>"") then begin    StartFormat(15);    OutString(220,0,IVr.Addr3,false);    EndFormat;  end;  if (IVr.ClientContact<>"") then begin    StartFormat(15);    OutString(220,0,IVr.ClientContact,false);    EndFormat;  end;  if (HasLocalization("PRT")) then begin     StartFormat(15);    if (IVr.IPBookVAT!=0) then begin       tstr = "  [X]";    end else begin      tstr = "  [ ]";    end;    OutString(130,0,USetStr(33709),true);    OutString(130,0,tstr,false);    EndFormat;    StartFormat(15);    if (IVr.ThirdPartyBillMark!=0) then begin       tstr = "  [X]";    end else begin      tstr = "  [ ]";    end;    OutString(130,0,USetStr(33710),true);    OutString(130,0,tstr,false);    EndFormat;      end;    if (IVr.CurncyCode<>"") then begin    StartFormat(15);    OutString(460,0,IVr.CurncyCode,true);    EndFormat;  end;  rwcnt = MatRowCnt(IVr);  for (i=0;i<rwcnt;i=i+1) begin    MatRowGet(IVr,i,IVrw);    INr.Code = IVrw.ArtCode;    if (ReadFirstMain(INr,1,true)) then begin            t = INr.Weight * IVrw.Quant;            if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin        totweight = totweight - t;      end else begin        totweight = totweight + t;      end;      end;    if (IVrw.stp==3) then begin      StartFormat(15);      t2 = USetStr(1807);      tstr = CreateInvoiceNumber(IVrw.OrdRow,IVrw.CredOfficialSerNr);      t2 = t2 & tstr;      OutString(130,0,t2,false);      EndFormat;    end;    if ((IVrw.stp==kInvoiceRowTypeNormal) or (IVrw.stp==kInvoiceRowTypeStructuredItemComponent) or (IVrw.stp==4)) then begin      StartFormat(15);      qty = qty + IVrw.Quant;      OutString(20,0,IVrw.ArtCode,false);      OutVal(104,0,IVrw.Quant,M4UVal,true);      OutString(110,0,IVrw.Spec,false);      OutVal(350,0,IVrw.Price,M423Val,true);      OutVal(380,0,IVrw.vRebate,M41Val,true);      OutVal(460,0,IVrw.Sum,M4Val,true);      OutString(480,0,IVrw.VATCode,true);      EndFormat;    end;    if (IVrw.stp==5) then begin      StartFormat(15);      OutString(20,0,USetStr(4869),false);      OutString(130,0,IVrw.Spec,false);      OutVal(460,0,IVrw.Sum,M4Val,true);      OutString(480,0,IVrw.VATCode,true);      EndFormat;    end;  end;  if (IVr.FrPrice<>0) then begin    StartFormat(15);    OutString(20,0,IVr.FrItem,false);    OutString(104,0,"1",true);    OutVal(350,0,IVr.FrPrice,M4Val,true);    OutVal(460,0,IVr.FrPrice,M4Val,true);    OutString(480,0,IVr.FrVATCode,true);    EndFormat;  end;  Black_Divider(380,460);  StartFormat(15);  if (IVr.ExportFlag!=0) then begin    OutString(20,0,USetStr(2367),false);  end;  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin    sum1 = -IVr.Sum1;    sum3 = -IVr.Sum3;  end else begin    sum1 = IVr.Sum1;    sum3 = IVr.Sum3;  end;  if (IsBooks) and (ValuePack(1)==false) then begin    OutString(104,0,USetStr(2645),true);    OutString(230,0,USetStr(6707),true);    OutVal(460,0,sum1,M4Val,true);//280  end else begin    OutString(60,0,USetStr(6766),true);    OutString(104,0,USetStr(2645),true);    OutString(150,0,USetStr(3185),false);    OutString(240,0,USetStr(6707),true);    OutVal(460,0,sum1,M4Val,true);//280  end;  EndFormat;  StartFormat(15);  if (IsBooks) and (ValuePack(1)==false) then begin    OutVal(104,0,qty,M4UVal,true);    OutVal(230,0,sum3,M4Val,true);  end else begin    OutVal(60,0,totweight,M4Qty,true);    OutVal(104,0,qty,M4UVal,true);    OutString(150,0,IVr.Objects,false);    OutVal(240,0,sum3,M4Val,true);  end;  EndFormat;  if (com<>0) then begin    if (nonblank(IVr.InvComment)) then begin      StartFormat(15);      OutString(0,0,IVr.InvComment,false);      EndFormat;    end;  end;  RepOrders(IVr);  RepShipments(IVr);  return;end;function val FindPaidValueOnInvoice(record IVVc IVr)BEGIN  val res;  row IVVc IVrw;  Integer i,rwcnt;    if ((IVr.RetnValue>0 and IVr.Sum4>0) or (IVr.RetnValue<0 and IVr.Sum4<0)) and (IVr.InvType!=kInvoiceTypeCredit) then begin    res = res - IVr.RetnValue;  end;    rwcnt = MatRowCnt(IVr);  for (i=0;i<rwcnt;i=i+1) begin    MatRowGet(IVr,i,IVrw);    switch (IVrw.stp) begin      case kInvoiceRowTypeChequePayment: res = res + IVrw.Sum;      case kInvoiceRowTypeCreditCardPayment: res = res + IVrw.Sum;      case kInvoiceRowTypeCashPayment: res = res + MulRateToBase1(IVrw.CurncyCode,IVrw.Sum,IVrw.FrRate,IVrw.ToRateB1,IVrw.ToRateB2,IVrw.BaseRate1,IVrw.BaseRate2,DefaultCurRoundOff);      case kInvoiceRowTypeLoyaltyPointsPayment: res = res + MulRateToBase1(IVrw.CurncyCode,IVrw.Sum,IVrw.FrRate,IVrw.ToRateB1,IVrw.ToRateB2,IVrw.BaseRate1,IVrw.BaseRate2,DefaultCurRoundOff);      case kInvoiceRowTypeGiftVoucherPayment: res = res + IVrw.Sum;    end;  end;  FindPaidValueOnInvoice = res;  RETURN;END;global updating procedure RecalcARMn(record RcVc RepSpec)begin	record ARVc ARr;	record IVVc theIVr;  record IVVc IVr;  record IPVc IPr;  record PurgeTRVc PurgeTRr;    record TRVc TRr;    record CLInVc CLInr;  record CLOutVc CLOutr;  record CredManVc CredManr;  row IPVc IPrw;  row TRVc TRrw;  row CLInVc CLInrw;  row CLOutVc CLOutrw;  Integer typeofcur,oldstyle,kregister;  Integer i,rwcnt;  Boolean found,testf;  record IPrsVc IPrsr;  string 255 tstr,t2;  val bal,temp,balb1;  Integer rw;  val ppval,cashv;    val kurs;		while(loopMain(ARr,1,true)) begin						bal = 0;		temp = 0;		balb1 = 0;		ppval = 0;		cashv = 0;				IPrsr.IVNr = ARr.InvoiceNr;		theIVr.SerNr = ARr.InvoiceNr;		readfirstmain(theIVr,1,true);		found = true;		resetloop(IPrsr);		while (LoopKey("IVKey",IPrsr,1,found)) begin			if (IPrsr.IVNr<>ARr.InvoiceNr) then begin found = false; end;			if (found) then begin				if (IPrsr.TransType==kIPrsTransTypeInvoice) then begin/* invoice */					IVr.SerNr = IPrsr.TransNr;					if (ReadFirstMain(IVr,1,true)) then begin						if (IVr.Invalid==0) then begin							if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin								tstr = USetStr(1324);							end else begin								tstr = USetStr(1150);							end;							tstr = tstr & ":";							t2 = CreateInvoiceNumber(IVr.SerNr,IVr.OfficialSerNr);							tstr = tstr & t2;							StartFormat(15);							OutString(40,"DblLiquid",tstr,false);							OutDate(150,0,IVr.InvDate,false);							if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin								IVr.Sum4 = -IVr.Sum4;							end;  							ppval = 0;							cashv = 0;							OutVal(380,0,IVr.Sum4,M4Val,true);							switch (IVr.InvType) begin								case kInvoiceTypeCashInvoiceReceiptPRT:									goto LkInvoiceTypeCash;								case kInvoiceTypeCash:	LkInvoiceTypeCash:;              			//             bal = bal + IVr.Sum4;//balance for cash note is 0, nothing to be paid									ppval = bal;									ppval = ppval - bal;									bal = bal + ppval;									OutVal(480,0,bal,M4Val,true);								case kInvoiceTypeCreditSpecialSales: 									goto LkInvoiceTypeCredit;								case kInvoiceTypeCredit:	LkInvoiceTypeCredit:;									switch (theIVr.InvType) begin										case kInvoiceTypeCash:										otherwise											bal = bal + IVr.Sum4;											ppval = bal;											SubPrePayments(IVr,bal,balb1);											ppval = ppval - bal;											bal = bal + ppval;											OutVal(480,0,bal,M4Val,true);									end;								otherwise									bal = bal + IVr.Sum4;									ppval = bal;									SubPrePayments(IVr,bal,balb1);									ppval = ppval - bal;									bal = bal + ppval;									OutVal(480,0,bal,M4Val,true);							end;            							EndFormat;							if (ppval<>0) then begin								StartFormat(15);								OutString(150,0,USetStr(1875),false);								OutVal(380,0,ppval,M4NegVal,true);								bal = bal - ppval;								OutVal(480,0,bal,M4Val,true);								EndFormat;							end;							if (IVr.InvType!=kInvoiceTypeCash) then begin								if (IVr.SerNr==theIVr.SerNr) then begin									cashv = FindPaidValueOnInvoice(IVr);                     								end;							end;							if (cashv<>0) then begin								StartFormat(15);								OutString(150,0,USetStr(6768),false);								OutVal(380,0,cashv,M4NegVal,true);								if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin									bal = bal + cashv;								end else begin									bal = bal - cashv;								end;								OutVal(480,0,bal,M4Val,true);								EndFormat;							end;   						end;					end;				end;				if (IPrsr.TransType==kIPrsTransTypeReceipt) then begin/* receipt */      						IPr.SerNr = IPrsr.TransNr;						if (ReadFirstMain(IPr,1,true)) then begin							if (IPr.RejectedFlag==0) then begin								rwcnt = MatRowCnt(IPr);								for (i=0;i<rwcnt;i=i+1) begin									MatRowGet(IPr,i,IPrw);									testf = true;									if (IPrw.ovst!=0) then begin testf = false; end;									if (IPrw.InvoiceNr!=theIVr.SerNr) then begin testf = false; end;									switch (IPrw.stp) begin										case 5:										case 7: testf = false;										otherwise											if (IPrw.PayDate!=IPrsr.CustDate) then begin testf = false; end;									end;                               									if (testf) then begin										tstr = USetStr(1151);										tstr = tstr & ":";										t2 = IPr.SerNr;										tstr = tstr & t2;										StartFormat(15);										OutString(40,"DblLiquid",tstr,false);										OutDate(150,0,IPrw.PayDate,false);										if (IPrw.stp==5) then begin											OutString(220,0,USetStr(2449),false);										end;										if (IPrw.stp==6) then begin											OutString(220,0,USetStr(2451),false);										end;										IPrw.InvVal = -IPrw.InvVal;										OutVal(380,0,IPrw.InvVal,M4Val,true);										bal = bal + IPrw.InvVal;										OutVal(480,0,bal,M4Val,true);										EndFormat;									end;								end;							end;						end;				end;   				if (IPrsr.TransType==kIPrsTransTypePurgeNLTransaction) then begin/*NL receipt */              						PurgeTRr.Number = IPrsr.TransNr;						PurgeTRr.IntYc = GetIntYc(IPrsr.TransDate);						PurgeTRr.TransRow = IPrsr.TransRow;						if (ReadFirstMain(PurgeTRr,3,true)) then begin            							if (PurgeTRr.Typ==1) then begin								testf = false;								if (PurgeTRr.CredVal<>0) then begin									if ((PurgeTRr.SerNr==theIVr.SerNr) and											(PurgeTRr.TransDate==IPrsr.CustDate)) then begin										tstr = USetStr(2530);										tstr = tstr & ":";										testf = true;										PurgeTRExtYc(PurgeTRr,t2);										tstr = tstr & t2;										if (PurgeTRr.CurCredVal<>0) then begin											temp = -PurgeTRr.CurCredVal;										end else begin											typeofcur = TypeOfCurncy(PurgeTRr.Curncy,oldstyle);   											if (typeofcur==2) then begin												temp = -PurgeTRr.CredVal2;											end else begin												temp = -PurgeTRr.CredVal;											end;										end;									end;								end;								if (PurgeTRr.DebVal<>0) then begin									if ((PurgeTRr.SerNr==theIVr.SerNr) and											(PurgeTRr.TransDate==IPrsr.CustDate)) then begin										tstr = USetStr(2530);										tstr = tstr & ":";										testf = true;										PurgeTRExtYc(PurgeTRr,t2);										tstr = tstr & t2;										if (theIVr.InvType!=3) then begin											if (nonblank(PurgeTRr.CurDebVal)) then begin												temp = PurgeTRr.CurDebVal;											end else begin												typeofcur = TypeOfCurncy(PurgeTRr.Curncy,oldstyle);   												if (typeofcur==2) then begin													temp = PurgeTRr.DebVal2;												end else begin													temp = PurgeTRr.DebVal;												end;											end;										end else begin											if (nonblank(PurgeTRr.CurDebVal)) then begin												temp = PurgeTRr.CurDebVal;											end else begin												typeofcur = TypeOfCurncy(PurgeTRr.Curncy,oldstyle);   												if (typeofcur==2) then begin													temp = PurgeTRr.DebVal2;												end else begin													temp = PurgeTRr.DebVal;												end;											end;										end;  									end;								end;                								if (testf) then begin									StartFormat(15);									 OutString(40,"DblLiquid",tstr,false);									 OutDate(150,0,PurgeTRr.TransDate,false);										OutVal(380,0,temp,M4Val,true);									 bal = bal + temp;									 OutVal(480,0,bal,M4Val,true);									EndFormat;                                								end;  							end;						end;				end;				if (IPrsr.TransType==kIPrsTransTypeNLTransaction) then begin/*NL receipt */              						TRr.Number = IPrsr.TransNr;						TRr.IntYc = GetIntYc(IPrsr.TransDate);						if (ReadFirstMain(TRr,2,true)) then begin            							rwcnt = MatRowCnt(TRr);							for (i=0;i<rwcnt;i=i+1) begin								MatRowGet(TRr,i,TRrw);								if (TRrw.Typ==1) then begin								testf = false;									if (TRrw.CredVal<>0) then begin										if ((TRrw.SerNr==theIVr.SerNr) and												(TRr.TransDate==IPrsr.CustDate)) then begin											tstr = USetStr(2530);											tstr = tstr & ":";											testf = true;											TRExtYc(TRr,t2);											tstr = tstr & t2;											if (TRrw.CurCredVal<>0) then begin												temp = -TRrw.CurCredVal;											end else begin												typeofcur = TypeOfCurncy(TRrw.Curncy,oldstyle);   												if (typeofcur==2) then begin													temp = -TRrw.CredVal2;												end else begin													temp = -TRrw.CredVal;												end;											end;										end;									end;									if (TRrw.DebVal<>0) then begin										if ((TRrw.SerNr==theIVr.SerNr) and												(TRr.TransDate==IPrsr.CustDate)) then begin											tstr = USetStr(2530);											tstr = tstr & ":";											testf = true;											TRExtYc(TRr,t2);											tstr = tstr & t2;											if (theIVr.InvType!=kInvoiceTypeCredit and theIVr.InvType!=kInvoiceTypeCreditSpecialSales) then begin												if (nonblank(TRrw.CurDebVal)) then begin													temp = TRrw.CurDebVal;												end else begin													typeofcur = TypeOfCurncy(TRrw.Curncy,oldstyle);   													if (typeofcur==2) then begin														temp = TRrw.DebVal2;													end else begin														temp = TRrw.DebVal;													end;												end;											end else begin												if (nonblank(TRrw.CurDebVal)) then begin													temp = TRrw.CurDebVal;												end else begin													typeofcur = TypeOfCurncy(TRrw.Curncy,oldstyle);   													if (typeofcur==2) then begin														temp = TRrw.DebVal2;													end else begin														temp = TRrw.DebVal;													end;												end;											end;  										end;									end;                									if (testf) then begin										StartFormat(15);										 OutString(40,"DblLiquid",tstr,false);										 OutDate(150,0,TRr.TransDate,false);											OutVal(380,0,temp,M4Val,true);										 bal = bal + temp;										 OutVal(480,0,bal,M4Val,true);										EndFormat;                                									end;  								end;							end;						end;				end;				if (IPrsr.TransType==kIPrsTransTypeCashIn) then begin/*cash in*/              						CLInr.SerNr = IPrsr.TransNr;						if (ReadFirstMain(CLInr,1,true)) then begin            							if (CLInr.Invalid==0) then begin								rwcnt = MatRowCnt(CLInr);								for (i=0;i<rwcnt;i=i+1) begin									MatRowGet(CLInr,i,CLInrw);									if (CLInrw.Type==1) then begin										testf = false;										if (CLInrw.Sum<>0) then begin											if ((CLInrw.TransNr==theIVr.SerNr) and													(CLInr.TransDate==IPrsr.CustDate)) then begin												tstr = USetStr(1193);												tstr = tstr & ":";												testf = true;												tstr = tstr & CLInr.SerNr;											end;										end;                										if (testf) then begin											temp = -CLInrw.Sum;											StartFormat(15);											 OutString(40,"DblLiquid",tstr,false);											 OutDate(150,0,CLInr.TransDate,false);												OutVal(380,0,temp,M4Val,true);											 bal = bal + temp;											 OutVal(480,0,bal,M4Val,true);											EndFormat;                                										end;									end;  								end;							end;						end;				end;				if (IPrsr.TransType==kIPrsTransTypeCashOut) then begin/*cash out*/              						CLOutr.SerNr = IPrsr.TransNr;						if (ReadFirstMain(CLOutr,1,true)) then begin            							if (CLOutr.Invalid==0) then begin							rwcnt = MatRowCnt(CLOutr);							for (i=0;i<rwcnt;i=i+1) begin								MatRowGet(CLOutr,i,CLOutrw);								if (CLOutrw.Type==1) then begin									testf = false;									if (CLOutrw.Sum<>0) then begin										if ((CLOutrw.TransNr==theIVr.SerNr) and												(CLOutr.TransDate==IPrsr.CustDate)) then begin											tstr = USetStr(1194);											tstr = tstr & ":";											testf = true;											tstr = tstr & CLOutr.SerNr;										end;									end;                									if (testf) then begin										temp = CLOutrw.Sum;										StartFormat(15);										 OutString(40,"DblLiquid",tstr,false);										 OutDate(150,0,CLOutr.TransDate,false);											OutVal(380,0,temp,M4Val,true);										 bal = bal + temp;										 OutVal(480,0,bal,M4Val,true);										EndFormat;                                									end;  								end;							end;							end;						end;				end;            				if (IPrsr.TransType==6) then begin/* credit man */      						CredManr.SerNr = IPrsr.TransNr;						if (ReadFirstMain(CredManr,1,true)) then begin							if (CredManr.Invalid==0) then begin								tstr = USetStr(1635);								tstr = tstr & ":";								t2 = CredManr.SerNr;								tstr = tstr & t2;								StartFormat(15);								OutString(40,"DblLiquid",tstr,false);								OutDate(150,0,CredManr.TransDate,false);								CredManr.InvSum4 = -CredManr.InvSum4;								OutVal(380,0,CredManr.InvSum4,M4Val,true);								bal = bal + CredManr.InvSum4;								OutVal(480,0,bal,M4Val,true);								EndFormat;							end;						end;				end;   						end;		end;				if(bal<0.01 and bal>-0.01)then begin			logtext(0,ARr.InvoiceNr);			recorddelete(ARr);			stepbaCK(ARr);		end else begin			if(bal!=ARr.RVal)then begin								if(left(ARr.ARCurncyCode,3)=="USD")then begin				ARr.BookRVal = bal;				end else begin					kurs = 1;					kurs = ARr.RVal/ARr.BookRVal;					ARr.BookRVal = bal/kurs;				end;				ARr.RVal = bal;				recordstore(ARr,true);				logtext(0,"disbal " & ARr.InvoiceNr);			end;				end;			end;		return;end;global updating procedure CleanRegisterMn(record RcVc RepSpec)		//Edit----------------------Dima  11.02.2016beginboolean TrHs;record PLHistVc PLHistr;  TrHs = true;  while (LoopMain(PLHistr,1,TrHs)) begin    if (TrHs) then begin      RecordDelete(PLHistr);      StepBack(PLHistr);   end;  end;return;end;