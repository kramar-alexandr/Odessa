external function roundmode SetRoundModeD(Integer);// Edit ************************** Monday, 13 October 2014 15:06:01external procedure RecalculateActOkFlag(var record POVc);	//Edit----------------------Dima  12.03.2015external procedure Recalculate_CustomStatusFlagText(var record ORVc); //Edit----------------------Dima  24.03.2015external function Boolean IsDigit(string);external procedure ExtractObj(string,var Integer,var string);global function CreateEAN128(var string str)beginstring 255 res,res1;integer ksum,sum,c,lenth,i;val csum;area arr;  res = "";  sum = 0;  res = res & chr(195) & chr(144);  sum = sum+103;  lenth = len(str);  for(i=0;i<lenth;i=i+1)begin    c = asc(mid(str,i,1));    c = c - 32;    sum = sum + c*(i+1);  end;  csum = sum/103;  if(csum<round(csum,SetRoundModeD(0))) then begin     ksum = round(csum,SetRoundModeD(0))-1;   end else begin    ksum = round(csum,SetRoundModeD(0));  end;  sum = sum-(ksum*103);  res = res & str;  if(sum<95) then begin    If(sum==0) then begin      res = res & chr(195) & chr(148);    end else begin      res = res & chr(sum+32);    end;    end else begin  res = res & chr(195) & chr(sum+41);  end;  //res = res & chr(211);  //res = res & chr(211);  res = res & chr(195) & chr(147);  addtexttoarea(res,arr);  writeareatofile(arr,"888",0);  str = res;return;end;global // Edit ************************** Monday, 13 October 2014 14:42:59procedure CalcEANCHS(var string str)begininteger c1,c2,lenth,i,chsum,litle;val sum;  sum = 0;  lenth = len(str);  if (lenth==12)then begin    for(i=0;i<12;i=i+2)begin      c1 = evaltoval(mid(str,i,1));      c2 = evaltoval(mid(str,i+1,1));      c2=c2*3;      sum = sum+c1+c2;    end;    if(round(sum/10,SetRoundModeD(0))>sum/10) then begin      litle = round(sum/10,SetRoundModeD(0))-1;    end else begin      litle = round(sum/10,SetRoundModeD(0));    end;    chsum  = 10-(10*(sum/10-litle));    if(chsum==10) then begin chsum = 0; end;    str = str & chsum;  end else begin    str = "";  end;  return;end;globalprocedure BarcodeIncrement(var string barcode,Integer increment)begin  integer lenght,i,lastindex,leftover,base,incr;  array integer digit;  boolean testf;        testf = true;    lenght = len(barcode);    incr = increment;    for (i=0;i<lenght;i=i+1) begin      digit[i] = StringToInt(mid(barcode,i,1));      lastindex = i;    end;    digit[lastindex] = digit[lastindex] + incr;    while (digit[lastindex]>9 and testf) begin      leftover = Mod(digit[lastindex],10);      base = digit[lastindex] - leftover;      if (base>0) then begin        digit[lastindex] = leftover;        incr = base/10;        lastindex = lastindex - 1;        digit[lastindex] = digit[lastindex] + incr;      end;      if (lastindex==0 and digit[lastindex]>9) then begin        testf = false;      end;    end;    barcode = "";    if (testf) then begin      for (i=0;i<lenght;i=i+1) begin        barcode = barcode & digit[i];      end;    end;   return; end;global  //Edit***************************Sasha2,12:00 22.01.2015 {updating procedure HandleSetEAN13PU(var record PUVc PUr)begin  row PUVc PUrw;  record INVc INr,IN2r;  integer mrcnt,i;  string 40 barcode,tempean;  boolean TrHs,testf;      mrcnt = MatRowCnt(PUr);    for (i=0;i<mrcnt;i=i+1) begin      MatRowGet(PUr,i,PUrw);      if (NonBlank(PUrw.ArtCode) and blank(PUrw.BarCode)) then begin        INr.Code = PUrw.ArtCode;        if (ReadFirstMain(INr,1,true)) then begin          if (NonBlank(INr.BarCode)) then begin            PUrw.BarCode = INr.BarCode;            MatRowPut(PUr,i,PUrw);          end else begin            IN2r.BarCode = "2";            TrHs = true;            testf = true;            if (blank(tempean)) then begin              while (LoopKey("BarCode",IN2r,1,TrHs)) begin                if (left(IN2r.BarCode,1)!="2") then begin TrHs = false; end;                if (Len(IN2r.BarCode)==13) then begin testf = false; end;                if (Len(IN2r.BarCode)!=13 and testf==false) then begin TrHs = false; end;                if (TrHs) then begin                  tempean = IN2r.BarCode;                end;              end; RESETLOOP(IN2r);            end;            if (tempean=="2999999999991") then begin              goto LHandleSetEAN13PU;            end;            if (blank(tempean) or left(tempean,1)!="2" or len(tempean)!=13) then begin              barcode = "199999999999";            end else begin              barcode = mid(tempean,0,12);            end;            BarcodeIncrement(barcode,1);            if (NonBlank(barcode)) then begin               CalcEANCHS(barcode);              INr.BarCode = barcode;              tempean = barcode;              RECORDSTORE(INr,true);              PUrw.BarCode = barcode;              MatRowPut(PUr,i,PUrw);            end else begin              goto LHandleSetEAN13PU;            end;          end;        end;      end;    end;    LHandleSetEAN13PU:;      return;end; //Edit***************************Sasha2,12:01 22.01.2015 }global updating procedure RecalcINVolumeMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record INVc INr;	roundmode rnd;			rnd = DefaultValRoundoff;  	rnd.decimals = 0;  	rnd.mode = kRoundingModeHalfUp;		INr.Code = "";	while(loopmain(INr,1,true))begin		if (INr.Volume > 0) then begin			//INr.Volume = Round(INr.Volume,rnd) / 100000; //Edit***************************Sasha2,17:25 30.07.2014			INr.Volume = INr.Volume / 1000; //Edit***************************Sasha2,11:24 31.07.2014			RECORDSTORE(INr, true);		end;	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global updating procedure DelLoyaltyCardMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record LoyaltyCardVc LoyaltyCardr;	Boolean TrHs;		LoyaltyCardr.SerNr = "";	TrHs = true;	while(loopmain(LoyaltyCardr,1,TrHs))begin		if (TrHs) then begin			RecordDelete(LoyaltyCardr);    		StepBack(LoyaltyCardr);		end;	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global updating procedure CleaningMn() //Edit------------------------------Dima,   24.12.2014begin	record CLInVc CLInr;	record CLOutVc CLOutr;	record IPVc IPr;	record OPVc OPr;	record IVVc IVr;	record VIVc VIr;	record POVc POr;	record SHVc SHr;	record PUVc PUr;	record SDVc SDr;	record StockMovVc StockMovr;	record RetVc Retr;	record RetPUVc RetPUr;	record ORVc ORr;	record TRVc TRr;	record FBVc FBr;	record ItemHistVc IHr;	record ItemStatusVc ISr;	record PPVc PPr;	record CUVc CUr;	record INVc INr;	Boolean TrHs;			TrHs = true;	while (LoopMain(CLInr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(CLInr);	    StepBack(CLInr);	  end;	end;	TrHs = true;	while (LoopMain(CLOutr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(CLOutr);	    StepBack(CLOutr);	  end;	end;	TrHs = true;	while (LoopMain(IPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IPr);	    StepBack(IPr);	  end;	end;	TrHs = true;	while (LoopMain(IVr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IVr);	    StepBack(IVr);	  end;	end;	TrHs = true;	while (LoopMain(VIr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(VIr);	    StepBack(VIr);	  end;	end;	TrHs = true;	while (LoopMain(POr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(POr);	    StepBack(POr);	  end;	end;	TrHs = true;	while (LoopMain(OPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(OPr);	    StepBack(OPr);	  end;	end;	TrHs = true;	while (LoopMain(SHr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(SHr);	    StepBack(SHr);	  end;	end;	TrHs = true;	while (LoopMain(PUr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(PUr);	    StepBack(PUr);	  end;	end;	TrHs = true;	while (LoopMain(SDr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(SDr);	    StepBack(SDr);	  end;	end;	TrHs = true;	while (LoopMain(StockMovr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(StockMovr);	    StepBack(StockMovr);	  end;	end;	TrHs = true;	while (LoopMain(Retr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(Retr);	    StepBack(Retr);	  end;	end;	TrHs = true;	while (LoopMain(RetPUr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(RetPUr);	    StepBack(RetPUr);	  end;	end;	TrHs = true;	while (LoopMain(ORr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(ORr);	    StepBack(ORr);	  end;	end;	TrHs = true;	while (LoopMain(TRr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(TRr);	    StepBack(TRr);	  end;	end;	TrHs = true;	while (LoopMain(FBr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(FBr);	    StepBack(FBr);	  end;	end;	TrHs = true;	while (LoopMain(IHr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(IHr);	    StepBack(IHr);	  end;	end;	TrHs = true;	while (LoopMain(ISr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(ISr);	    StepBack(ISr);	  end;	end;	TrHs = true;	while (LoopMain(PPr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(PPr);	    StepBack(PPr);	  end;	end;	TrHs = true;	while (LoopMain(CUr,1,TrHs)) begin	  if (TrHs and (CUr.VEType==0)) then begin	    RecordDelete(CUr);	    StepBack(CUr);	  end;	end;	TrHs = true;	while (LoopMain(INr,1,TrHs)) begin	  if (TrHs) then begin	    RecordDelete(INr);	    StepBack(INr);	  end;	end;return;end;global //Edit***************************Sasha2,16:10 29.01.2015 {updating procedure ReplaceUAHtoUAHRinWEBandRetailCUMn() begin  record CUVc CUr;  boolean testf;        CUr.Code = "";    while (LoopMain(CUr,1,true)) begin      testf = true;      if (CUr.CustCat!="RETAI" and CUr.CustCat!="WEB") then begin testf = false; end;      if (testf) then begin        CUr.CurncyCode = "UAH_R";        RECORDSTORE(CUr,true);      end;    end;  return;end; //Edit***************************Sasha2,16:11 29.01.2015 }global //Edit by Victor 30.01.15	***updating procedure PutQtysToPOMn() begin  record POVc POr;  record INVc INr;  row POVc POrw;  integer rwcnt, i;        POr.SerNr = "";    while (LoopMain(POr,1,true)) begin      rwcnt = MatRowCnt(POr);			for (i=0;i<rwcnt;i=i+1) begin				MatRowGet(POr,i,POrw);				if (nonblank(POrw.ArtCode)) then begin					INr.Code = POrw.ArtCode;					if(ReadfirstMain(INr, 1, true))then begin						POrw.QtyPack = INr.AddUnitCoef3;	   					POrw.QtyBox = INr.AddUnitCoef2;						end;									end;				MatRowPut(POr,i,POrw);			end;				    	RECORDSTORE(POr,true);          end;  return;end;	// ***global updating procedure RestoreLinksFromORtoSHandIVMn() //Edit***************************Sasha2,13:44 24.06.2014 {begin	record ORVc ORr;	record SHVc SHr;	record IVVc IVr;	string 255 rlink;	boolean TrHs;		while (loopmain(ORr,1,true)) begin	 IVr.OrderNr = ORr.SerNr;	 TrHs = true;	 while (LoopKey("OrderNr",IVr,1,TrHs)) begin  	 if (IVr.OrderNr!=ORr.SerNr) then begin TrHs=false; end;  	 if (TrHs) then begin  	    CreateRecordLink(ORr,CurrentCompany,IVr,CurrentCompany);        CreateRecordLink(IVr,CurrentCompany,ORr,CurrentCompany);  	 end;	 end; RESETLOOP(IVr);	 SHr.OrderNr = ORr.SerNr;	 TrHs = true;	 while (LoopKey("OrderKey",SHr,1,TrHs)) begin	   if (SHr.OrderNr!=ORr.SerNr) then begin TrHs=false; end;	   if (TrHs) then begin	     CreateRecordLink(ORr,CurrentCompany,SHr,CurrentCompany);       CreateRecordLink(SHr,CurrentCompany,ORr,CurrentCompany);	   end;	 end; RESETLOOP(SHr);	end;	return;end; //Edit***************************Sasha2,13:45 24.06.2014 }global 	//Edit----------------------Dima  11.02.2015updating procedure PutFlagsForCUWeb() begin  record CUVc CUr;    CUr.CustCat = "WEB";    while (LoopMain(CUr,1,true)) begin      if (CUr.CustCat=="WEB") then begin 					Cur.OnAccount = 1;							Cur.SelfBilling = 1;       		RECORDSTORE(CUr,true);      end;    end;  return;end;global 	//Edit***************************Sasha2,15:21 26.02.2015 {updating procedure CreateLoyaltyForWebClients() begin  record CUVc CUr;  record LoyaltyCardVc LoyaltyCardr;  record IVVc IVr;  Boolean TrHs,TrHs1,testf,testf1;  val sum;    CUr.CustCat = "WEB";    TrHs = true;    while (LoopKey("ActGroup",CUr,1,TrHs)) begin      testf = true;      if (CUr.CustCat!="WEB") then begin TrHs = false; testf = false; end;      if (testf) then begin        LoyaltyCardr.SerNr = CUr.Code;        if (!ReadFirstMain(LoyaltyCardr,1,true)) then begin          RECORDNEW(LoyaltyCardr);          LoyaltyCardr.SerNr = CUr.Code;          LoyaltyCardr.CustCode = CUr.Code;          LoyaltyCardr.CustName = CUr.Name;          LoyaltyCardr.LCMLevel = "1";          //LoyaltyCardr.PointsBalance = StringToVal(Cur.Comment1,M4Val);          IVr.CustCode = CUr.Code;          TrHs1 = true;          sum = 0;          while (LoopKey("CustCode",IVr,1,TrHs1)) begin            testf1 = true;            if (IVr.CustCode!=CUr.Code) then begin TrHs1 = false; testf1 = false; end;            if (IVr.OKFlag==0 or IVr.Invalid!=0) then begin testf1 = false; end;            if (testf1) then begin              if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin                sum = sum - IVr.Sum4;              end else begin                sum = sum + IVr.Sum4;              end;            end;          end; RESETLOOP(IVr);          RECORDSTORE(LoyaltyCardr,true);          LoyaltyCardr.PointsBalance = LoyaltyCardr.PointsBalance + sum;          RECORDSTORE(LoyaltyCardr,true);        end;      end;    end;  return;end; //Edit***************************Sasha2,15:21 26.02.2015 }global		updating procedure RecalculatePOVC_ActOkFlag_Mn()		//Edit----------------------Dima  12.03.2015	begin	record POVc POr;	row POVc POrw;	integer rwcnt,i;	longint totQuant,totShip;		totQuant=0;	totShip=0;		while (LoopMain(POr,1,true)) begin			RecalculateActOkFlag(POr);			RecordStore(POr,true);	end;return;end;global		updating procedure RecalculatePOVC_CustomStatusFlagText_Mn()		//Edit----------------------Dima  24.03.2015	begin	record ORVc ORr;		while (LoopMain(ORr,1,true)) begin			Recalculate_CustomStatusFlagText(ORr);			RecordStore(ORr,true);	end;return;end;globalupdating procedure ChangeCUCategoryMn(record RcVc RepSpec)		//Edit----------------------Dima  27.03.2015begin	record CUVc CUr;	boolean TrHs,testf;		CUr.CustCat = RepSpec.f1;	TrHs = true;	while (LoopMain(CUr,1,TrHs)) begin	//while (LoopKey("CustCat",CUr,2,TrHs)) begin		testf = true;		if (CUr.CustCat != RepSpec.f1) then begin				//TrHs = false;				testf= false;		end;		if (CUr.RebCode != RepSpec.f2)	 then begin					testf = false;		end;						if (testf) then begin			CUr.RebCode = RepSpec.f3;			RecordStore(CUr,true);		end;			end;		return;	end;globalupdating procedure FillCommentsInPricesMn(record RcVc RepSpec)		//Edit----------------------Dima  06.04.2015begin	record PLVc PLr;	record INVc INr;		boolean TrHs,testf;		PLr.Comment = "";	TrHs = true;	while (LoopKey("Comment",PLr,1,TrHs)) begin		if (nonblank(PLr.Comment)) then begin TrHs = false; end;						if (TrHs) then begin			INr.Code = PLr.ArtCode;			if (ReadFirstMain(INr,1,true)) then begin				PLr.Comment = INr.Name;				RecordStore(PLr,true);				StepBack(PLr);			end;		end;			end;		return;	end;global procedure ExportRegsMn(record RcVc RepSpec)		begin	record IPVc IPr;	record OPVc OPr;	record IVVc IVr;	record VIVc VIr;	record POVc POr;	record SHVc SHr;	record PUVc PUr;	record SDVc SDr;	record StockMovVc StockMovr;	record RetVc Retr;	record ORVc ORr;	record TRVc TRr;	record ItemHistVc IHr;	record ItemStatusVc ISr;	record CUVc CUr;	record INVc INr;   string 50 reg,filename;  area a;  		reg = RepSpec.f1;		switch(reg) begin		case "CUVc":				While(LoopMain(CUr,1,true)) begin					AddRecordToArea(CUr,"CUVc",a);				end;		case "INVc":				While(LoopMain(INr,1,true)) begin					AddRecordToArea(INr,"INVc",a);				end;		case "IVVc":				While(LoopMain(IVr,1,true)) begin					AddRecordToArea(IVr,"IVVc",a);				end;		case "IPVc":				While(LoopMain(IPr,1,true)) begin					AddRecordToArea(IPr,"IPVc",a);				end;		case "OPVc":				While(LoopMain(OPr,1,true)) begin					AddRecordToArea(OPr,"OPVc",a);				end;		case "VIVc":				While(LoopMain(VIr,1,true)) begin					AddRecordToArea(VIr,"VIVc",a);				end;		case "POVc":				While(LoopMain(POr,1,true)) begin					AddRecordToArea(POr,"POVc",a);				end;			case "PUVc":				While(LoopMain(PUr,1,true)) begin					AddRecordToArea(PUr,"PUVc",a);				end;		case "SDVc":				While(LoopMain(SDr,1,true)) begin					AddRecordToArea(SDr,"SDVc",a);				end;		case "StockMovVc":				While(LoopMain(StockMovr,1,true)) begin					AddRecordToArea(StockMovr,"StockMovVc",a);				end;		case "RetVc":				While(LoopMain(Retr,1,true)) begin					AddRecordToArea(Retr,"RetVc",a);				end;		case "ORVc":				While(LoopMain(ORr,1,true)) begin					AddRecordToArea(ORr,"ORVc",a);				end;		case "TRVc":				While(LoopMain(TRr,1,true)) begin					AddRecordToArea(TRr,"TRVc",a);				end;		case "ItemHistVc":				While(LoopMain(IHr,1,true)) begin					AddRecordToArea(IHr,"ItemHistVc",a);				end;			case "ItemStatusVc":				While(LoopMain(ISr,1,true)) begin					AddRecordToArea(ISr,"ItemStatusVc",a);				end;																																																									end;			filename = reg & ".txt";		WriteAreaToFile(a,filename,0);	return;	end;globalupdating procedure CutDigitCUMn(record RcVc RepSpec)		//Edit by Victor 25.05.15begin	record CUVc CUr;	record ORVc ORr;	record NPCityVc Cityr;	string 60 str;	string 255 city;	string 10 c;	boolean TrHs, testf;	Integer pos;  pos = 0;		CUr.Code = "";		while (LoopMain(CUr,1,true)) begin		str = CUr.InvAddr0;			if(nonblank(str))then begin			c = left(str, 1);			if(IsDigit(c)==true)then begin				CUr.InvAddr0 = right(str, len(str) - 1);				RecordStore(CUr, true);			end;		end else begin			ORr.CustCode = CUr.Code;			TrHs = true;			while(LoopBackKey("CustCode", ORr, 1, TrHs)) begin				testf = true;				if(ORr.CustCode != CUr.Code) then begin					testf = false;					TrHs = false;				end;				if(testf and TrHs)then begin					if(nonblank(ORr.NPCityRecipient)) then begin						CUr.InvAddr0 = ORr.NPCityRecipient;						RecordStore(CUr, true);						TrHs = false;					end else begin						str = ORr.ShipAddr2;						pos = 0;						city = "";						ExtractObj(str,pos,city);						if(nonblank(city)) then begin							Cityr.City = city;														if (ReadFirstMain(Cityr,1,true)) then begin								CUr.InvAddr0 = Cityr.City;								RecordStore(CUr, true);								TrHs = false;							end else begin								Cityr.CityRU = city;								if(ReadFirstKey("CityRU", Cityr, 1, true)) then begin									CUr.InvAddr0 = Cityr.City;									RecordStore(CUr, true);									TrHs = false;								end;							end;						end;										end;				end;			end;			resetloop(ORr);		end;				end;		return;	end;globalupdating procedure RecalculateFIFOforInvoiceMn(record RcVc RepSpec)		//Edit----------------------Dima  03.06.2015begin	record IVVc IVr;	row IVVc IVrw;	record ItemHistVc IHr;	boolean TrHs,testf;	integer i,rwcnt;	val cost;	While(LoopMain(IVr,1,true)) begin		testf = true;		if (IVr.UpdStockFlag==0) then begin testf=false; end;				if (testf) then begin			rwcnt =	MatRowCnt(IVr);			for(i=0;i<rwcnt;i=i+1) begin				MatRowGet(IVr,i,IVrw);				if(IVrw.Quant<0) then	begin					IHr.TransDate = IVr.TransDate;					IHr.ArtCode = IVrw.ArtCode;					IHr.FileName = "PUVc";					if (ReadLastKey("FNArtCode",IHr,2,false)) then begin												cost = IHr.TotCostPrice / IHr.Qty;							IVrw.FIFO = cost*(-IVrw.Quant);							IVrw.FIFORowVal = cost;							//LogText(0,IHr.ArtCode & ":  " & IHr.SerNr & "   " & cost);//Edit----------------------Dima  03.06.2015							MatRowPut(IVr,i,IVrw);							RecordStore(IVr,true);					end;				end;			end;		end;			end;return;	end;global updating procedure FixStockMovMn()begin	record StockMovVc SMr;	row StockMovVc SMrw;	record SDVc SDr;	row SDVc SDrw;		record ItemHistVc IHr;	integer i,mtrw;	boolean TrHs,testf,changed;	val outcost;		SMr.TransDate = stringtodate("1/1/2015");	while(loopkey("TransDate",SMr,1,true)) begin		changed = false;		mtrw = matrowcnt(SMr);		For(i=0;i<mtrw;i=i+1) begin	  	matrowget(SMr,i,SMrw);	  	if(SMrw.Quant>1)then begin	  		IHr.FileName = "StockMovVc";	  		IHr.TransNr = SMr.SerNr;	  		IHr.Row = i;	  		TrHs = true;	  		outcost = blankval;	  		while(loopkey("FNTransNr",IHr,3,TrHs)) begin	  			if(IHr.FileName!="StockMovVc" or IHr.TransNr!=SMr.SerNr or IHr.Row!=i)then begin TrHs = false; end;	  				  			if(TrHs)then begin	  				if(IHr.Qty<0)then begin	  					outcost = outcost + IHr.TotCostPrice;	  				end;	  			end;	  		end;	  			  		if(outcost!=SMrw.FIFORowVal)then begin	  			changed = true;	  			SMrw.FIFORowVal = outcost;	  			/*SMrw.SentOldPrice = SMrw.SentFIFORowVal/SMrw.Quant;      					SMrw.SentOldPrice = Round(SMrw.SentOldPrice,SetRoundModeD(5));					SMrw.SentNewPrice = SMrw.SentOldPrice;*/					SMrw.OldPrice = SMrw.FIFORowVal/SMrw.Quant;      					SMrw.OldPrice = Round(SMrw.OldPrice,SetRoundModeD(5));					SMrw.NewPrice = SMrw.OldPrice;					matrowput(SMr,i,SMrw);	  		end;	  		resetloop(IHr);	  	end;		end;		if(changed)then begin			recordStore(SMr,true);		end; 	end;				while(loopmain(SDr,1,true)) begin		changed = false;		mtrw = matrowcnt(SDr);		For(i=0;i<mtrw;i=i+1) begin	  	matrowget(SDr,i,SDrw);	  	if(SDrw.Qty>1)then begin	  		IHr.FileName = "SDVc";	  		IHr.TransNr = SDr.SerNr;	  		IHr.Row = i;	  		TrHs = true;	  		outcost = blankval;	  		while(loopkey("FNTransNr",IHr,3,TrHs)) begin	  			if(IHr.FileName!="SDVc" or IHr.TransNr!=SDr.SerNr or IHr.Row!=i)then begin TrHs = false; end;	  				  			if(TrHs)then begin	  				if(IHr.Qty<0)then begin	  					outcost = outcost + IHr.TotCostPrice;	  				end;	  			end;	  		end;	  			  		if(outcost!=SMrw.FIFORowVal)then begin	  			changed = true;	  			SDrw.FIFORowVal = outcost;					SDrw.FIFO = outcost/SDrw.Qty;					matrowput(SDr,i,SDrw);	  		end;	  		resetloop(IHr);	  	end;		end;		if(changed)then begin			recordStore(SDr,true);		end; 	end;	return;end;